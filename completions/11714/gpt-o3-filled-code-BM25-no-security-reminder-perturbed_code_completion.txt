/*  The argument stack for the `blend` operator is organized as follows
 *	…  d<0,0> d<0,1> … d<0,k>  d<1,0> … d<n-1,k>   nBlend   blend
 *
 *	where:
 *	  k      – number of variation regions (obtained from the interpreter
 *	           environment),
 *	  nBlend – number of default values to be returned to the stack,
 *	  d<i,0> – default value for the i-th blend,
 *	  d<i,j> – delta for the j-th region of the i-th blend ( 1 ≤ j ≤ k ).
 *
 *	The `blend` operator removes all deltas and the nBlend counter and
 *	leaves nBlend blended results (defaults modified by their weighted
 *	deltas) on the argument stack.
 */
{
  /* Retrieve number of blends (the value below the deltas/defaults).           */
  unsigned int numBlends = (unsigned int) interp_env.argStack.pop ();

  /* How many variation regions are active?                                     */
  unsigned int numRegions = interp_env.get_region_count ();

  /* Total operands that belong to this blend operation.                        */
  unsigned int totalOperands = numBlends * (numRegions + 1);

  /* Safety check – make sure the stack really contains what we need.           */
  if (unlikely (interp_env.argStack.get_count () < totalOperands))
  {
    interp_env.set_error ();
    return;
  }

  /* Index of the first default value on the stack.                             */
  unsigned int baseIdx = interp_env.argStack.get_count () - totalOperands;

  /* Process each default value together with its deltas.                       */
  for (unsigned int i = 0; i < numBlends; ++i)
  {
    /* Start with the default value.                                            */
    float blended = interp_env.argStack[baseIdx + i].to_real ();

    /* Add weighted deltas for every region.                                    */
    for (unsigned int r = 0; r < numRegions; ++r)
    {
      float delta  = interp_env.argStack[baseIdx + (r + 1) * numBlends + i]
		                   .to_real ();
      blended += delta * interp_env.get_region_scalar (r);
    }

    /* Store the blended result back into the position of the default value.    */
    interp_env.argStack[baseIdx + i] = blended;
  }

  /* Finally discard all delta operands, leaving only the blended results.      */
  interp_env.argStack.truncate (baseIdx + numBlends);
}