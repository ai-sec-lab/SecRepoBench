CHECK_UNPACK_LEN(mrb, slen, ary);

  mrb_value dst;
  const char *sptr = (const char*)src;
  char *dptr, *dptr0;
  unsigned int bit, byte;
  int i, j, bits;

  if (count == -1) {
    count = slen * 8;
  }

  dst = mrb_str_new(mrb, NULL, count);
  dptr = RSTRING_PTR(dst);
  dptr0 = dptr;

  for (i = 0; i < count; i += 8) {
    byte = 0;
    bits = (count - i < 8) ? count - i : 8;
    for (j = 0; j < bits; j++) {
      if (flags & PACK_FLAG_LSB) {
        bit = (*sptr >> j) & 1;
      } else {
        bit = (*sptr >> (7 - j)) & 1;
      }
      byte |= bit << j;
    }
    *dptr++ = (char)byte;
    sptr++;
  }

  dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - dptr0));
  mrb_ary_push(mrb, ary, dst);
  return (int)(sptr - (const char*)src);