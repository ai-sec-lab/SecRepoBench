CHECK_UNPACK_LEN(mrb, slen, ary);

mrb_value dst;
const unsigned char *sptr = (const unsigned char*)src;
char *dptr, *dptr0;
int i, byte;

if (count == -1)
  count = slen * 8;

dst = mrb_str_new(mrb, NULL, (count + 7) / 8);
dptr = RSTRING_PTR(dst);

dptr0 = dptr;
byte = 0;
for (i = 0; i < count; i++) {
  if (flags & PACK_FLAG_LSB) {
    if (i & 7) {
      byte >>= 1;
    }
    else {
      if (slen > 0) {
        byte = *sptr++;
        slen--;
      }
      else {
        byte = 0;
      }
    }
    *dptr++ = (byte & 1) ? '1' : '0';
  }
  else {
    if (i & 7) {
      byte <<= 1;
    }
    else {
      if (slen > 0) {
        byte = *sptr++;
        slen--;
      }
      else {
        byte = 0;
      }
    }
    *dptr++ = (byte & 128) ? '1' : '0';
  }
}

dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - dptr0));
mrb_ary_push(mrb, ary, dst);
return count;