if (slen < 0) {
    return -1;
  }
  const unsigned char *sptr = (const unsigned char*)src;
  int bitcount = (count == -1) ? slen * 8 : count;

  mrb_value dst = mrb_str_new(mrb, NULL, bitcount);
  char *dptr = RSTRING_PTR(dst);
  int i;

  for (i = 0; i < bitcount; i++) {
    int offset = (flags & PACK_FLAG_LSB) ? i : bitcount - 1 - i;
    unsigned char c = (sptr[offset / 8] >> (offset % 8)) & 1;
    *dptr++ = c + '0';
  }

  dst = mrb_str_resize(mrb, dst, bitcount);
  mrb_ary_push(mrb, ary, dst);
  return (bitcount + 7) / 8;