int i, bit_count = 0;
unsigned char *sptr = (unsigned char *)src;
unsigned char *dptr = (unsigned char *)RSTRING_PTR(ary);

for (i = 0; i < slen * 8; i++) {
    if (flags & PACK_FLAG_LSB) {
        *dptr++ = (*sptr >> (i & 7)) & 1 ? '1' : '0';
    } else {
        *dptr++ = (*sptr >> (7 - (i & 7))) & 1 ? '1' : '0';
    }
    if (++bit_count == count) {
        mrb_str_resize(mrb, ary, bit_count);
        return (int)((sptr - (unsigned char *)src) + (bit_count + 7) / 8);
    }
    if ((i & 7) == 7)
        sptr++;
}

mrb_str_resize(mrb, ary, bit_count);
return (int)((sptr - (unsigned char *)src) + (bit_count + 7) / 8);