const char *sptr = (const char *)src;
  int slen_bytes = slen;
  int bit_count = slen_bytes * 8;
  mrb_value dst;
  char *dptr;
  unsigned int byte = 0;
  int i = 0;

  if (count != -1) {
    bit_count = count;
  }

  dst = mrb_str_new(mrb, NULL, (bit_count + 7) / 8);
  dptr = RSTRING_PTR(dst);

  for (i = 0; i < bit_count; i++) {
    if (flags & PACK_FLAG_LSB) {
      if (sptr[i / 8] & (1 << (i % 8))) {
        byte |= (1 << (7 - (i % 8)));
      }
      if ((i + 1) % 8 == 0) {
        *dptr++ = (char)byte;
        byte = 0;
      }
    } else {
      if (sptr[i / 8] & (1 << (7 - (i % 8)))) {
        byte |= (1 << (i % 8));
      }
      if ((i + 1) % 8 == 0) {
        *dptr++ = (char)byte;
        byte = 0;
      }
    }
  }
  if (i % 8 != 0) {
    *dptr++ = (char)byte;
  }

  dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - RSTRING_PTR(dst)));
  mrb_ary_push(mrb, ary, dst);
  return slen_bytes;