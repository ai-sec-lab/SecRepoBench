const char *sptr = (const char*)src;
int bits = slen * 8;
mrb_value dst;
char *dptr, *dptr0;

if (count != -1 && count < bits)
  bits = count;

dst = mrb_str_new(mrb, NULL, bits + 1);
dptr = RSTRING_PTR(dst);

dptr0 = dptr;
for (int i = 0; i < bits; i++) {
  int byte = i / 8;
  int bit = i % 8;
  char c;

  if (flags & PACK_FLAG_LSB) {
    c = (sptr[byte] & (1 << bit)) ? '1' : '0';
  } else {
    c = (sptr[byte] & (1 << (7 - bit))) ? '1' : '0';
  }

  *dptr++ = c;
}

*dptr = '\0';
dst = mrb_str_resize(mrb, dst, bits);
mrb_ary_push(mrb, ary, dst);
return (bits + 7) / 8;