CHECK_UNPACK_LEN(mrb, slen, ary);

  mrb_value dst;
  const char *sptr = (const char *)src;
  char *dptr;
  int processed_bits = 0;
  unsigned int byte = 0;

  if (count == -1) {
    count = slen * 8; // Default to processing all bits
  }

  dst = mrb_str_new(mrb, NULL, count);
  dptr = RSTRING_PTR(dst);

  for (int i = 0; i < slen; i++) {
    for (int bit = 0; bit < 8; bit++) {
      if (processed_bits >= count) {
        break; // Stop if we've processed enough bits
      }

      // Determine the bit value based on the flag
      unsigned char bit_value = (flags & PACK_FLAG_LSB) ? 
                                ((*sptr >> bit) & 1) : 
                                ((*sptr >> (7 - bit)) & 1);

      // Append '0' or '1' to the destination string
      *dptr++ = bit_value ? '1' : '0';
      processed_bits++;
    }
    sptr++;
  }

  // Resize the destination string to the number of processed bits
  dst = mrb_str_resize(mrb, dst, processed_bits);
  mrb_ary_push(mrb, ary, dst);
  
  return slen; // Return the number of processed bytes