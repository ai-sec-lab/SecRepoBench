CHECK_UNPACK_LEN(mrb, slen, ary);

  const unsigned char *sptr = (const unsigned char*)src;
  mrb_value dst;
  char *dptr, *dptr0;
  int bits = slen * 8;
  int i;

  if (count > 0 && count < bits) {
    bits = count;
  }

  dst = mrb_str_new(mrb, NULL, bits);
  dptr = RSTRING_PTR(dst);

  dptr0 = dptr;
  for (i = 0; i < bits; i++) {
    unsigned char mask = (flags & PACK_FLAG_LSB) ? (1 << (i % 8)) : (128 >> (i % 8));
    if (sptr[i / 8] & mask) {
      *dptr++ = '1';
    } else {
      *dptr++ = '0';
    }
  }

  dst = mrb_str_resize(mrb, dst, bits);
  mrb_ary_push(mrb, ary, dst);
  return (bits + 7) / 8;