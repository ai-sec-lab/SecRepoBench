CHECK_UNPACK_LEN(mrbstate, slen, ary);

  mrb_value dst;
  const unsigned char *sptr, *sptr0;
  char *dptr, *dptr0;

  /* decide how many bits to unpack */
  if (count == -1) {
    count = slen * 8;          /* all bits in the string */
  }

  /* prepare destination string */
  dst   = mrb_str_new(mrbstate, NULL, count);
  dptr  = RSTRING_PTR(dst);
  dptr0 = dptr;

  sptr  = (const unsigned char *)src;
  sptr0 = sptr;

  while (slen > 0 && count > 0) {
    unsigned int byte = *sptr++;
    slen--;

    if (flags & PACK_FLAG_LSB) {           /* least-significant bit first */
      for (int i = 0; i < 8 && count > 0; i++) {
        *dptr++ = (byte & 1) ? '1' : '0';
        byte >>= 1;
        count--;
      }
    }
    else {                                /* most-significant bit first */
      for (int i = 0; i < 8 && count > 0; i++) {
        *dptr++ = (byte & 0x80) ? '1' : '0';
        byte <<= 1;
        count--;
      }
    }
  }