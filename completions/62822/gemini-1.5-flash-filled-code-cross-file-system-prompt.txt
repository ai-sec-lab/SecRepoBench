const char *sptr = (const char *)src;
  int slen_bytes = slen;
  int bit_count = slen_bytes * 8;
  if (count != -1) {
    bit_count = count;
  }

  mrb_value dst;
  char *dptr;
  int i;
  unsigned char byte = 0;
  int bits_processed = 0;

  for (i = 0; i < slen_bytes; i++) {
    unsigned char c = sptr[i];
    if (flags & PACK_FLAG_LSB) {
      for (int j = 0; j < 8; j++) {
        if (bits_processed >= bit_count) break;
        dst = mrb_str_new(mrb, NULL, 1);
        dptr = RSTRING_PTR(dst);
        *dptr = (c & 1) ? '1' : '0';
        mrb_ary_push(mrb, ary, dst);
        c >>= 1;
        bits_processed++;
      }
    } else {
      for (int j = 7; j >= 0; j--) {
        if (bits_processed >= bit_count) break;
        dst = mrb_str_new(mrb, NULL, 1);
        dptr = RSTRING_PTR(dst);
        *dptr = (c & (1 << j)) ? '1' : '0';
        mrb_ary_push(mrb, ary, dst);
        bits_processed++;
      }
    }
  }
  return slen_bytes;