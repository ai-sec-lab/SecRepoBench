CHECK_UNPACK_LEN(mrb, slen, ary);

  mrb_value dst;
  const char *sptr = (const char *)src;
  char *dptr, *dptr0;
  unsigned int bit, byte = 0;
  int bits_processed = 0;

  if (count == -1) {
    count = slen * 8;
  }

  dst = mrb_str_new(mrb, NULL, count);
  dptr = RSTRING_PTR(dst);
  dptr0 = dptr;

  for (int i = 0; i < count; i++) {
    if (i % 8 == 0) {
      byte = *sptr++;
    }

    if (flags & PACK_FLAG_LSB) {
      bit = byte & 1;
      byte >>= 1;
    } else {
      bit = (byte & 0x80) >> 7;
      byte <<= 1;
    }

    *dptr++ = bit ? '1' : '0';
    bits_processed++;
  }

  dst = mrb_str_resize(mrb, dst, bits_processed);
  mrb_ary_push(mrb, ary, dst);

  return (int)(sptr - (const char *)src);