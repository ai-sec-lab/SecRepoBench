if (slen == 0) return 0;

const unsigned char *sptr = (const unsigned char*)src;
const unsigned char *sptr0 = sptr;

mrb_value dst = mrb_str_new(mrbstate, NULL, count);

if (count == -1) {
  count = slen * 8;
}
else if (count > slen * 8) {
  count = slen * 8;
}

char *dptr = RSTRING_PTR(dst);
const char *dptr0 = dptr;
int bits = 0;

for (int i=0; i<count; i++) {
  if (flags & PACK_FLAG_LSB) {
    if (i & 7) bits >>= 1;
    else bits = *sptr++;
    *dptr++ = (bits & 1) ? '1' : '0';
  }
  else {
    if (i & 7) bits <<= 1;
    else bits = *sptr++;
    *dptr++ = (bits & 128) ? '1' : '0';
  }
}
dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));
mrb_ary_push(mrbstate, ary, dst);
return (int)(sptr - sptr0);