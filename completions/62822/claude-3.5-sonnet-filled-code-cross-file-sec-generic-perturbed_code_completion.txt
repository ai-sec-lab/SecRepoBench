const char *sptr = (const char*)src;
  int bits = slen * 8;
  char *dptr, *dptr0;
  mrb_value dst;

  if (count != -1 && count < bits)
    bits = count;

  dst = mrb_str_new(mrbstate, NULL, (bits + 7) / 8);
  dptr = RSTRING_PTR(dst);

  dptr0 = dptr;
  unsigned char byte = 0;
  int i = 0;

  while (bits--) {
    if (flags & PACK_FLAG_LSB) {
      byte |= (*sptr & (1 << (i & 7))) ? 1 : 0;
      if (i & 7) byte >>= 1;
    } else {
      byte = (byte << 1) | ((*sptr & (1 << (7 - (i & 7)))) ? 1 : 0);
    }

    if ((i & 7) == 7) {
      *dptr++ = byte;
      byte = 0;
    }

    if ((++i & 7) == 0) sptr++;
  }

  if (i & 7) {
    if (flags & PACK_FLAG_LSB)
      byte >>= 7 - (i & 7);
    else
      byte <<= 7 - (i & 7);
    *dptr++ = byte;
  }

  dst = mrb_str_resize(mrbstate, dst, dptr - dptr0);
  mrb_ary_push(mrbstate, ary, dst);
  return (slen * 8 + 7) / 8;