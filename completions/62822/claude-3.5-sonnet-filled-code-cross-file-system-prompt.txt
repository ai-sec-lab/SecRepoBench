const unsigned char *sptr = (const unsigned char*)src;
int bits = slen * 8;
mrb_value dst;
char *dptr, *dptr0;

if (count != -1 && count < bits) {
  bits = count;
}

dst = mrb_str_new(mrb, NULL, bits);
dptr = RSTRING_PTR(dst);
dptr0 = dptr;

unsigned int byte = 0;
int i = 0;

while (bits--) {
  if (flags & PACK_FLAG_LSB) {
    byte = (*sptr & (1 << (i & 7))) ? '1' : '0';
  } else {
    byte = (*sptr & (1 << (7 - (i & 7)))) ? '1' : '0';
  }
  *dptr++ = byte;
  if ((++i & 7) == 0) sptr++;
}

dst = mrb_str_resize(mrb, dst, dptr - dptr0);
mrb_ary_push(mrb, ary, dst);
return (i + 7) / 8;