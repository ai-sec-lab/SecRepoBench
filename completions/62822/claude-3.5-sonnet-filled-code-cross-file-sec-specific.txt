const unsigned char *sptr = (const unsigned char*)src;
int a, b;
unsigned int ashift, bshift;
mrb_value dst;
char *dptr, *dptr0;

CHECK_UNPACK_LEN(mrb, slen, ary);

if (flags & PACK_FLAG_LSB) {
  ashift = 0;
  bshift = 1;
}
else {
  ashift = 7;
  bshift = -1;
}

if (count == -1)
  count = slen * 8;

dst = mrb_str_new(mrb, NULL, count);
dptr = RSTRING_PTR(dst);

dptr0 = dptr;
for (a = 0; count > 0; count--) {
  if (a == 0) {
    if (slen-- == 0)
      break;
    a = 8;
    b = *sptr++;
  }
  *dptr++ = (b >> ashift) & 1 ? '1' : '0';
  b <<= bshift;
  a--;
}

dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - dptr0));
mrb_ary_push(mrb, ary, dst);
return (int)((char*)sptr - (char*)src);