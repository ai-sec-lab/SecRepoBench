if (slen < 0) {
    mrb_raise(mrb, E_ARGUMENT_ERROR, "negative string length");
  }

  if (count == -1) {
    count = slen * 8;
  }
  else if (count > slen * 8) {
    mrb_raisef(mrb, E_ARGUMENT_ERROR, "Expected at most %i bits but got %i bits", slen * 8, count);
  }

  const unsigned char *sptr = (const unsigned char *)src;
  mrb_value dst = mrb_str_new(mrb, NULL, count);
  char *dptr = RSTRING_PTR(dst);

  int bit_count = 0;
  for (int i = 0; i < slen && bit_count < count; ++i) {
    unsigned char byte = sptr[i];
    for (int j = 0; j < 8 && bit_count < count; ++j) {
      if (flags & PACK_FLAG_LSB) {
        *dptr++ = (byte & 1) ? '1' : '0';
        byte >>= 1;
      } else {
        *dptr++ = (byte & 0x80) ? '1' : '0';
        byte <<= 1;
      }
      bit_count++;
    }
  }

  dst = mrb_str_resize(mrb, dst, bit_count);
  mrb_ary_push(mrb, ary, dst);
  return (bit_count + 7) / 8;