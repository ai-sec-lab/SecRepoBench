CHECK_UNPACK_LEN(mrbstate, slen, ary);

const unsigned char *sptr = (const unsigned char*)src;
mrb_value dst;
int i, byte = 0;
char *dptr, *dptr0;

if (count == -1) {
  count = slen * 8;
}

dst = mrb_str_new(mrbstate, NULL, count);
dptr = RSTRING_PTR(dst);

dptr0 = dptr;
for (i = 0; i < count; i++) {
  if (i % 8 == 0) {
    if (slen == 0) break;
    byte = *sptr++;
    slen--;
  }
  
  if (flags & PACK_FLAG_LSB) {
    *dptr++ = (byte & 1) ? '1' : '0';
    byte >>= 1;
  } else {
    *dptr++ = (byte & 128) ? '1' : '0';
    byte <<= 1;
  }
}

dst = mrb_str_resize(mrbstate, dst, (mrb_int)(dptr - dptr0));
mrb_ary_push(mrbstate, ary, dst);
return (int)(sptr - (const unsigned char*)src);