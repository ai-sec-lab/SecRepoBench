CHECK_UNPACK_LEN(mrb, slen, ary);

  mrb_value dst;
  const char *sptr = (const char*)src;
  char *dptr;
  int bit_count = slen * 8;
  int processed_bits = 0;

  while (processed_bits < bit_count && count > 0) {
    dst = mrb_str_new(mrb, NULL, 1);
    dptr = RSTRING_PTR(dst);
    unsigned char byte = 0;

    for (int i = 0; i < 8 && processed_bits < bit_count; i++, processed_bits++) {
      if (flags & PACK_FLAG_LSB) {
        byte |= ((*sptr >> (processed_bits % 8)) & 1) << i;
      } else {
        byte |= ((*sptr >> (7 - (processed_bits % 8))) & 1) << (7 - i);
      }
    }

    *dptr = byte;
    mrb_ary_push(mrb, ary, dst);
    count--;
    sptr += (processed_bits % 8 == 0) ? 1 : 0; // Move to next byte if we finished processing a byte
  }

  return (int)(sptr - (const char*)src);