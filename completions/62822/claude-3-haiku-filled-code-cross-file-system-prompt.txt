int i, bit_count = 0;
const unsigned char *sptr = (const unsigned char *)src;
char *dptr = RSTRING_PTR(ary);

if (flags & PACK_FLAG_LSB) {
  for (i = 0; i < slen * 8 && bit_count < count; i++) {
    if (*sptr & (1 << (i % 8))) {
      *dptr++ = '1';
    } else {
      *dptr++ = '0';
    }
    if ((i + 1) % 8 == 0) {
      sptr++;
    }
    bit_count++;
  }
} else {
  for (i = slen * 8 - 1; i >= 0 && bit_count < count; i--) {
    if (*sptr & (1 << (i % 8))) {
      *dptr++ = '1';
    } else {
      *dptr++ = '0';
    }
    if (i % 8 == 0) {
      sptr++;
    }
    bit_count++;
  }
}

mrb_str_resize(mrb, ary, bit_count);
return (int)(sptr - (const unsigned char *)src);