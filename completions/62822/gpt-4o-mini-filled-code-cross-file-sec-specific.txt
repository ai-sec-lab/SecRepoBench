const char *sptr = (const char *)src;
  int slen = (int)slen;

  if (count == -1) {
    count = slen * 8; // Process all bits
  } else if (slen * 8 < count) {
    count = slen * 8; // Adjust count if it exceeds available bits
  }

  mrb_value dst;
  dst = mrb_str_new(mrb, NULL, count);
  char *dptr = RSTRING_PTR(dst);
  char *dptr0 = dptr;

  unsigned int bit_counter = 0;
  unsigned int byte = 0;

  for (int i = 0; i < slen; i++) {
    for (int j = 0; j < 8; j++) {
      if (bit_counter >= count) {
        break; // Prevent writing beyond the allocated buffer
      }
      byte = (sptr[i] >> (7 - j)) & 1; // Extract bit
      *dptr++ = byte ? '1' : '0'; // Append '0' or '1'
      bit_counter++;
    }
  }

  dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - dptr0)); // Resize to actual length
  mrb_ary_push(mrb, ary, dst); // Push result to array
  return (int)(dptr - dptr0); // Return number of processed bits