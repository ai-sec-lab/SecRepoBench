int
unpack_bstr(mrb_state *mrb, const void *src, int slen, mrb_value ary, int count, unsigned int flags)
{
  const char *sptr = (const char *)src;
  char *dptr;
  int i, bit_count = 0;

  if (slen == 0) {
    return 0;
  }

  for (i = 0; i < count; i++) {
    mrb_value str = mrb_str_new(mrb, NULL, slen * 8);
    dptr = RSTRING_PTR(str);

    for (int j = 0; j < slen * 8; j++) {
      if (flags & PACK_FLAG_LSB) {
        *dptr++ = (*sptr >> (j & 7)) & 1 ? '1' : '0';
      } else {
        *dptr++ = (*sptr >> (7 - (j & 7))) & 1 ? '1' : '0';
      }
      bit_count++;
      if ((j & 7) == 7) {
        sptr++;
      }
    }

    mrb_str_resize(mrb, str, bit_count);
    mrb_ary_push(mrb, ary, str);
    bit_count = 0;
  }

  return slen;
}