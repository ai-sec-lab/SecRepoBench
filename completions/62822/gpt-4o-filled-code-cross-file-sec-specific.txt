CHECK_UNPACK_LEN(mrb, slen, ary);

  mrb_value dst;
  const char *sptr = (const char *)src;
  char *dptr;
  int bit_count = slen * 8;
  int processed_bits = 0;
  unsigned int byte = 0;
  int bit_index = 0;

  if (count == -1) {
    count = bit_count;
  }

  dst = mrb_str_new(mrb, NULL, count);
  dptr = RSTRING_PTR(dst);

  while (processed_bits < count && processed_bits < bit_count) {
    if (flags & PACK_FLAG_LSB) {
      byte |= ((*sptr >> bit_index) & 1) << (processed_bits % 8);
    } else {
      byte |= ((*sptr >> (7 - bit_index)) & 1) << (7 - (processed_bits % 8));
    }

    bit_index++;
    processed_bits++;

    if (bit_index == 8) {
      sptr++;
      bit_index = 0;
    }

    if (processed_bits % 8 == 0 || processed_bits == count) {
      *dptr++ = (char)byte;
      byte = 0;
    }
  }

  dst = mrb_str_resize(mrb, dst, (mrb_int)(dptr - RSTRING_PTR(dst)));
  mrb_ary_push(mrb, ary, dst);

  return (int)((sptr - (const char *)src) + (bit_index ? 1 : 0));