if (slen <= 0) {
  return 0;
}

unsigned int bit_counter = 0;
const unsigned char *src_ptr = (const unsigned char *)src;
mrb_value str = mrb_str_new(mrb, NULL, slen * 8);
char *dst_ptr = RSTRING_PTR(str);

for (int i = 0; i < slen * 8; i++) {
  unsigned int bit = (*src_ptr >> (flags & PACK_FLAG_LSB ? bit_counter : 7 - bit_counter)) & 1;
  *dst_ptr++ = bit + '0';

  if (++bit_counter == 8) {
    bit_counter = 0;
    src_ptr++;
  }
}

mrb_ary_push(mrb, ary, str);
return slen;