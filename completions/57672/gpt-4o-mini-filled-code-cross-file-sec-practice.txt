{
    // Check if the allocation was successful
    if (p == NULL) {
      // Handle memory allocation failure
      if (!noraise) {
        mrb_exc_raise(mrb, mrb_obj_value(mrb->nomem_err));
      }
      return FALSE;
    }

    // Copy the existing stack contents to the new stack
    memcpy(p, e->stack, sizeof(mrb_value) * len);
    
    // Assign the new stack to the environment
    e->stack = p;

    // Mark the environment as closed
    MRB_ENV_CLOSE(e);
    
    // Reset the length and binding index
    MRB_ENV_SET_LEN(e, len);
    MRB_ENV_SET_BIDX(e, 0);
    
    return TRUE;
  }