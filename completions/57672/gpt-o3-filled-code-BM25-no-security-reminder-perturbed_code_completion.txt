else if (p) {
    /* copy stack contents from the onâ€“stack env to the newly allocated heap area */
    size_t i;
    for (i = 0; i < len; ++i) {
      p[i] = e->stack[i];
    }

    /* replace the stack pointer and mark the env as closed (off-stack) */
    e->stack = p;
    MRB_ENV_CLOSE(e);

    return TRUE;
  }
  else {                       /* p == NULL  ->  allocation failed */
    if (noraise) {
      return FALSE;
    }
    /* raise NoMemoryError */
    mrb_exc_raise(mrb_state, mrb_obj_value(mrb_state->nomem_err));
    return FALSE;              /* not reached */
  }