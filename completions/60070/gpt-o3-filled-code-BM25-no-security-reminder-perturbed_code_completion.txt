/* Sanity-check the supplied method. If it does not look valid, flag the
   * flow as risky and clear any previously stored value.                */
  if((method == NULL) || (methodlen == 0) ||
     (thrift_validate_method(method, methodlen) == 0))
  {
    /* Generic protocol violation */
#ifdef NDPI_RISK_PROTOCOL_VIOLATION
    NDPI_ADD_RISK(ndpi_struct, flow, NDPI_RISK_PROTOCOL_VIOLATION);
#endif
    flow->thrift_method = NULL;
    return;
  }

  /* Truncate the method if it does not fit into the pre-allocated buffer. */
  if(methodlen >= sizeof(flow->candidate_thrift_method))
    methodlen = sizeof(flow->candidate_thrift_method) - 1;

  /* Store the validated method inside the flow structure. */
  memcpy(flow->candidate_thrift_method, method, methodlen);
  flow->candidate_thrift_method[methodlen] = '\0';
  flow->thrift_method = &flow->candidate_thrift_method[0];