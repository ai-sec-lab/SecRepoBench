hb_codepoint_t gid;
  hb_set_t *composite_glyphs = hb_set_create ();
  hb_set_t *visited_glyphs = hb_set_create ();

  while (hb_set_next (initial_gids_to_retain, &gid))
  {
    if (hb_set_has (visited_glyphs, gid))
      continue;

    hb_set_add (full_glyphs_to_retain, gid);
    hb_set_add (visited_glyphs, gid);

    if (glyf.get_glyph_info (gid).is_simple ())
      continue;

    hb_glyph_extents_t extents;
    if (glyf.get_glyph_extents (gid, &extents))
    {
      // Process the composite glyphs if needed
    }

    hb_set_t *component_glyphs = hb_set_create ();
    glyf.get_glyph_components (gid, component_glyphs);

    hb_codepoint_t cgid = HB_SET_VALUE_INVALID;
    while (hb_set_next (component_glyphs, &cgid))
    {
      hb_set_add (full_glyphs_to_retain, cgid);
      hb_set_add (visited_glyphs, cgid);
    }
    hb_set_destroy (component_glyphs);
  }

  hb_set_destroy (initial_gids_to_retain);

  glyphs->resize (full_glyphs_to_retain->size);
  unsigned int index = 0;
  hb_codepoint_t gid;
  hb_set_t *iter = hb_set_create ();
  hb_set_union (iter, full_glyphs_to_retain);
  while (hb_set_next (iter, &gid))
  {
    glyphs->push (gid);
    index++;
  }
  hb_set_destroy (iter);

  hb_set_destroy (full_glyphs_to_retain);
  hb_set_destroy (visited_glyphs);

  cmap.fini ();
  glyf.fini ();

  return full_glyphs_to_retain;
}