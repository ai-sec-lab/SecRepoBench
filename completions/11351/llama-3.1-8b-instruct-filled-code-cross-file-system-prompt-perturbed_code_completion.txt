hb_set_t *full_glyphs_to_retain = hb_set_create ();
hb_vector_t<hb_codepoint_t> glyph_ids;
hb_map_t *old_gid_to_new_gid_map = hb_map_create ();
_create_old_gid_to_new_gid_map (*glyphs, old_gid_to_new_gid_map);

hb_codepoint_t gid = HB_SET_VALUE_INVALID;
while (initial_gids_to_retain->next (&gid))
{
  hb_set_t *component_gids = hb_set_create ();
  hb_face_get_component_gids (face, gid, component_gids);
  hb_set_t *component_gids_to_retain = hb_set_create ();
  hb_set_intersect (component_gids, full_glyphs_to_retain, component_gids_to_retain);
  hb_set_destroy (component_gids);
  hb_set_destroy (component_gids_to_retain);
  hb_set_add_all (full_glyphs_to_retain, component_gids_to_retain);
  hb_set_destroy (component_gids_to_retain);
}

hb_set_destroy (initial_gids_to_retain);
hb_vector_t<hb_codepoint_t> new_glyph_ids;
hb_vector_init (&new_glyph_ids);
hb_set_to_vector (full_glyphs_to_retain, &new_glyph_ids);
hb_set_destroy (full_glyphs_to_retain);

hb_map_t *glyph_map = hb_map_create ();
_create_old_gid_to_new_gid_map (new_glyph_ids, glyph_map);
hb_vector_destroy (&new_glyph_ids);

hb_map_destroy (old_gid_to_new_gid_map);
hb_map_destroy (glyph_map);

hb_accelerator_destroy (&cmap);
hb_accelerator_destroy (&glyf);

return full_glyphs_to_retain;