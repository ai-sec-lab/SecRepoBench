hb_codepoint_t gid;
  hb_set_t *glyphs_to_retain = hb_set_create ();
  hb_set_union (glyphs_to_retain, initial_gids_to_retain);

  hb_set_t *composite_glyphs = hb_set_create ();
  hb_codepoint_t glyph_cp = HB_SET_VALUE_INVALID;
  while (hb_set_next (initial_gids_to_retain, &glyph_cp))
  {
    if (glyf.get_glyph_info (glyph_cp, nullptr, nullptr, nullptr, nullptr, nullptr, nullptr, &gid))
    {
      if (glyf.is_composite (glyph_cp))
      {
        hb_set_add (composite_glyphs, glyph_cp);
        hb_set_add (glyphs_to_retain, glyph_cp);
      }
    }
  }

  hb_set_t *composite_components = hb_set_create ();
  while (hb_set_next (composite_glyphs, &glyph_cp))
  {
    if (glyf.get_composite_glyph_components (glyph_cp, composite_components))
    {
      hb_codepoint_t component_cp = HB_SET_VALUE_INVALID;
      while (hb_set_next (composite_components, &component_cp))
      {
        if (!hb_set_has (glyphs_to_retain, component_cp))
        {
          hb_set_add (glyphs_to_retain, component_cp);
        }
      }
    }
  }

  hb_set_destroy (composite_components);
  hb_set_destroy (composite_glyphs);
  hb_set_destroy (initial_gids_to_retain);

  glyphs->resize (glyphs_to_retain->size);
  unsigned int index = 0;
  hb_codepoint_t glyph_id = HB_SET_VALUE_INVALID;
  while (hb_set_next (glyphs_to_retain, &glyph_id))
  {
    glyphs->at (index++) = glyph_id;
  }

  hb_set_destroy (glyphs_to_retain);

  glyf.fini ();
  cmap.fini ();

  return glyphs_to_retain;
}