if (avctx->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
            if (avctx->sub_charenc_mode != AV_SUB_CHARENC_MODE_DO_NOTHING) {
                av_log(avctx, AV_LOG_WARNING,
                       "Codec '%s' is bitmap-based, ignoring character encoding setting.\n",
                       avctx->codec_descriptor->name);
                avctx->sub_charenc_mode = AV_SUB_CHARENC_MODE_DO_NOTHING;
            }
        } else if (avctx->sub_charenc_mode == AV_SUB_CHARENC_MODE_AUTOMATIC) {
            avctx->sub_charenc_mode = AV_SUB_CHARENC_MODE_PRE_DECODER;
        }

        if (avctx->sub_charenc && avctx->sub_charenc_mode == AV_SUB_CHARENC_MODE_PRE_DECODER) {
#if CONFIG_ICONV
            if (avctx->sub_charenc[0] == '\0') {
                av_log(avctx, AV_LOG_ERROR, "Character encoding not set.\n");
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }

            if (!strcmp(avctx->sub_charenc, "UTF-8") ||
                !strcmp(avctx->sub_charenc, "utf-8") ||
                !strcmp(avctx->sub_charenc, "utf8")) {
                // No conversion is needed for UTF-8.
            } else {
                iconv_t cd = iconv_open("UTF-8", avctx->sub_charenc);
                if (cd == (iconv_t)-1) {
                    av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context with input character encoding \"%s\".\n", avctx->sub_charenc);
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                iconv_close(cd);
            }
#else
            av_log(avctx, AV_LOG_WARNING, "Character encoding set, but libiconv is unavailable. The subtitles might not display correctly.\n");
#endif
        }