if (avctx->channels && avctx->channels < 0 ||
    avctx->channels > FF_SANE_NB_CHANNELS) {
    ret = AVERROR(EINVAL);
    goto free_and_end;
}

if (avctx->codec->capabilities & AV_CODEC_CAP_CHANNEL_CONF) {
    if (avctx->channel_layout && avctx->channels) {
        int channels = av_get_channel_layout_nb_channels(avctx->channel_layout);
        if (channels != avctx->channels) {
            char buf[512];
            av_get_channel_layout_string(buf, sizeof(buf), -1, avctx->channel_layout);
            av_log(avctx, AV_LOG_ERROR,
                   "Channel layout '%s' with %d channels does not match number of specified channels %d\n",
                   buf, channels, avctx->channels);
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
    } else if (avctx->channel_layout) {
        avctx->channels = av_get_channel_layout_nb_channels(avctx->channel_layout);
    } else if (avctx->channels) {
        avctx->channel_layout = av_get_default_channel_layout(avctx->channels);
    }
}

if (avctx->codec_type == AVMEDIA_TYPE_VIDEO) {
    if (avctx->width <= 0 || avctx->height <= 0) {
        av_log(avctx, AV_LOG_ERROR, "dimensions not set\n");
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }
}

if (avctx->codec_type == AVMEDIA_TYPE_AUDIO) {
    if (avctx->sample_rate <= 0) {
        av_log(avctx, AV_LOG_ERROR, "sample_rate not set\n");
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }
}