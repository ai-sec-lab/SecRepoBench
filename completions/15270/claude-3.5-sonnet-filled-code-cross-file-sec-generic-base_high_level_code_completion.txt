if (avctx->subtitle_header) {
    if (avctx->codec_type != AVMEDIA_TYPE_SUBTITLE) {
        av_log(avctx, AV_LOG_ERROR, "Subtitle header present for non subtitle codec\n");
        ret = AVERROR(EINVAL);
        goto free_and_end;
    }

    if (avctx->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
        av_log(avctx, AV_LOG_WARNING, "Ignoring subtitle_header for bitmap subtitle\n");
    } else {
        if (avctx->codec_descriptor->props & AV_CODEC_PROP_TEXT_SUB) {
            if (avctx->sub_charenc_mode != FF_SUB_CHARENC_MODE_IGNORE) {
                avctx->sub_charenc_mode = av_clip(avctx->sub_charenc_mode, FF_SUB_CHARENC_MODE_AUTOMATIC, FF_SUB_CHARENC_MODE_PRE_DECODER);

                if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
#if CONFIG_ICONV
                    iconv_t cd = iconv_open("UTF-8", avctx->sub_charenc);
                    if (cd == (iconv_t)-1) {
                        av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context "
                               "with input character encoding \"%s\"\n", avctx->sub_charenc);
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                    iconv_close(cd);
#else
                    av_log(avctx, AV_LOG_ERROR, "Character encoding conversion "
                           "not available. You need to build with iconv support "
                           "to use sub_charenc_mode with pre-decoder conversion.\n");
                    ret = AVERROR(ENOSYS);
                    goto free_and_end;
#endif
                }
            }
        } else {
            av_log(avctx, AV_LOG_WARNING, "Ignoring subtitle_header for unknown subtitle type\n");
        }
    }
}