if (avctx->subtitle_header) {
            // Check if the subtitle header is valid
            if (avctx->subtitle_header->encoding == AV_SUBTITLE_ENCODING_AUTO) {
                // Set character encoding to pre-decoder if in automatic mode
                avctx->subtitle_header->encoding = AV_SUBTITLE_ENCODING_PRE_DECODER;
            } else if (avctx->subtitle_header->encoding == AV_SUBTITLE_ENCODING_BITMAP) {
                // For bitmap-based subtitles, ignore character encoding with a warning
                av_log(avctx, AV_LOG_WARNING, "Character encoding ignored for bitmap-based subtitles.\n");
            } else {
                // Validate the input encoding using iconv if available
                #ifdef HAVE_ICONV
                // Assuming iconv_open and iconv functions are available
                iconv_t cd = iconv_open("UTF-8", avctx->subtitle_header->encoding_name);
                if (cd == (iconv_t)(-1)) {
                    av_log(avctx, AV_LOG_ERROR, "Invalid character encoding: %s\n", avctx->subtitle_header->encoding_name);
                    ret = AVERROR(EINVAL);
                    goto free_and_end;
                }
                iconv_close(cd);
                #endif
            }
        } else {
            av_log(avctx, AV_LOG_WARNING, "No subtitle header set, character encoding cannot be validated.\n");
        }