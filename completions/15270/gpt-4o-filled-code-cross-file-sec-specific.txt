if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
            if (avctx->sub_charenc) {
                if (avctx->codec->caps_internal & FF_CODEC_CAP_BITMAP_SUB) {
                    av_log(avctx, AV_LOG_WARNING, "Character encoding %s specified for bitmap-based subtitle codec, ignoring\n", avctx->sub_charenc);
                } else {
                    if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC) {
                        avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
                    }
                    if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
                        if (!avctx->sub_charenc_from_bom) {
                            ret = avcodec_open2_subtitle_charenc(avctx, avctx->sub_charenc);
                            if (ret < 0) {
                                av_log(avctx, AV_LOG_ERROR, "Unable to open character encoding %s\n", avctx->sub_charenc);
                                goto free_and_end;
                            }
                        }
                    }
                }
            }
        }