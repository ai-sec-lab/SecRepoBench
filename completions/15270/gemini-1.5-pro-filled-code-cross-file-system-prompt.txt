if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
            if (avctx->subtitle_header) {
                av_freep(&avctx->subtitle_header);
                avctx->subtitle_header_size = 0;
            }
            if (avctx->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
                if (avctx->sub_charenc_mode != FF_SUB_CHARENC_MODE_DO_NOTHING) {
                    av_log(avctx, AV_LOG_WARNING, "Codec '%s' is bitmap-based, ignoring character encoding setting.\n", avctx->codec_descriptor->name);
                    avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_DO_NOTHING;
                }
            } else if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC) {
                avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
            }
#if CONFIG_ICONV
            if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
                if (avctx->sub_charenc) {
                    if(avcodec_check_sub_charenc(avctx, avctx->sub_charenc) < 0) {
                        ret = AVERROR(EINVAL);
                        goto free_and_end;
                    }
                } else {
                    av_log(avctx, AV_LOG_WARNING, "No character encoding provided, assuming default.\n");
                }
            }
#endif
        } else if (avctx->sub_charenc || avctx->sub_charenc_mode != FF_SUB_CHARENC_MODE_DO_NOTHING) {
            av_log(avctx, AV_LOG_WARNING, "Character encoding is only supported with subtitle codecs.\n");
            avctx->sub_charenc = NULL;
            avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_DO_NOTHING;
        }