if (avctx->codec_type == AVMEDIA_TYPE_VIDEO) {
    if (!avctx->time_base.num)
        avctx->time_base = av_inv_q(avctx->framerate);
    if (!avctx->width || !avctx->height)
        return AVERROR(EINVAL);
    if (av_image_check_size(avctx->width, avctx->height, 0, avctx) < 0)
        return AVERROR(EINVAL);
}

if (avctx->codec_type == AVMEDIA_TYPE_AUDIO) {
    if (!avctx->time_base.num) {
        if (avctx->sample_rate) {
            avctx->time_base = (AVRational){1, avctx->sample_rate};
        } else {
            av_log(avctx, AV_LOG_ERROR, "Neither sample rate nor time base set\n");
            return AVERROR(EINVAL);
        }
    }
    if (!avctx->channels)
        return AVERROR(EINVAL);
}

if (avctx->codec_id == AV_CODEC_ID_RAWVIDEO && !avctx->codec_tag) {
    uint32_t tag = avcodec_pix_fmt_to_codec_tag(avctx->pix_fmt);
    if (avpriv_find_pix_fmt(tag) == avctx->pix_fmt)
        avctx->codec_tag = tag;
}

if (avctx->codec->init_thread_copy)
    avctx->internal->thread_ctx = av_mallocz(sizeof(*(avctx->internal->thread_ctx)));

if (avctx->debug & FF_DEBUG_PICT_INFO)
    av_log(avctx, AV_LOG_DEBUG, "Format %s, Codec %s, ColorSpace %s, Dimensions %dx%d\n",
           av_get_pix_fmt_name(avctx->pix_fmt),
           avcodec_get_name(avctx->codec_id),
           av_get_colorspace_name(avctx->colorspace),
           avctx->width, avctx->height);