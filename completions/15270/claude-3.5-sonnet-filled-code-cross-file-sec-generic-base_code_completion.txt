if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (avctx->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
        if (avctx->sub_charenc) {
            av_log(avctx, AV_LOG_WARNING, "Codec is bitmap-based, ignoring character encoding\n");
        }
    } else {
        if (!avctx->sub_charenc) {
            avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
#if CONFIG_ICONV
            const char *charset = av_mallocz(16);
            if (!charset) {
                ret = AVERROR(ENOMEM);
                goto free_and_end;
            }
            snprintf((char *)charset, 16, "CP%d", avctx->sub_charenc_mode);
            if (iconv_open("UTF-8", charset) == (iconv_t)-1) {
                av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context for character encoding '%s'\n", charset);
                av_free((void *)charset);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            av_free((void *)charset);
#else
            av_log(avctx, AV_LOG_WARNING, "Character encoding is not supported without iconv\n");
#endif
        } else {
#if CONFIG_ICONV
            if (iconv_open("UTF-8", avctx->sub_charenc) == (iconv_t)-1) {
                av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context for character encoding '%s'\n", avctx->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
#else
            av_log(avctx, AV_LOG_WARNING, "Character encoding is not supported without iconv\n");
#endif
        }
    }
}