if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (avctx->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
        if (avctx->sub_charenc) {
            av_log(avctx, AV_LOG_WARNING, "Ignoring character encoding for bitmap-based subtitle codec\n");
        }
    } else {
        if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTO) {
            avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
        }

        if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
#if CONFIG_ICONV
            iconv_t cd = iconv_open("UTF-8", avctx->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context "
                       "with input character encoding \"%s\"\n", avctx->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
#else
            av_log(avctx, AV_LOG_WARNING, "Character encoding is not supported "
                   "without iconv. Conversions may fail.\n");
#endif
        }
    }
}