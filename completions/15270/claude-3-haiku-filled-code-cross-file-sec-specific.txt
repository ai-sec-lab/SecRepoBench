// Check if subtitle character encoding is set and handle accordingly.
// Ensure that character encoding is only used with subtitle codecs.
// If the codec is bitmap-based, character encoding is ignored with a warning.
// For text-based subtitle codecs, set the character encoding mode to pre-decoder
// if it is in automatic mode and validate the input encoding using iconv if available.
if (av_codec_is_decoder(avctx->codec) && avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (avctx->properties & AV_CODEC_PROPERTY_BITMAP_BASED) {
        av_log(avctx, AV_LOG_WARNING, "Ignoring character encoding for bitmap-based subtitle codec\n");
    } else {
        if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC) {
            avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
        }
        if (avctx->sub_charenc && strcmp(avctx->sub_charenc, "utf-8") != 0) {
            #ifdef HAVE_ICONV
            iconv_t cd = iconv_open("utf-8", avctx->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(avctx, AV_LOG_ERROR, "Unsupported input subtitle character encoding '%s'\n", avctx->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
            #else
            av_log(avctx, AV_LOG_WARNING, "Input subtitle character encoding '%s' not supported. Assuming UTF-8.\n", avctx->sub_charenc);
            #endif
        }
    }
}