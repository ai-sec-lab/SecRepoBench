if (avctx->codec->type == AVMEDIA_TYPE_SUBTITLE) {
        // Check if character encoding is set for subtitle codecs
        if (avctx->subtitle_header) {
            // Handle character encoding for text-based subtitles
            if (avctx->subtitle_header->encoding == AV_ENCODING_AUTO) {
                // Set to pre-decoder mode if automatic
                avctx->subtitle_header->encoding = AV_ENCODING_PRE_DECODER;
            }
            // Validate input encoding if iconv is available
            #ifdef HAVE_ICONV
            if (iconv_open(avctx->subtitle_header->encoding, "UTF-8") == (iconv_t)-1) {
                av_log(avctx, AV_LOG_ERROR, "Invalid character encoding specified for subtitles.\n");
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            #endif
        } else {
            av_log(avctx, AV_LOG_WARNING, "No subtitle header set, character encoding will not be applied.\n");
        }
    } else {
        av_log(avctx, AV_LOG_WARNING, "Character encoding is ignored for non-subtitle codecs.\n");
    }