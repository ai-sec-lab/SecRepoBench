if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_DO_NOTHING) {
        avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
    }
    if (avctx->codec->pix_fmts && avctx->codec->pix_fmts[0] != AV_PIX_FMT_NONE) {
        av_log(avctx, AV_LOG_WARNING, "Subtitle codec '%s' is bitmap-based, "
               "ignoring specified character encoding.\n", avctx->codec->name);
    } else if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTO) {
        avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;
    }
    if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER && avctx->sub_charenc) {
        if (av_opt_set(avctx, "sub_charenc_mode", "pre_decoder", 0) < 0) {
            av_log(avctx, AV_LOG_ERROR, "Error setting sub_charenc_mode to pre_decoder.\n");
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
        if (av_opt_set(avctx, "sub_charenc", avctx->sub_charenc, 0) < 0) {
            av_log(avctx, AV_LOG_ERROR, "Error setting sub_charenc to %s.\n", avctx->sub_charenc);
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
#if HAVE_ICONV
        if (!iconv_check_encoding(avctx->sub_charenc, 0)) {
            av_log(avctx, AV_LOG_ERROR, "Invalid subtitle_charater_encoding.\n");
            ret = AVERROR(EINVAL);
            goto free_and_end;
        }
#endif
    }
}