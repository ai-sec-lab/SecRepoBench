if (av_codec_is_decoder(avctx->codec) && avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
            if (avctx->sub_charenc) {
                if (avctx->codec->caps_internal & FF_CODEC_CAP_BITMAP_SUB) {
                    av_log(avctx, AV_LOG_WARNING, "Character encoding is ignored for bitmap-based subtitle codec\n");
                } else {
                    if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
                        avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;

                    if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
                        if (!avctx->sub_charenc) {
                            av_log(avctx, AV_LOG_ERROR, "Character encoding must be specified for text-based subtitle codec\n");
                            ret = AVERROR(EINVAL);
                            goto free_and_end;
                        }
#if HAVE_ICONV
                        avctx->sub_charenc_iconv = iconv_open("UTF-8", avctx->sub_charenc);
                        if (avctx->sub_charenc_iconv == (iconv_t)(-1)) {
                            av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context with encoding %s\n", avctx->sub_charenc);
                            ret = AVERROR(EINVAL);
                            goto free_and_end;
                        }
#else
                        av_log(avctx, AV_LOG_ERROR, "Iconv is not available, cannot convert character encoding\n");
                        ret = AVERROR(ENOSYS);
                        goto free_and_end;
#endif
                    }
                }
            }
        }