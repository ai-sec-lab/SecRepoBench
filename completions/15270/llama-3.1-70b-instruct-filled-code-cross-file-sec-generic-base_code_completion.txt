if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (avctx->subtitle_header) {
        av_log(avctx, AV_LOG_WARNING, "Subtitle header already set, ignoring.\n");
        avctx->subtitle_header = NULL;
    }
    if (avctx->sub_charenc) {
        if (avctx->sub_charenc_mode == AV_SUB_CHARENC_MODE_AUTOMATIC) {
            avctx->sub_charenc_mode = AV_SUB_CHARENC_MODE_PRE_DECODER;
        }
        if (avctx->sub_charenc_mode == AV_SUB_CHARENC_MODE_PRE_DECODER) {
            // Validate the input encoding using iconv if available.
            // For now, just check if the encoding is supported by iconv.
            // In the future, we can use iconv to convert the encoding if necessary.
            if (avcodec_iconv_check(avctx->sub_charenc) < 0) {
                av_log(avctx, AV_LOG_ERROR, "Invalid subtitle character encoding '%s'.\n", avctx->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
        }
    }
} else if (avctx->sub_charenc) {
    av_log(avctx, AV_LOG_WARNING, "Ignoring subtitle character encoding for non-subtitle codec.\n");
    avctx->sub_charenc = NULL;
}