if (avctx->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (avctx->codec_descriptor->props & AV_CODEC_PROP_BITMAP_SUB) {
        if (avctx->sub_charenc) {
            av_log(avctx, AV_LOG_WARNING, "Bitmap-based subtitles do not use character encoding. "
                   "The sub_charenc option will be ignored.\n");
            avctx->sub_charenc = NULL;
        }
    } else {
        if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
            avctx->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;

        if (avctx->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER && avctx->sub_charenc) {
#if CONFIG_ICONV
            iconv_t cd = iconv_open("UTF-8", avctx->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(avctx, AV_LOG_ERROR, "Unable to open iconv context "
                       "with input character encoding \"%s\"\n", avctx->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
#else
            av_log(avctx, AV_LOG_WARNING, "Character encoding is set but "
                   "iconv is not compiled in. Encoding will be ignored.\n");
#endif
        }
    }
}