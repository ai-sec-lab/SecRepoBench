if (codeccontext->codec_type == AVMEDIA_TYPE_SUBTITLE) {
    if (codeccontext->codec_id == AV_CODEC_ID_DVB_SUBTITLE ||
        codeccontext->codec_id == AV_CODEC_ID_DVB_TELETEXT ||
        codeccontext->codec_id == AV_CODEC_ID_HDMV_PGS_SUBTITLE) {
        av_log(codeccontext, AV_LOG_WARNING, "Ignoring character encoding for bitmap-based subtitle codec.\n");
    } else {
        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_AUTOMATIC)
            codeccontext->sub_charenc_mode = FF_SUB_CHARENC_MODE_PRE_DECODER;

        if (codeccontext->sub_charenc_mode == FF_SUB_CHARENC_MODE_PRE_DECODER) {
#if CONFIG_ICONV
            iconv_t cd = iconv_open("UTF-8", codeccontext->sub_charenc);
            if (cd == (iconv_t)-1) {
                av_log(codeccontext, AV_LOG_ERROR, "Unable to open iconv context "
                       "with input character encoding \"%s\"\n", codeccontext->sub_charenc);
                ret = AVERROR(EINVAL);
                goto free_and_end;
            }
            iconv_close(cd);
#else
            av_log(codeccontext, AV_LOG_WARNING, "Character encoding validation "
                   "needed, but iconv is not available\n");
#endif
        }
    }
}