bool axis_not_pinned = false;

  /* Remember which axes the user has explicitly pinned. */
  std::vector<bool> axis_is_pinned (axes.length, false);

  /* First pass – normalise user-supplied design coordinates using ‘fvar’. */
  for (unsigned i = 0; i < axes.length; i++)
  {
    const hb_tag_t tag = axes[i].axisTag;

    float design_value;
    if (!plan->user_axes_location.get (tag, &design_value))
    {
      /* Axis not supplied by user – keep it un-pinned. */
      axis_not_pinned = true;
      plan->normalized_coords[i] = 0;
    }
    else
    {
      axis_is_pinned[i] = true;
      /* Convert design-space value to normalised (-16384 .. 16384). */
      plan->normalized_coords[i] =
        fontface->table.fvar->normalize_axis_value (i, design_value);
    }

    /* Record the axis index mapping (old → new is identical for now). */
    plan->axis_index_map.add (i);
  }

  /* If an ‘avar’ table exists, remap the normalised coordinates. */
  if (has_avar && axes.length)
    fontface->table.avar->map_coords (&plan->normalized_coords[0], axes.length);

  /* Populate the final axis-location map with the (possibly remapped) values. */
  for (unsigned i = 0; i < axes.length; i++)
  {
    if (!axis_is_pinned[i])
      continue;

    plan->axes_location.set (axes[i].axisTag, plan->normalized_coords[i]);
  }