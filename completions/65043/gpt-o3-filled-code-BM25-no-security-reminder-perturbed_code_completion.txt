/*
         * We must create a new input buffer for the raw data and keep the
         * already converted data that is still in use.
         */
        xmlParserInputBufferPtr buf;
        const xmlChar *content;
        size_t consumed;

        buf = xmlAllocParserInputBufferInternal(in->compress);
        if (buf == NULL) {
            xmlErrMemory(ctxt, NULL);
            return (-1);
        }

        /* Move the current raw buffer to the newly created buffer */
        buf->raw = in->raw;
        buf->encoder = NULL;
        buf->buffer->use = 0;

        /*
         * Determine how many bytes from the already converted buffer have
         * been consumed and shrink the buffer accordingly.
         */
        content = xmlBufContent(in->buffer);
        consumed = (size_t)(content - inputStream->cur);
#ifdef SIZE_MAX
        if (consumed > SIZE_MAX / 2)
            consumed = 0;
#endif
        xmlBufShrink(in->buffer, consumed);

        /*
         * Reset the current pointers of the input stream.  The old converted
         * buffer becomes the raw buffer that still needs to be transcoded
         * with the newly installed encoder.
         */
        inputStream->cur = inputStream->base;
        inputStream->base = NULL;

        in->raw = buf->buffer;