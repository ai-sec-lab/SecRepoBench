const bitint *x = (const bitint*)xs;
  const bitint *y = (const bitint*)ys;
  bitint w = *x;
  bitint mask = MASK1 * (w & MASK2);
  mask = (mask - MASK1) & ~mask & MASK3;
  size_t i = 0;

  while (i + sizeof(bitint) <= n) {
    bitint v = *y ^ w;
    if ((v - MASK1) & ~v & MASK3) {
      break;
    }
    y++;
    i += sizeof(bitint);
  }

  if (i + m > n) return -1;

#if defined(MRB_ENDIAN_BIG)
  mask = (mask >> ((sizeof(bitint) - 1) * 8)) & 0xff;
#endif

  while (mask) {
    if ((mask & MASK4) && memcmp(xs, ys + i, m) == 0) {
      return (mrb_int)i;
    }
    mask <<= 1;
    i++;
  }