bitint *s0 = (bitint *)xs;
  bitint *s1 = (bitint *)ys;
  long i = 0;
  long nn = n - m + 1;
  bitint a, b, c;

  if (m == 0) return 0;
  if (n < m) return -1;

  for (; i+m <= n; i += sizeof(bitint)) {
    a = *s1;
    b = *s0;
    c = a ^ b;
    c |= c >> 1;
    c |= c >> 2;
    c |= c >> 4;
#ifdef MRB_64BIT
    c |= c >> 8;
    c |= c >> 16;
    c |= c >> 32;
#endif
    c &= MASK1;
    if (c == MASK1) {
      if (memcmp(ys + i, xs, m) == 0) return i;
    }
    s1++;
  }

  if (i < nn) {
    const char *p = (const char *)s1;
    const char *e = ys + n;
    for (;p<e;) {
      size_t len = e-p;
      p = (const char*)memchr(p, *xs, len);
      if (p == NULL || len < m) break;
      if (memcmp(p+1, xs+1, m-1) == 0) return (mrb_int)(p - ys);
      p++;
    }
  }