bitint mask = 0;
  for (int i = 0; i < m; i++) {
    mask |= (bitint)(unsigned char)xs[i] << (i * 8);
  }

  const bitint *ys_aligned = (const bitint *)ys;
  mrb_int i;

  for (i = 0; i <= n - m; i += sizeof(bitint)) {
    bitint v = *ys_aligned++;
    bitint x = v ^ mask;
    bitint y = ((x - MASK1) & ~x & MASK3);

    if (y) {
      int j = 0;
#if defined(MRB_ENDIAN_BIG)
      while (!(y & MASK4)) {
        y <<= 8;
        j++;
      }
#else
      while (!(y & MASK4)) {
        y >>= 8;
        j++;
      }
#endif
      i += j;
      if (i + m <= n && memcmp(xs, ys + i, m) == 0) {
        return i;
      }
    }
  }