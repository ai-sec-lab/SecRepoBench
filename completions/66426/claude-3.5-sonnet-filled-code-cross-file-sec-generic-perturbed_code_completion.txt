const bitint *x = (const bitint*)needle;
  const bitint *y = (const bitint*)ys;
  bitint xor, ones, msbs, matches;
  mrb_int i;

  if (m > sizeof(bitint) || n < m) return -1;

  xor = *x ^ *y;
  ones = ~0;
  for (i = 0; i < m; i++) {
    ones &= ~((bitint)1 << (i * 8));
  }
  xor |= ones;

  for (i = 0; i <= n - m; i++) {
    msbs = xor & MASK3;
    matches = (((xor + MASK1) & ~xor & MASK3) >> 7) & MASK2;

    if (matches == MASK2) {
      return i;
    }

    if (i + m < n) {
      xor = (xor << 8) | (((const unsigned char*)ys)[i + sizeof(bitint)] ^ ((const unsigned char*)needle)[i + sizeof(bitint)]);
    } else {
      xor <<= 8;
    }
  }