mrb_int i;
  const bitint *x, *y;
  bitint w, z;

  if (m > n || m == 0) return -1;
  if (m == 1) {
    const char *p = memchr(ys, *xs, n);
    return p ? (mrb_int)(p - ys) : -1;
  }

  /* Prepare pattern */
  x = (const bitint*)xs;
  w = *x;
#if defined(MRB_ENDIAN_BIG)
  w >>= (sizeof(bitint) - m) * 8;
#endif
  w |= MASK3;

  /* Searching */
  i = 0;
  y = (const bitint*)ys;
  while (i <= n - sizeof(bitint)) {
    z = *y ^ w;
    if ((((z - MASK1) & ~z) & MASK3) == 0) {
      /* Found a match */
      if (memcmp(ys + i, xs, m) == 0) {
        return i;
      }
    }
    y++;
    i += sizeof(bitint);
  }