bitint *s0 = (bitint *)xs;
  bitint *s1 = (bitint *)ys;
  long i = 0;
  long nn = n - m + 1;
  bitint a, b, c;

  if (m == 0) return 0;
  if (n < m) return -1;

  for (; i<nn; i+=sizeof(bitint)) {
    a = s1[i/sizeof(bitint)];
    b = *s0;
    c = a ^ b;
    c |= c >> 1;
    c |= c >> 2;
    c |= c >> 4;
#ifdef MRB_64BIT
    c |= c >> 8;
    c |= c >> 16;
    c |= c >> 32;
#endif
    c &= MASK1;
    if (c == MASK1) {
      if (memcmp(ys+i, xs, m) == 0) return i;
    }
  }

  if (m==1) {
    const char *p = (const char*)memchr(ys, *xs, n);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }

  if (m > 1) {
    const char *p = (const char*)memchr(ys, *xs, n);
    if (p == NULL) return -1;
    i = (mrb_int)(p - ys);
    if (i + m > n) return -1;
    if (memcmp(p+1, xs+1, m-1) == 0) return i;
  }