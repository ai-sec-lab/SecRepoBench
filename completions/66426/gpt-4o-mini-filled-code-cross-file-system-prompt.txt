bitint *p1 = (bitint *)xs;
  bitint *p2 = (bitint *)ys;
  bitint pattern = *p1;
  bitint mask1 = MASK1;
  bitint mask2 = MASK2;
  bitint mask3 = MASK3;
  bitint mask4 = MASK4;

  // Prepare the pattern for searching
  bitint cmp_pattern = (pattern * mask1) & mask2;

  for (long i = 0; i <= n - m; i += sizeof(bitint)) {
    bitint text = *p2;
    bitint cmp_text = (text * mask1) & mask2;

    // Compare the text with the pattern
    bitint result = cmp_text ^ cmp_pattern;

    // Check if any bits are set in the result
    if ((result & mask3) == 0) {
      // Match found, check for endianness
      if (MASK4 == 0x80000000ul) {
        // Big-endian adjustment
        return (mrb_int)(i);
      } else {
        // Little-endian adjustment
        return (mrb_int)(i);
      }
    }
    p2++;
  }