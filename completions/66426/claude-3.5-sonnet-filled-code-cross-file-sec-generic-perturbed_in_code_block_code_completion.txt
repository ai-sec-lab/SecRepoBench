const bitint *x = (const bitint*)needle;
  const bitint *y = (const bitint*)ys;
  bitint xor, ones, msbs, matches;
  mrb_int i;

  if (m > sizeof(bitint) || n < m) return -1;

  xor = *x ^ *y;
  ones = ~0;
  for (i = 0; i < m; i++) {
    ones &= ~(MASK1 << i);
  }
  msbs = (xor & MASK2) + MASK1;
  matches = ~((msbs | xor) | (msbs - MASK1)) | ones;

  if ((matches & MASK3) == MASK3) return 0;

  for (i = sizeof(bitint); i + m <= n; i += sizeof(bitint)) {
    y++;
    xor = *x ^ *y;
    msbs = (xor & MASK2) + MASK1;
    matches = ~((msbs | xor) | (msbs - MASK1)) | ones;

    if ((matches & MASK3) == MASK3) return i;
  }