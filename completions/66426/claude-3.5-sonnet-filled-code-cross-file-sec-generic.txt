const bitint *x = (const bitint*)xs;
  const bitint *y = (const bitint*)ys;
  bitint w = *x;
  bitint mask = MASK1 * (w & MASK2);
  mask = (mask - MASK1) & ~mask & MASK3;
  size_t i = 0;

  while (i + sizeof(bitint) <= n) {
    bitint v = *y ^ w;
    if ((v - MASK1) & ~v & MASK3) {
      break;
    }
    y++;
    i += sizeof(bitint);
  }

  if (i + m > n) return -1;

  const unsigned char *s0 = (const unsigned char *)ys + i;
  const unsigned char *s = s0;
  const unsigned char *t = (const unsigned char *)xs;

  while (mask) {
    if ((mask & MASK4) && (s + m <= ys + n)) {
      if (memcmp(s, t, m) == 0) {
        return (mrb_int)(s - (const unsigned char *)ys);
      }
    }
    mask <<= 1;
    s++;
  }