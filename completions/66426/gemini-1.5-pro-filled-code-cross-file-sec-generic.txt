const char *s0 = xs;
  long i = 0;
  bitint a, b, x, y;

  if (m > n) return -1;

  /* preprocess */
  x = *xs;
  y = 1;
  for (i=1; i<m; i++) {
    x |= (bitint)xs[i] << i*8;
    y |= 1ull << i*8;
  }

  /* search */
  if (m == 1) {
    const char *p = memchr(ys, x, n);
    if (p) return (mrb_int)(p - ys);
    return -1;
  }
  i = 0;
  while (i+m <= n) {
    a = *(bitint*)(ys+i);
    b = x ^ a;
    if (((b - MASK1) & ~b & MASK2) == 0) {
      if (memcmp(xs, ys+i, m) == 0) return (mrb_int)i;
    }
#if defined(MRB_ENDIAN_BIG)
    if ((a & MASK4) == 0) {
      i += m;
      continue;
    }
    while (((a = *(bitint*)(ys+i)) & MASK4) == 0) { i++; }
#else
    if ((a & MASK4) == MASK4) {
      i += m;
      continue;
    }
    while (((a = *(bitint*)(ys+i)) & MASK4) != MASK4) { i++; }
#endif
  }