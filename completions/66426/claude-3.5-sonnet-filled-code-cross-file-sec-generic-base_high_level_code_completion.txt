const bitint *x = (const bitint*)xs;
  const bitint *y = (const bitint*)ys;
  bitint first = *x & MASK2;
  bitint last = x[m/sizeof(bitint)-1] & MASK2;
  bitint mask = first | (last << 8);

  for (mrb_int i = 0; i <= n - m; i += sizeof(bitint)) {
    bitint chunk = (*y & MASK2) | ((y[m/sizeof(bitint)-1] & MASK2) << 8);
    bitint xor_result = chunk ^ mask;
    bitint result = ((xor_result - MASK1) & ~xor_result & MASK3);

    if (result) {
      if (i + m <= n && memcmp(xs, ys + i, m) == 0) {
        return i;
      }
    }
    y++;
  }