000),
			gf_filter_pck_get_duration(ipck),
			vtt_pre, vtt_cueid, vtt_settings);
	} else {
		e = gf_webvtt_parser_parse(ctx->vttparser);
	}

	if (e != GF_OK) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] WebVTT parser error %s\n", gf_error_to_string(e) ));
		return e;
	}

	if (ctx->playstate==2)
		return GF_EOS;

	return GF_OK;
}
#endif

static GF_Err txtin_process_srt_or_webvtt(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	if (ctx->fmt == GF_TXTIN_MODE_SRT)
		return txtin_process_srt(filter, ctx, GF_FALSE);
#ifndef GPAC_DISABLE_VTT
	else if (ctx->fmt == GF_TXTIN_MODE_WEBVTT)
		return txtin_process_webvtt(filter, ctx, ipck);
#endif
	else
		return GF_NOT_SUPPORTED;
}

static GF_Err txtin_process_text(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_loaded) {
		e = gf_text_guess_format(ctx, ctx->file_name, &ctx->fmt);
		if (e) return e;
		ctx->is_loaded = GF_TRUE;
	}

	if (ctx->fmt == GF_TXTIN_MODE_NONE) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_PARSER, ("[TXTIn] No text format detected for file %s\n", ctx->file_name));
		return GF_NOT_SUPPORTED;
	}

	return txtin_process_srt_or_webvtt(filter, ctx, ipck);
}

static GF_Err txtin_process_packet(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_data(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_probe(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_TRUE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_flush(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_eos(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_EOS;
}

static GF_Err txtin_process_seek(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_pause(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_resume(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_stop(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_reset(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_destroy(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_set_property(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_get_property(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_get_info(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_get_status(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_get_error(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF_OK;
}

static GF_Err txtin_process_get_property_info(GF_Filter *filter, GF_TXTIn *ctx, GF_FilterPacket *ipck)
{
	GF_Err e;

	if (!ctx->is_setup) {
		e = txtin_setup_srt(filter, ctx, GF_FALSE);
		if (e) return e;
	}

	if (!ctx->ipid) return GF_NOT_SUPPORTED;

	if (ctx->text_process) {
		e = ctx->text_process(filter, ctx, ipck);
		if (e) return e;
	}

	return GF