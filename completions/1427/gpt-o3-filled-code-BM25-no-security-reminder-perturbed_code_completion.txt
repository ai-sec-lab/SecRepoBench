/* make sure the supplied buffer really contains enough data for the
     * announced geometry/bpp after all alignments have been taken into
     * account                                                                */
    {
        uint64_t expected_bits  = (uint64_t)aligned_width * avctx->height * c->bpp;
        uint64_t expected_bytes = (expected_bits + 7) >> 3; /* round up        */
        if (c->video_size < expected_bytes)
            return AVERROR_INVALIDDATA;
    }

    /* choose an appropriate output pixel format */
    if (!compressiontype && c->palette_size && c->bpp <= 8) {
        /* uncompressed, palettised */
        avctx->pix_fmt = AV_PIX_FMT_PAL8;
    } else if (compressiontype && (c->bpp == 6 || c->bpp == 8)) {
        /* HAM6 / HAM8 â€“ decode to true colour */
        avctx->pix_fmt = AV_PIX_FMT_BGR24;
    } else if (!compressiontype && !c->palette_size &&
               c->bpp == 24 && c->format == CHUNKY) {
        /* straight 24-bit chunky RGB */
        avctx->pix_fmt = AV_PIX_FMT_RGB24;
    } else {
        avpriv_request_sample(avctx, "format 0x%x, bpp %d, comp %d, pal %d",
                              c->format, c->bpp, compressiontype, c->palette_size);
        return AVERROR_PATCHWELCOME;
    }