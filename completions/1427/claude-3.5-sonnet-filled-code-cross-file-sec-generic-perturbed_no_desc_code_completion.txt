if (c->video_size < (aligned_width * c->bpp * height) / 8)
    return AVERROR_INVALIDDATA;

avctx->pix_fmt = AV_PIX_FMT_PAL8;

if (c->palette_size) {
    const uint8_t *pal = c->palette;
    int size = FFMIN(c->palette_size, AVPALETTE_SIZE);
    memset(c->pal, 0, sizeof(c->pal));
    memcpy(c->pal, pal, size);
    pal += size;
}