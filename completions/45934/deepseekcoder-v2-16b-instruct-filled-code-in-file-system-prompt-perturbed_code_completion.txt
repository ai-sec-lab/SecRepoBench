case 8:
        {
          unsigned char
            quantum;

          if (image->alpha_trait != UndefinedPixelTrait)
            {
              quantum=ClampToQuantum(pixel->alpha);
              *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
            }
          break;
        }
        case 16:
        {
          unsigned short
            quantum;

          if (image->alpha_trait != UndefinedPixelTrait)
            {
              quantum=ClampToQuantum(pixel->alpha);
              *pixels++=(unsigned char) (quantum >> (image->depth-
                MAGICKCORE_QUANTUM_DEPTH));
            }
          break;
        }
        case 32:
        default:
        {
          unsigned int
            quantum;

          if (image->alpha_trait != UndefinedPixelTrait)
            {
              quantum=ClampToQuantum(pixel->alpha);
              *pixels++=(unsigned char) (quantum >> (image->depth-
                MAGICKCORE_QUANTUM_DEPTH));
            }
          break;
        }
      }
      *pixels++=length;
      return(pixels);
    }
  if (IsGrayColorspace(image->colorspace) != MagickFalse)
    {
      unsigned char
        quantum;

      quantum=ClampToQuantum(pixel->red);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
      quantum=ClampToQuantum(pixel->green);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
      quantum=ClampToQuantum(pixel->blue);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          quantum=ClampToQuantum(pixel->alpha);
          *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
        }
      *pixels++=length;
      return(pixels);
    }
  if (image->colorspace == CMYKColorspace)
    {
      unsigned char
        quantum;

      quantum=ClampToQuantum(pixel->cyan);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
      quantum=ClampToQuantum(pixel->magenta);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
      quantum=ClampToQuantum(pixel->yellow);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
      quantum=ClampToQuantum(pixel->black);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
      if (image->alpha_trait != UndefinedPixelTrait)
        {
          quantum=ClampToQuantum(pixel->alpha);
          *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
        }
      *pixels++=length;
      return(pixels);
    }
  quantum=ClampToQuantum(pixel->red);
  *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
  quantum=ClampToQuantum(pixel->green);
  *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
  quantum=ClampToQuantum(pixel->blue);
  *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
  if (image->alpha_trait != UndefinedPixelTrait)
    {
      quantum=ClampToQuantum(pixel->alpha);
      *pixels++=(unsigned char) ScaleQuantumToChar(quantum);
    }
  *pixels++=length;
  return(pixels);
}

static MagickBooleanType WriteMIFFImage(const ImageInfo *image_info,
  Image *image,ExceptionInfo *exception)
{
#define BZipMaxExtent(x)  ((x)+((x)/100)+600)
#define LZMAMaxExtent(x)  ((x)+((x)/3)+128)
#define ZipMaxExtent(x)  ((x)+(((x)+7) >> 3)+(((x)+63) >> 6)+11)
#define ThrowMIFFException(exception,message) \
{ \
  if (quantum_info != (QuantumInfo *) NULL) \
    quantum_info=DestroyQuantumInfo(quantum_info); \
  if (compress_pixels != (unsigned char *) NULL) \
    compress_pixels=(unsigned char *) RelinquishMagickMemory(compress_pixels); \
  ThrowWriterException((exception),(message)); \
}

#if defined(MAGICKCORE_BZLIB_DELEGATE)
  bz_stream
    bzip_info;
#endif

  char
    *options;

  double
    version;

  size_t
    compress_extent,
    extent,
    length,
    packet_size;

  unsigned char
    *compress_pixels,
    *pixels;

  ssize_t
    y;

#if defined(MAGICKCORE_ZLIB_DELEGATE)
  z_stream
    zip_info;
#endif

  /*
    Open image file.
  */
  assert(image_info != (const ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  assert(image != (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  if (image_info->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",
      image_info->filename);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  /*
    Initialize image.
  */
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
  if (image->ping != MagickFalse)
    return(MagickTrue);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
  if (image->endian == UndefinedEndian)
    image->endian=LSBEndian;
  if (image->colorspace == UndefinedColorspace)
    image->colorspace=sRGBColorspace;
  if (image->depth == 0)
    image->depth=8;
  if (image->storage_class == UndefinedClass)
    image->storage_class=DirectClass;
  if (image->compression == UndefinedCompression)
    image->compression=NoCompression;
  if (image->alpha_trait == UndefinedPixelTrait)
    image->alpha_trait=OpaquePixelTrait;
  if (image->orientation == UndefinedOrientation)
    image->orientation=TopLeftOrientation;
  if (image->ticks_per_second == 0)
    image->ticks_per_second=100;
  if (image->delay == 0)
    image->delay=100;
  if (image->dispose == UndefinedDispose)
    image->dispose=NoneDispose;
  if (image->gamma == 0.0)
    image->gamma=QuantumScale;
  if (image->quality == 0)
    image->quality=100;
  if (image->colors == 0)
    image->colors=256;
  if (image->resolution.x == 0)
    image->resolution.x=72.0;
  if (image->resolution.y == 0)
    image->resolution.y=72.0;
  if (image->units == UndefinedResolution)
    image->units=PixelsPerInchResolution;
  if (image->rendering_intent == UndefinedIntent)
    image->rendering_intent=PerceptualIntent;
  if (image->scene == 0)
    image->scene=1;
  if (image->type == UndefinedImage)
    image->type=TrueColorType;
  if (image->matte_color.opacity == UndefinedOpacity)
    image->matte_color.opacity=OpaqueOpacity;
  if (image->matte_color.red == UndefinedPixel)
    image->matte_color.red=0;
  if (image->matte_color.green == UndefinedPixel)
    image->matte_color.green=0;
  if (image->matte_color.blue == UndefinedPixel)
    image->matte_color.blue=0;
  if (image->montage == (char *) NULL)
    image->montage=AcquireString(".");
  if (image->filename == (char *) NULL)
    image->filename=AcquireString("Untitled");
  if (image->previous == (Image *) NULL)
    image->previous=image;
  if (image->next == (Image *) NULL)
    image->next=image;
  if (image->active_index == 0)
    image->active_index=1;
  if (image->scene == 0)
    image->scene=1;
  if (image->ticks_per_second == 0)
    image->ticks_per_second=100;
  if (image->delay == 0)
    image->delay=100;
  if (image->dispose == UndefinedDispose)
    image->dispose=NoneDispose;
  if (image->gamma == 0.0)
    image->gamma=QuantumScale;
  if (image->quality == 0)
    image->quality=100;
  if (image->colors == 0)
    image->colors=256;
  if (image->resolution.x == 0)
    image->resolution.x=72.0;
  if (image->resolution.y == 0)
    image->resolution.y=72.0;
  if (image->units == UndefinedResolution)
    image->units=PixelsPerInchResolution;
  if (image->rendering_intent == UndefinedIntent)
    image->rendering_intent=PerceptualIntent;
  if (image->scene == 0)
    image->scene=1;
  if (image->type == UndefinedImage)
    image->type=TrueColorType;
  if (image->matte_color.opacity == UndefinedOpacity)
    image->matte_color.opacity=OpaqueOpacity;
  if (image->matte_color.red == UndefinedPixel)
    image->matte_color.red=0;
  if (image->matte_color.green == UndefinedPixel)
    image->matte_color.green=0;
  if (image->matte_color.blue == UndefinedPixel)
    image->matte_color.blue=0;
  if (image->montage == (char *) NULL)
    image->montage=AcquireString(".");
  if (image->filename == (char *) NULL)
    image->filename=AcquireString("Untitled");
  if (image->previous == (Image *) NULL)
    image->previous=image;
  if (image->next == (Image *) NULL)
    image->next=image;
  if (image->active_index == 0)
    image->active_index=1;
  if (image->scene == 0)
    image->scene=1;
  if (image->ticks_per_second == 0)
    image->ticks_per_second=100;
  if (image->delay == 0)
    image->delay=100;
  if (image->dispose == UndefinedDispose)
    image->dispose=NoneDispose;
  if (image->gamma == 0.0)
    image->gamma=QuantumScale;
  if (image->quality == 0)
    image->quality=100;
  if (image->colors == 0)
    image->colors=256;
  if (image->resolution.x == 0)
    image->resolution.x=72.0;
  if (image->resolution.y == 0)
    image->resolution.y=72.0;
  if (image->units == UndefinedResolution)
    image->units=PixelsPerInchResolution;
  if (image->rendering_intent == UndefinedIntent)
    image->rendering_intent=PerceptualIntent;
  if (image->scene == 0)
    image->scene=1;
  if (image->type == UndefinedImage)
    image->type=TrueColorType;
  if (image->matte_color.opacity == UndefinedOpacity)
    image->matte_color.opacity=OpaqueOpacity;
  if (image->matte_color.red == UndefinedPixel)
    image->matte_color.red=0;
  if (image->matte_color.green == UndefinedPixel)
    image->matte_color.green=0;
  if (image->matte_color.blue == UndefinedPixel)
    image->matte_color.blue=0;
  if (image->montage == (char *) NULL)
    image->montage=AcquireString(".");
  if (image->filename == (char *) NULL)
    image->filename=AcquireString("Untitled");
  if (image->previous == (Image *) NULL)