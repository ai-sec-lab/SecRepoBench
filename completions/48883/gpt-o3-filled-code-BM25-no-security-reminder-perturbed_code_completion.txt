/* ------------------------------------------------------- *
           * Extract and validate the filename that follows opcode   *
           * ------------------------------------------------------- */
          {
            size_t fname_len = 0;
            size_t payload_ofs = 2;                      /* filename starts right after opcode */

            /* Walk through the buffer until we hit the terminating NUL             */
            /* while making sure the chars are printable ASCII characters as per RFC */
            while((payload_ofs + fname_len) < tftp_packet->payload_packet_len &&
                  tftp_packet->payload[payload_ofs + fname_len] != 0x00)
            {
              uint8_t ch = tftp_packet->payload[payload_ofs + fname_len];

              if(ch < 32 || ch > 126)   /* non-printable ASCII -> not a valid TFTP filename */
              {
                NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
                return;
              }
              fname_len++;
            }

            /* filename must be non-empty and terminated with NUL inside the packet */
            if((payload_ofs + fname_len) >= tftp_packet->payload_packet_len || fname_len == 0)
            {
              NDPI_EXCLUDE_PROTO(ndpi_struct, flow);
              return;
            }

            /* Copy filename into the flow structure (truncate if necessary) */
#ifdef offsetof
            /* make sure the member exists and is an array */
#endif
            {
              size_t max_copy = sizeof(flow->l4.udp.tftp_filename) - 1;

              if(fname_len > max_copy)
                fname_len = max_copy;

              memcpy(flow->l4.udp.tftp_filename,
                     &tftp_packet->payload[payload_ofs],
                     fname_len);
              flow->l4.udp.tftp_filename[fname_len] = '\0';
            }

            /* Log and mark the flow as TFTP */
            NDPI_LOG_INFO(ndpi_struct,
                          "found tftp RRQ/WWQ (filename: %s)\n",
                          flow->l4.udp.tftp_filename);

            ndpi_int_tftp_add_connection(ndpi_struct, flow);
          }