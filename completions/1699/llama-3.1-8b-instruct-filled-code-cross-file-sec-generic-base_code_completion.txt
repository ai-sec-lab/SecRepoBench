if (s->num_primitive_matrices > max_primitive_matrices) {
    av_log(m->avctx, AV_LOG_ERROR, "Number of primitive matrices exceeds maximum allowed.\n");
    return AVERROR_INVALIDDATA;
}

for (ch = 0; ch < s->num_primitive_matrices; ch++) {
    if (read_channel_params(m, substr, gbp, ch) < 0) {
        return AVERROR_INVALIDDATA;
    }

    mat = get_bits(gbp, 4);
    if (mat > max_primitive_matrices) {
        av_log(m->avctx, AV_LOG_ERROR, "Matrix index exceeds maximum allowed.\n");
        return AVERROR_INVALIDDATA;
    }

    if (mat > s->num_primitive_matrices) {
        av_log(m->avctx, AV_LOG_ERROR, "Matrix index exceeds number of primitive matrices.\n");
        return AVERROR_INVALIDDATA;
    }

    s->matrix_output_channel[ch] = get_bits(gbp, 4);
    if (s->matrix_output_channel[ch] > max_primitive_matrices) {
        av_log(m->avctx, AV_LOG_ERROR, "Matrix output channel exceeds maximum allowed.\n");
        return AVERROR_INVALIDDATA;
    }

    s->matrix_fractional_bits[ch] = get_bits(gbp, 4);
    if (s->matrix_fractional_bits[ch] > 15) {
        av_log(m->avctx, AV_LOG_ERROR, "Matrix fractional bits exceeds maximum allowed.\n");
        return AVERROR_INVALIDDATA;
    }

    s->lsb_bypass[ch] = get_bits1(gbp);
    if (s->lsb_bypass[ch]) {
        s->matrix_coefficients[ch] = get_bits(gbp, 16);
    } else {
        s->matrix_coefficients[ch] = get_bits(gbp, 32);
    }

    if (s->noise_present) {
        s->matrix_noise_shift[ch] = get_bits(gbp, 4);
        if (s->matrix_noise_shift[ch] > 15) {
            av_log(m->avctx, AV_LOG_ERROR, "Matrix noise shift exceeds maximum allowed.\n");
            return AVERROR_INVALIDDATA;
        }
    } else {
        s->matrix_noise_shift[ch] = 0;
    }
}