if (in.empty()) {
    return;
}

// Remove leading spaces or new lines
while (!in.empty() && (in[0] == ' ' || in[0] == '\n' || in[0] == '\r')) {
    in.erase(0, 1);
}

const char separator = getOsSeparator();
size_t i = 0;
bool lastWasSeparator = false;

while (i < in.length()) {
    // Skip over "://" and "\\\\"
    if (i + 2 < in.length() && in[i] == ':' && in[i + 1] == '/' && in[i + 2] == '/') {
        i += 3;
        continue;
    }
    if (i == 0 && i + 1 < in.length() && in[i] == '\\' && in[i + 1] == '\\') {
        i += 2;
        continue;
    }

    // Replace '/' and '\\' with the OS separator
    if (in[i] == '/' || in[i] == '\\') {
        in[i] = separator;
        if (lastWasSeparator) {
            in.erase(i, 1);
            continue;
        }
        lastWasSeparator = true;
    } else {
        lastWasSeparator = false;
    }

    // Convert hexadecimal sequences in URIs
    if (in[i] == '%' && i + 2 < in.length()) {
        if (IsHex(in[i + 1]) && IsHex(in[i + 2])) {
            char hex[3] = {in[i + 1], in[i + 2], 0};
            char decoded = static_cast<char>(strtol(hex, nullptr, 16));
            in[i] = decoded;
            in.erase(i + 1, 2);
        }
    }

    ++i;
}

// Remove trailing separator if present
if (!in.empty() && in.back() == separator) {
    in.pop_back();
}