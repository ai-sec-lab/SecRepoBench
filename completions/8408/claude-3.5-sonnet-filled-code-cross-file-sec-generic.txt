primitive_info=(PrimitiveInfo *) AcquireQuantumMemory(number_points,
  sizeof(*primitive_info));
if (primitive_info == (PrimitiveInfo *) NULL)
  ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
graphic_context=(DrawInfo **) AcquireQuantumMemory(number_points,
  sizeof(*graphic_context));
if (graphic_context == (DrawInfo **) NULL)
  ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
for (i=0; i < (ssize_t) number_points; i++)
{
  graphic_context[i]=CloneDrawInfo((ImageInfo *) NULL, draw_info);
  if (graphic_context[i] == (DrawInfo *) NULL)
    ThrowWriterException(ResourceLimitError,"MemoryAllocationFailed");
}
n=0;
status=MagickTrue;
GetAffineMatrix(&affine);
for (q=(const char *) draw_info->primitive; *q != '\0'; )
{
  /*
    Interpret drawing primitive.
  */
  GetNextToken(q,&q,MagickPathExtent,keyword);
  if (*keyword == '\0')
    break;
  if (*keyword == '#')
    {
      /*
        Comment.
      */
      while ((*q != '\n') && (*q != '\0'))
        q++;
      continue;
    }
  j=i;
  for (i=0; primitive_info[i].primitive != UndefinedPrimitive; i++)
    if (i >= (ssize_t) number_points)
      break;
  primitive_info[i].primitive=UndefinedPrimitive;
  switch (*keyword)
  {
    case 'a':
    case 'A':
    {
      if (LocaleCompare("affine",keyword) == 0)
        {
          GetAffineMatrix(&affine);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'b':
    case 'B':
    {
      if (LocaleCompare("bezier",keyword) == 0)
        {
          if (primitive_info[j].coordinates != 0)
            {
              primitive_info[i]=primitive_info[j];
              i++;
            }
          primitive_info[i].primitive=BezierPrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'c':
    case 'C':
    {
      if (LocaleCompare("clip-path",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          (void) CloneString(&graphic_context[n]->clip_mask,token);
          break;
        }
      if (LocaleCompare("clip-rule",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          graphic_context[n]->fill_rule=(FillRule) ParseCommandOption(
            MagickFillRuleOptions,MagickFalse,token);
          break;
        }
      if (LocaleCompare("clip-units",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          graphic_context[n]->clip_units=(ClipPathUnits) ParseCommandOption(
            MagickClipPathOptions,MagickFalse,token);
          break;
        }
      if (LocaleCompare("circle",keyword) == 0)
        {
          primitive_info[i].primitive=CirclePrimitive;
          break;
        }
      if (LocaleCompare("color",keyword) == 0)
        {
          primitive_info[i].primitive=ColorPrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'd':
    case 'D':
    {
      if (LocaleCompare("decorate",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          graphic_context[n]->decorate=(DecorationType) ParseCommandOption(
            MagickDecorateOptions,MagickFalse,token);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'e':
    case 'E':
    {
      if (LocaleCompare("ellipse",keyword) == 0)
        {
          primitive_info[i].primitive=EllipsePrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'f':
    case 'F':
    {
      if (LocaleCompare("fill",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          (void) QueryColorCompliance(token,AllCompliance,
            &graphic_context[n]->fill,exception);
          break;
        }
      if (LocaleCompare("font",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          (void) CloneString(&graphic_context[n]->font,token);
          if (LocaleCompare("none",token) == 0)
            graphic_context[n]->font=(char *) RelinquishMagickMemory(
              graphic_context[n]->font);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'g':
    case 'G':
    {
      if (LocaleCompare("gravity",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          graphic_context[n]->gravity=(GravityType) ParseCommandOption(
            MagickGravityOptions,MagickFalse,token);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'i':
    case 'I':
    {
      if (LocaleCompare("image",keyword) == 0)
        {
          primitive_info[i].primitive=ImagePrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'l':
    case 'L':
    {
      if (LocaleCompare("line",keyword) == 0)
        {
          primitive_info[i].primitive=LinePrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'm':
    case 'M':
    {
      if (LocaleCompare("matte",keyword) == 0)
        {
          primitive_info[i].primitive=AlphaPrimitive;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'o':
    case 'O':
    {
      if (LocaleCompare("opacity",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          graphic_context[n]->alpha=StringToDouble(token,(char **) NULL);
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'p':
    case 'P':
    {
      if (LocaleCompare("path",keyword) == 0)
        {
          primitive_info[i].primitive=PathPrimitive;
          break;
        }
      if (LocaleCompare("point",keyword) == 0)
        {
          primitive_info[i].primitive=PointPrimitive;
          break;
        }
      if (LocaleCompare("polygon",keyword) == 0)
        {
          primitive_info[i].primitive=PolygonPrimitive;
          break;
        }
      if (LocaleCompare("polyline",keyword) == 0)
        {
          primitive_info[i].primitive=PolylinePrimitive;
          break;
        }
      if (LocaleCompare("pop",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          if (LocaleCompare("clip-path",token) == 0)
            {
              (void) CloneString(&graphic_context[n]->clip_mask,"none");
              break;
            }
          if (LocaleCompare("defs",token) == 0)
            break;
          if (LocaleCompare("gradient",token) == 0)
            break;
          if (LocaleCompare("graphic-context",token) == 0)
            {
              if (n <= 0)
                {
                  (void) ThrowMagickException(exception,GetMagickModule(),
                    DrawError,"UnbalancedGraphicContextPushPop","`%s'",
                    token);
                  status=MagickFalse;
                  break;
                }
              if (graphic_context[n]->clip_mask != (char *) NULL)
                if (LocaleCompare(graphic_context[n]->clip_mask,
                    graphic_context[n-1]->clip_mask) != 0)
                  (void) SetImageClipMask(image,(Image *) NULL,exception);
              graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
              n--;
              break;
            }
          if (LocaleCompare("pattern",token) == 0)
            break;
          status=MagickFalse;
          break;
        }
      if (LocaleCompare("push",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          if (LocaleCompare("clip-path",token) == 0)
            {
              GetNextToken(q,&q,MagickPathExtent,token);
              (void) CloneString(&graphic_context[n]->clip_mask,token);
              break;
            }
          if (LocaleCompare("defs",token) == 0)
            break;
          if (LocaleCompare("gradient",token) == 0)
            break;
          if (LocaleCompare("graphic-context",token) == 0)
            {
              n++;
              if (n >= (ssize_t) number_points)
                ThrowWriterException(ResourceLimitError,
                  "MemoryAllocationFailed");
              graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,
                graphic_context[n-1]);
              if (graphic_context[n] == (DrawInfo *) NULL)
                ThrowWriterException(ResourceLimitError,
                  "MemoryAllocationFailed");
              break;
            }
          if (LocaleCompare("pattern",token) == 0)
            break;
          status=MagickFalse;
          break;
        }
      status=MagickFalse;
      break;
    }
    case 'r':
    case 'R':
    {
      if (LocaleCompare("rectangle",keyword) == 0)
        {
          primitive_info[i].primitive=RectanglePrimitive;
          break;
        }
      if (LocaleCompare("rotate",keyword) == 0)
        {
          GetNextToken(q,&q,MagickPathExtent,token);
          angle=StringToDouble(token,(char **) NULL);
          affine.sx=cos(DegreesToRadians(fmod(angle,360.0)));
          affine.rx=sin(DegreesToRadians(fmod(angle,360.0)));
          affine.ry=(-sin(DegreesToRadians(fmod(angle,360.0))));
          affine.sy=cos(DegreesToRadians(fmod(angle,360.0)));
          brea