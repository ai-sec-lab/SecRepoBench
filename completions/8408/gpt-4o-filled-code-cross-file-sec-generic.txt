MagickBooleanType
    status;

  PrimitiveInfo
    *primitive_info;

  size_t
    number_points;

  ssize_t
    n;

  StopInfo
    *stops;

  /*
    Initialize graphics context.
  */
  assert(image != (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",image->filename);
  assert(draw_info != (DrawInfo *) NULL);
  assert(draw_info->signature == MagickCoreSignature);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  status=MagickTrue;
  number_points=2047;
  primitive_info=(PrimitiveInfo *) AcquireQuantumMemory(number_points,
    sizeof(*primitive_info));
  if (primitive_info == (PrimitiveInfo *) NULL)
    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
      image->filename);
  stops=(StopInfo *) NULL;
  GetAffineMatrix(&affine);
  GetAffineMatrix(&current);
  token=AcquireString(draw_info->primitive);
  extent=strlen(token)+MagickPathExtent;
  primitive=AcquireString(token);
  n=0;
  for (q=(const char *) token; *q != '\0'; )
  {
    /*
      Interpret graphic primitive.
    */
    GetNextToken(q,&q,MagickPathExtent,keyword);
    if (*keyword == '\0')
      break;
    if (*keyword == '#')
      {
        /*
          Comment.
        */
        while ((*q != '\n') && (*q != '\0'))
          q++;
        continue;
      }
    if (LocaleCompare("push",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        if (LocaleCompare("graphic-context",token) == 0)
          {
            if (n >= (ssize_t) (MaxGraphicContexts-1))
              ThrowBinaryException(DrawError,"TooManyGraphicContexts",
                keyword);
            n++;
            graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,
              graphic_context[n-1]);
            continue;
          }
        ThrowBinaryException(DrawError,"UnrecognizedPushToken",token);
      }
    if (LocaleCompare("pop",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        if (LocaleCompare("graphic-context",token) == 0)
          {
            if (n <= 0)
              ThrowBinaryException(DrawError,"UnbalancedGraphicContextPushPop",
                token);
            graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
            n--;
            continue;
          }
        ThrowBinaryException(DrawError,"UnrecognizedPopToken",token);
      }
    if (LocaleCompare("affine",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        affine.sx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,extent,token);
        if (*token == ',')
          GetNextToken(q,&q,extent,token);
        affine.rx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,extent,token);
        if (*token == ',')
          GetNextToken(q,&q,extent,token);
        affine.ry=StringToDouble(token,&next_token);
        GetNextToken(q,&q,extent,token);
        if (*token == ',')
          GetNextToken(q,&q,extent,token);
        affine.sy=StringToDouble(token,&next_token);
        GetNextToken(q,&q,extent,token);
        if (*token == ',')
          GetNextToken(q,&q,extent,token);
        affine.tx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,extent,token);
        if (*token == ',')
          GetNextToken(q,&q,extent,token);
        affine.ty=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("translate",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        affine.tx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,extent,token);
        if (*token == ',')
          GetNextToken(q,&q,extent,token);
        affine.ty=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("rotate",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        affine.rx=StringToDouble(token,&next_token);
        affine.ry=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("scale",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        affine.sx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,extent,token);
        if (*token == ',')
          GetNextToken(q,&q,extent,token);
        affine.sy=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("skewX",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        affine.rx=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("skewY",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        affine.ry=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("path",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        status=DrawPath(image,graphic_context[n],token,exception);
        if (status == MagickFalse)
          break;
        continue;
      }
    if (LocaleCompare("text",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        status=DrawText(image,graphic_context[n],token,exception);
        if (status == MagickFalse)
          break;
        continue;
      }
    if (LocaleCompare("image",keyword) == 0)
      {
        GetNextToken(q,&q,extent,token);
        status=DrawImagePrimitive(image,graphic_context[n],token,exception);
        if (status == MagickFalse)
          break;
        continue;
      }
    ThrowBinaryException(DrawError,"UnrecognizedPrimitive",keyword);
  }