MagickBooleanType
    active,
    status;

  DrawInfo
    **graphic_context;

  PrimitiveInfo
    *primitive_info;

  ssize_t
    n;

  StopInfo
    *stops;

  /*
    Initialize graphics context.
  */
  assert(image != (Image *) NULL);
  assert(image->signature == MagickCoreSignature);
  if (image->debug != MagickFalse)
    (void) LogMagickEvent(DrawEvent,GetMagickModule(),"...");
  assert(draw_info != (DrawInfo *) NULL);
  assert(draw_info->signature == MagickCoreSignature);
  assert(exception != (ExceptionInfo *) NULL);
  assert(exception->signature == MagickCoreSignature);
  status=MagickTrue;
  stops=(StopInfo *) NULL;
  primitive_info=(PrimitiveInfo *) NULL;
  token=AcquireString(draw_info->primitive);
  primitive=AcquireString(draw_info->primitive);
  graphic_context=(DrawInfo **) AcquireMagickMemory(sizeof(*graphic_context));
  if (graphic_context == (DrawInfo **) NULL)
    ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
      image->filename);
  n=0;
  graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,draw_info);
  GetAffineMatrix(&affine);
  GetAffineMatrix(&current);
  active=MagickFalse;
  for (q=(const char *) primitive; *q != '\0'; )
  {
    /*
      Interpret graphic primitive.
    */
    GetNextToken(q,&q,MagickPathExtent,keyword);
    if (*keyword == '\0')
      break;
    if (*keyword == '#')
      {
        /*
          Comment.
        */
        while ((*q != '\n') && (*q != '\0'))
          q++;
        continue;
      }
    if (LocaleCompare("push",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        if (LocaleCompare("graphic-context",token) == 0)
          {
            n++;
            graphic_context=(DrawInfo **) ResizeMagickMemory(graphic_context,
              (size_t) (n+1)*sizeof(*graphic_context));
            if (graphic_context == (DrawInfo **) NULL)
              ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
                image->filename);
            graphic_context[n]=CloneDrawInfo((ImageInfo *) NULL,
              graphic_context[n-1]);
            continue;
          }
        ThrowBinaryException(DrawError,"UnbalancedPushPop",keyword);
      }
    if (LocaleCompare("pop",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        if (LocaleCompare("graphic-context",token) == 0)
          {
            if (n == 0)
              ThrowBinaryException(DrawError,"UnbalancedPushPop",keyword);
            graphic_context[n]=DestroyDrawInfo(graphic_context[n]);
            n--;
            continue;
          }
        ThrowBinaryException(DrawError,"UnbalancedPushPop",keyword);
      }
    if (LocaleCompare("affine",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.sx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.rx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.ry=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.sy=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.tx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.ty=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("translate",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.tx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.ty=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("rotate",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.rx=StringToDouble(token,&next_token);
        affine.ry=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("scale",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.sx=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.sy=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("skewX",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.rx=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("skewY",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        affine.ry=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("primitive",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        primitive_info=(PrimitiveInfo *) RelinquishMagickMemory(primitive_info);
        primitive_info=(PrimitiveInfo *) AcquireMagickMemory(
          sizeof(*primitive_info));
        if (primitive_info == (PrimitiveInfo *) NULL)
          ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
            image->filename);
        primitive_info->primitive=UndefinedPrimitive;
        primitive_info->coordinates=0;
        primitive_info->method=FloodfillMethod;
        continue;
      }
    if (LocaleCompare("text",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        primitive_info->text=AcquireString(token);
        continue;
      }
    if (LocaleCompare("fill",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) QueryColorCompliance(token,AllCompliance,
          &graphic_context[n]->fill,exception);
        continue;
      }
    if (LocaleCompare("stroke",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) QueryColorCompliance(token,AllCompliance,
          &graphic_context[n]->stroke,exception);
        continue;
      }
    if (LocaleCompare("stroke-width",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->stroke_width=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("font",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) CloneString(&graphic_context[n]->font,token);
        continue;
      }
    if (LocaleCompare("font-size",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->pointsize=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("font-style",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->style=(StyleType) ParseCommandOption(
          MagickStyleOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("font-weight",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->weight=(unsigned long) StringToUnsignedLong(token);
        continue;
      }
    if (LocaleCompare("text-decoration",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->decorate=(DecorationType) ParseCommandOption(
          MagickDecorateOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("text-align",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->align=(AlignType) ParseCommandOption(
          MagickAlignOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("text-antialias",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->text_antialias=IsStringTrue(token);
        continue;
      }
    if (LocaleCompare("clip-path",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) CloneString(&graphic_context[n]->clip_path,token);
        continue;
      }
    if (LocaleCompare("clip-rule",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->clip_rule=(FillRule) ParseCommandOption(
          MagickFillRuleOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("clip-units",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->clip_units=(ClipPathUnits) ParseCommandOption(
          MagickClipPathUnitsOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("fill-rule",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->fill_rule=(FillRule) ParseCommandOption(
          MagickFillRuleOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("fill-opacity",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->fill_opacity=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("stroke-opacity",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->stroke_opacity=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("stroke-linecap",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->linecap=(LineCap) ParseCommandOption(
          MagickLineCapOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("stroke-linejoin",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->linejoin=(LineJoin) ParseCommandOption(
          MagickLineJoinOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("stroke-miterlimit",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->miterlimit=StringToUnsignedLong(token);
        continue;
      }
    if (LocaleCompare("stroke-dasharray",keyword) == 0)
      {
        if (IsPoint(q))
          {
            ssize_t
              k;

            p=q;
            GetNextToken(p,&p,MagickPathExtent,token);
            for (k=0; IsPoint(token); k++)
              GetNextToken(p,&p,MagickPathExtent,token);
            graphic_context[n]->dash_pattern=(double *) AcquireQuantumMemory(
              (size_t) (k+1),sizeof(*graphic_context[n]->dash_pattern));
            if (graphic_context[n]->dash_pattern == (double *) NULL)
              ThrowBinaryException(ResourceLimitError,"MemoryAllocationFailed",
                image->filename);
            for (j=0; j < k; j++)
            {
              GetNextToken(q,&q,MagickPathExtent,token);
              graphic_context[n]->dash_pattern[j]=StringToDouble(token,
                &next_token);
            }
            graphic_context[n]->dash_pattern[j]=0.0;
            continue;
          }
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->dash_pattern=(double *) RelinquishMagickMemory(
          graphic_context[n]->dash_pattern);
        continue;
      }
    if (LocaleCompare("stroke-dashoffset",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->dash_offset=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("gradient-units",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->gradient_units=(GradientUnits) ParseCommandOption(
          MagickGradientUnitsOptions,MagickFalse,token);
        continue;
      }
    if (LocaleCompare("gradient",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) CloneString(&graphic_context[n]->gradient,token);
        continue;
      }
    if (LocaleCompare("pattern",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        (void) CloneString(&graphic_context[n]->pattern,token);
        continue;
      }
    if (LocaleCompare("viewbox",keyword) == 0)
      {
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->viewbox.x=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->viewbox.y=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->viewbox.width=StringToDouble(token,&next_token);
        GetNextToken(q,&q,MagickPathExtent,token);
        graphic_context[n]->viewbox.height=StringToDouble(token,&next_token);
        continue;
      }
    if (LocaleCompare("opacity",keyword) ==