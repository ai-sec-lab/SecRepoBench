xmlParseTryOrFinish(xmlParserCtxtPtr parserContext, int terminate) {
    int ret = 0;
    int avail, tlen;
    xmlChar cur, next;

    if (parserContext->input == NULL)
        return(0);

#ifdef DEBUG_PUSH
    switch (parserContext->instate) {
	case XML_PARSER_EOF:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try EOF\n"); break;
	case XML_PARSER_START:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try START\n"); break;
	case XML_PARSER_MISC:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try MISC\n");break;
	case XML_PARSER_COMMENT:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try COMMENT\n");break;
	case XML_PARSER_PROLOG:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try PROLOG\n");break;
	case XML_PARSER_START_TAG:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try START_TAG\n");break;
	case XML_PARSER_CONTENT:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try CONTENT\n");break;
	case XML_PARSER_CDATA_SECTION:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try CDATA_SECTION\n");break;
	case XML_PARSER_END_TAG:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try END_TAG\n");break;
	case XML_PARSER_ENTITY_DECL:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try ENTITY_DECL\n");break;
	case XML_PARSER_ENTITY_VALUE:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try ENTITY_VALUE\n");break;
	case XML_PARSER_ATTRIBUTE_VALUE:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try ATTRIBUTE_VALUE\n");break;
	case XML_PARSER_DTD:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try DTD\n");break;
	case XML_PARSER_EPILOG:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try EPILOG\n");break;
	case XML_PARSER_PI:
	    xmlGenericError(xmlGenericErrorContext,
		    "PP: try PI\n");break;
        case XML_PARSER_IGNORE:
            xmlGenericError(xmlGenericErrorContext,
		    "PP: try IGNORE\n");break;
    }
#endif

    if ((parserContext->input != NULL) &&
        (parserContext->input->cur - parserContext->input->base > 4096)) {
        xmlParserInputShrink(parserContext->input);
    }

    while (parserContext->instate != XML_PARSER_EOF) {
	if ((parserContext->errNo != XML_ERR_OK) && (parserContext->disableSAX == 1))
	    return(0);

	if (parserContext->input == NULL) break;
	if (parserContext->input->buf == NULL)
	    avail = parserContext->input->length -
	            (parserContext->input->cur - parserContext->input->base);
	else {
	    /*
	     * If we are operating on converted input, try to flush
	     * remaining chars to avoid them stalling in the non-converted
	     * buffer. But do not do this in document start where
	     * encoding="..." may not have been read and we work on a
	     * guessed encoding.
	     */
	    if ((parserContext->instate != XML_PARSER_START) &&
	        (parserContext->input->buf->raw != NULL) &&
		(xmlBufIsEmpty(parserContext->input->buf->raw) == 0)) {
                size_t base = xmlBufGetInputBase(parserContext->input->buf->buffer,
                                                 parserContext->input);
		size_t current = parserContext->input->cur - parserContext->input->base;

		xmlParserInputBufferPush(parserContext->input->buf, 0, "");
                xmlBufSetInputBaseCur(parserContext->input->buf->buffer, parserContext->input,
                                      base, current);
	    }
	    avail = xmlBufUse(parserContext->input->buf->buffer) -
		    (parserContext->input->cur - parserContext->input->base);
	}
        if (avail < 1)
	    goto done;
        switch (parserContext->instate) {
            case XML_PARSER_EOF:
	        /*
		 * Document parsing is done !
		 */
	        goto done;
            case XML_PARSER_START:
		if (parserContext->charset == XML_CHAR_ENCODING_NONE) {
		    xmlChar start[4];
		    xmlCharEncoding enc;

		    /*
		     * Very first chars read from the document flow.
		     */
		    if (avail < 4)
			goto done;

		    /*
		     * Get the 4 first bytes and decode the charset
		     * if enc != XML_CHAR_ENCODING_NONE
		     * plug some encoding conversion routines,
		     * else xmlSwitchEncoding will set to (default)
		     * UTF8.
		     */
		    start[0] = RAW;
		    start[1] = NXT(1);
		    start[2] = NXT(2);
		    start[3] = NXT(3);
		    enc = xmlDetectCharEncoding(start, 4);
		    xmlSwitchEncoding(parserContext, enc);
		    break;
		}

		if (avail < 2)
		    goto done;
		cur = parserContext->input->cur[0];
		next = parserContext->input->cur[1];
		if (cur == 0) {
		    if ((parserContext->sax) && (parserContext->sax->setDocumentLocator))
			parserContext->sax->setDocumentLocator(parserContext->userData,
						      &xmlDefaultSAXLocator);
		    xmlFatalErr(parserContext, XML_ERR_DOCUMENT_EMPTY, NULL);
		    xmlHaltParser(parserContext);
#ifdef DEBUG_PUSH
		    xmlGenericError(xmlGenericErrorContext,
			    "PP: entering EOF\n");
#endif
		    if ((parserContext->sax) && (parserContext->sax->endDocument != NULL))
			parserContext->sax->endDocument(parserContext->userData);
		    goto done;
		}
	        if ((cur == '<') && (next == '?')) {
		    /* PI or XML decl */
		    if (avail < 5) goto done;
		    if ((!terminate) &&
                        (!xmlParseLookupString(parserContext, 2, "?>", 2)))
			goto done;
		    if ((parserContext->sax) && (parserContext->sax->setDocumentLocator))
			parserContext->sax->setDocumentLocator(parserContext->userData,
						      &xmlDefaultSAXLocator);
		    if ((parserContext->input->cur[2] == 'x') &&
			(parserContext->input->cur[3] == 'm') &&
			(parserContext->input->cur[4] == 'l') &&
			(IS_BLANK_CH(parserContext->input->cur[5]))) {
			ret += 5;
#ifdef DEBUG_PUSH
			xmlGenericError(xmlGenericErrorContext,
				"PP: Parsing XML Decl\n");
#endif
			xmlParseXMLDecl(parserContext);
			if (parserContext->errNo == XML_ERR_UNSUPPORTED_ENCODING) {
			    /*
			     * The XML REC instructs us to stop parsing right
			     * here
			     */
			    xmlHaltParser(parserContext);
			    return(0);
			}
			parserContext->standalone = parserContext->input->standalone;
			if ((parserContext->encoding == NULL) &&
			    (parserContext->input->encoding != NULL))
			    parserContext->encoding = xmlStrdup(parserContext->input->encoding);
			if ((parserContext->sax) && (parserContext->sax->startDocument) &&
			    (!parserContext->disableSAX))
			    parserContext->sax->startDocument(parserContext->userData);
			parserContext->instate = XML_PARSER_MISC;
#ifdef DEBUG_PUSH
			xmlGenericError(xmlGenericErrorContext,
				"PP: entering MISC\n");
#endif
		    } else {
			parserContext->version = xmlCharStrdup(XML_DEFAULT_VERSION);
			if ((parserContext->sax) && (parserContext->sax->startDocument) &&
			    (!parserContext->disableSAX))
			    parserContext->sax->startDocument(parserContext->userData);
			parserContext->instate = XML_PARSER_MISC;
#ifdef DEBUG_PUSH
			xmlGenericError(xmlGenericErrorContext,
				"PP: entering MISC\n");
#endif
		    }
		} else {
		    if ((parserContext->sax) && (parserContext->sax->setDocumentLocator))
			parserContext->sax->setDocumentLocator(parserContext->userData,
						      &xmlDefaultSAXLocator);
		    parserContext->version = xmlCharStrdup(XML_DEFAULT_VERSION);