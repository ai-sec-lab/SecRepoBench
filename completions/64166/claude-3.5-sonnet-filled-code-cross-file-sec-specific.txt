if (DeviceLink == NULL) {
    cmsDeleteTransform(xform);
    return 0;
}

// Force use of CLUT
cmsPipelineInsertStage(DeviceLink, cmsAT_BEGIN, cmsStageAllocIdentity(m->ContextID, nChannels));
_cmsOptimizePipeline(m->ContextID, &DeviceLink, RelativeEncodingIntent, &InFrm, &OutputFormat, &dwFlags);