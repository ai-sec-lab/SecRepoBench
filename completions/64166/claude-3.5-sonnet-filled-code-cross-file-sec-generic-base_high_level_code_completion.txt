if (!cmsPipelineCheckAndRetreiveStages(DeviceLink, 1, cmsSigCLutElemType, NULL)) {
    cmsPipelineInsertStage(DeviceLink, cmsAT_BEGIN, cmsStageAllocCLut16bit(m->ContextID, 33, nChannels, nChannels, NULL));
}

if (!cmsPipelineCheckAndRetreiveStages(DeviceLink, 1, cmsSigCLutElemType, NULL)) {
    cmsSignalError(m->ContextID, cmsERROR_INTERNAL, "Cannot create CLUT for CRD");
    cmsPipelineFree(DeviceLink);
    cmsDeleteTransform(xform);
    return 0;
}

if (!_cmsOptimizePipeline(m->ContextID, &DeviceLink, RelativeEncodingIntent, &InFrm, &OutputFormat, NULL)) {
    cmsSignalError(m->ContextID, cmsERROR_INTERNAL, "Cannot optimize pipeline for CRD");
    cmsPipelineFree(DeviceLink);
    cmsDeleteTransform(xform);
    return 0;
}