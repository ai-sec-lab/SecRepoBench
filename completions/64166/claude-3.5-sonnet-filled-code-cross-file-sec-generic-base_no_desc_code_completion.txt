if (DeviceLink == NULL) {
    cmsSignalError(m->ContextID, cmsERROR_INTERNAL, "Failed to duplicate device link");
    cmsDeleteTransform(xform);
    return 0;
}

// Optimize the device link
cmsPipelineOptimize(DeviceLink, RelativeEncodingIntent, &m->ContextID);

// Check if the optimized pipeline is a matrix-shaper
cmsStage* Matrix = NULL;
cmsStage* Shaper = NULL;
if (cmsPipelineCheckAndRetreiveStages(DeviceLink, 2, cmsSigCurveSetElemType, cmsSigMatrixElemType, &Shaper, &Matrix)) {
    // If it's a matrix-shaper, we can write it more efficiently
    if (!WriteInputMatrixShaper(m, hProfile, Matrix, Shaper)) {
        cmsPipelineFree(DeviceLink);
        cmsDeleteTransform(xform);
        return 0;
    }
} else {
    // Otherwise, write it as a regular LUT
    if (!WriteInputLUT(m, hProfile, RelativeEncodingIntent, dwFlags)) {
        cmsPipelineFree(DeviceLink);
        cmsDeleteTransform(xform);
        return 0;
    }
}