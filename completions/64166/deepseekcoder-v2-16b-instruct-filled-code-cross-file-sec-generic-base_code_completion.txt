// Check if the DeviceLink is NULL and deletes the transform if it is.
    // If the DeviceLink exists, it forces the use of a CLUT by setting the cmsFLAGS_FORCE_CLUT flag.
    // Proceeds to optimize the pipeline for color rendering using the _cmsOptimizePipeline function.
    if (DeviceLink == NULL) {
        cmsDeleteTransform(xform);
        return 0;
    } else {
        cmsSetRenderIntent(DeviceLink, Intent, 0);
        _cmsOptimizePipeline(DeviceLink, 0);
    }

    // Emit headers, etc.
    EmitWhiteBlackD50(m, &BlackPointAdaptedToD50);
    EmitPQRStage(m, hProfile, lDoBPC, Intent == INTENT_ABSOLUTE_COLORIMETRIC);
    EmitXYZ2Lab(m);

    // FIXUP: map Lab (100, 0, 0) to perfect white, because the particular encoding for Lab
    // does map a=b=0 not falling into any specific node. Since range a,b goes -128..127,
    // zero is slightly moved towards right, so assure next node (in L=100 slice) is mapped to
    // zero. This would sacrifice a bit of highlights, but failure to do so would cause
    // scum dot. Ouch.

    if (Intent == INTENT_ABSOLUTE_COLORIMETRIC)
            lFixWhite = FALSE;

    _cmsIOPrintf(m, "/RenderTable ");

    first = cmsPipelineGetPtrToFirstStage(DeviceLink);
    if (first != NULL) {
        WriteCLUT(m, first, "<", ">\n", "", "", lFixWhite, ColorSpace);
    }

    _cmsIOPrintf(m, " %d {} bind ", nChannels);

    for (i=1; i < nChannels; i++)
            _cmsIOPrintf(m, "dup ");

    _cmsIOPrintf(m, "]\n");

    EmitIntent(m, Intent);

    _cmsIOPrintf(m, ">>\n");

    if (!(dwFlags & cmsFLAGS_NODEFAULTRESOURCEDEF)) {

        _cmsIOPrintf(m, "/Current exch /ColorRendering defineresource pop\n");
    }

    cmsPipelineFree(DeviceLink);
    cmsDeleteTransform(xform);