if (size < 8)
    return 0;
if (i + size > p->buf_size)
    return 0;