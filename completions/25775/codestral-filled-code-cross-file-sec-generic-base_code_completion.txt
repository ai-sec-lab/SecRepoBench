if (size < 8 || i + size > p->buf_size) {
    return 0;
}
i += 8;