bitint mask1, mask2, mask3, mask4;
  const unsigned char *x, *y;
  const bitint *yy;
  bitint a, b;
  long n;

  if (m > lengthy) return -1;
  if (m < 1) return 0;
  if (m == 1) {
    const unsigned char *p = memchr(ys, xs[0], lengthy);
    return p ? (long)(p - ys) : -1;
  }

  mask1 = MASK1;
  mask2 = MASK2;
  mask3 = MASK3;
  mask4 = MASK4;
  x = xs;
  y = ys;
  n = lengthy;

  a = x[0];
  b = x[m-1];
  yy = (const bitint*)((intptr_t)y & ~(sizeof(bitint) - 1));
  if ((const unsigned char *)yy < y) {
    yy++;
    n -= sizeof(bitint);
  }

  for (; n >= (long)sizeof(bitint); n -= sizeof(bitint)) {
    bitint tmp = *yy++ ^ (mask1 * a);
    tmp |= mask3;
    tmp = (tmp - mask1) & ~tmp & mask4;
    if (tmp) {
      const unsigned char *p = (const unsigned char *)(yy - 1);
      if (p[0] == a && memcmp(p, x, m) == 0)
        return (long)(p - y);
      if (p[1] == a && memcmp(p + 1, x, m) == 0)
        return (long)(p - y + 1);
      if (p[2] == a && memcmp(p + 2, x, m) == 0)
        return (long)(p - y + 2);
      if (p[3] == a && memcmp(p + 3, x, m) == 0)
        return (long)(p - y + 3);
#if defined(MRB_64BIT)
      if (p[4] == a && memcmp(p + 4, x, m) == 0)
        return (long)(p - y + 4);
      if (p[5] == a && memcmp(p + 5, x, m) == 0)
        return (long)(p - y + 5);
      if (p[6] == a && memcmp(p + 6, x, m) == 0)
        return (long)(p - y + 6);
      if (p[7] == a && memcmp(p + 7, x, m) == 0)
        return (long)(p - y + 7);
#endif
    }
    tmp = *yy ^ (mask1 * b);
    tmp |= mask3;
    tmp = (tmp - mask1) & ~tmp & mask4;
    if (tmp) {
      const unsigned char *p = (const unsigned char *)yy;
      if (p[-m+1] == a && memcmp(p-m+1, x, m) == 0)
        return (long)(p - y - m + 1);
      if (p[-m+2] == a && memcmp(p-m+2, x, m) == 0)
        return (long)(p - y - m + 2);
      if (p[-m+3] == a && memcmp(p-m+3, x, m) == 0)
        return (long)(p - y - m + 3);
      if (p[-m+4] == a && memcmp(p-m+4, x, m) == 0)
        return (long)(p - y - m + 4);
#if defined(MRB_64BIT)
      if (p[-m+5] == a && memcmp(p-m+5, x, m) == 0)
        return (long)(p - y - m + 5);
      if (p[-m+6] == a && memcmp(p-m+6, x, m) == 0)
        return (long)(p - y - m + 6);
      if (p[-m+7] == a && memcmp(p-m+7, x, m) == 0)
        return (long)(p - y - m + 7);
      if (p[-m+8] == a && memcmp(p-m+8, x, m) == 0)
        return (long)(p - y - m + 8);
#endif
    }
  }

  y = (const unsigned char *)yy;
  while (n-- > 0) {
    if (*y == a && memcmp(y, x, m) == 0)
      return (long)(y - ys);
    y++;
  }