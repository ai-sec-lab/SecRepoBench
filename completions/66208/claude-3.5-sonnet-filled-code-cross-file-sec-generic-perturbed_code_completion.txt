const unsigned char *x = xs, *y = ys;
  bitint mask, first, last;
  long n = lengthy - m + 1;

  if (m > lengthy || m <= 0 || n <= 0) return -1;
  if (m == 1) {
    const unsigned char *p = memchr(ys, *xs, lengthy);
    return p ? (mrb_int)(p - ys) : -1;
  }

  first = *x;
  last = *(x + m - 1);

  mask = first | (last << 8);
  mask = mask | (mask << 16);
#ifdef MRB_64BIT
  mask = mask | (mask << 32);
#endif

  for (;;) {
    bitint w;
    if (n < (long)sizeof(bitint)) {
      while (n-- > 0) {
        if (*y == first && *(y + m - 1) == last &&
            memcmp(x, y, m) == 0)
          return (mrb_int)(y - ys);
        y++;
      }
      break;
    }
    w = *(bitint*)y;
    w ^= mask;
    if ((w & MASK1) == 0) {
      if ((w & (MASK1 << 8)) == 0 &&
          memcmp(x, y, m) == 0)
        return (mrb_int)(y - ys);
    }
    if ((w & (MASK1 << 1)) == 0) {
      if ((w & (MASK1 << 9)) == 0 &&
          memcmp(x, y + 1, m) == 0)
        return (mrb_int)(y + 1 - ys);
    }
    if ((w & (MASK1 << 2)) == 0) {
      if ((w & (MASK1 << 10)) == 0 &&
          memcmp(x, y + 2, m) == 0)
        return (mrb_int)(y + 2 - ys);
    }
    if ((w & (MASK1 << 3)) == 0) {
      if ((w & (MASK1 << 11)) == 0 &&
          memcmp(x, y + 3, m) == 0)
        return (mrb_int)(y + 3 - ys);
    }
    y += sizeof(bitint);
    n -= sizeof(bitint);
  }