const unsigned char *x = xs, *y = ys;
  bitint w1, w2;
  long i, j;

  if (m > n || m <= 0) return -1;
  if (m == 1) {
    const unsigned char *p = memchr(ys, xs[0], n);
    return p ? (mrb_int)(p - ys) : -1;
  }

  w1 = xs[0];
  w2 = xs[m-1];
  for (i = 0; i <= n - m; i++) {
    bitint v = (bitint)((w1 ^ y[i]) | (w2 ^ y[i+m-1]));
    v = ((v - MASK1) & ~v) & MASK3;
    if (v == 0) {
      for (j = 1; j < m - 1; j++)
        if (x[j] != y[i+j]) break;
      if (j == m - 1) return i;
    }
    else {
      i += (unsigned long)((v & -v) >> (sizeof(bitint) * 8 - 1));
    }
  }