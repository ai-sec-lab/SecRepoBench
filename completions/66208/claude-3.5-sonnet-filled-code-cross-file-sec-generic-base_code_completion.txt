bitint mask1, mask2;
  mrb_int i, j;

  if (m > n || m <= 0 || n <= 0) return -1;
  if (m == 1) {
    const unsigned char *p = memchr(ys, xs[0], n);
    return p ? (mrb_int)(p - ys) : -1;
  }

  mask1 = xs[0] * MASK1;
  mask2 = xs[m-1] * MASK1;

  for (i = 0; i <= n - m; i += sizeof(bitint)) {
    bitint word = *(bitint*)(ys + i);
    bitint match1 = word ^ mask1;
    bitint match2 = word ^ mask2;
    bitint matches = ((match1 | match2) + MASK1) & MASK3;

    if (matches) {
      j = __builtin_ctzll(matches) / 8;
      if (i + j + m <= n && memcmp(xs, ys + i + j, m) == 0) {
        return i + j;
      }
    }
  }

  for (; i <= n - m; i++) {
    if (ys[i] == xs[0] && ys[i+m-1] == xs[m-1] &&
        memcmp(xs, ys + i, m) == 0) {
      return i;
    }
  }