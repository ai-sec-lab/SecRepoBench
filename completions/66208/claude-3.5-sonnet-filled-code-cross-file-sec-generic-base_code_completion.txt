const unsigned char *x = xs, *xe = xs + m;
  const unsigned char *y = ys;
  const bitint *yb;
  bitint mask;

  if (m <= 0 || n < m) return -1;
  if (m == 1) {
    const unsigned char *ys_end = ys + n;
    while (y < ys_end) {
      if (*y == *x) return (mrb_int)(y - ys);
      y++;
    }
    return -1;
  }

  yb = (const bitint*)((intptr_t)y & ~(sizeof(bitint) - 1));
  mask = (bitint)0;
  for (int i = 0; i < sizeof(bitint); i++) {
    mask = (mask << 8) | *x;
  }

  while ((const unsigned char*)yb < ys + n - m + 1) {
    bitint word = *yb ^ mask;
    bitint masked = ((word & MASK2) + MASK1) & MASK3;
    if (masked) {
      y = (const unsigned char*)yb;
      if (y[0] == x[0] && y[m-1] == xe[-1]) {
        const unsigned char *xp = x + 1, *yp = y + 1;
        while (xp < xe && *xp == *yp) {
          xp++;
          yp++;
        }
        if (xp == xe) return (mrb_int)(y - ys);
      }
      y += sizeof(bitint);
    } else {
      y = (const unsigned char*)(yb + 1);
    }
    yb = (const bitint*)((intptr_t)y & ~(sizeof(bitint) - 1));
  }

  y = (const unsigned char*)yb;
  while (y <= ys + n - m) {
    if (y[0] == x[0] && y[m-1] == xe[-1]) {
      const unsigned char *xp = x + 1, *yp = y + 1;
      while (xp < xe && *xp == *yp) {
        xp++;
        yp++;
      }
      if (xp == xe) return (mrb_int)(y - ys);
    }
    y++;
  }