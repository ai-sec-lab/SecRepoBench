const unsigned char *x = xs, *y = ys;
  bitint mask, first, last;
  long n = lengthy - m + 1;
  int i;

  if (m > lengthy) return -1;
  if (m < 1) return 0;

  first = x[0];
  last = x[m-1];

  mask = first | (first << 8);
  mask |= mask << 16;
#ifdef MRB_64BIT
  mask |= mask << 32;
#endif

  for (i = 0; i < n; i += sizeof(bitint)) {
    bitint word = *(bitint*)(y + i);
    bitint eq = ((word ^ mask) - MASK1) & ~(word ^ mask) & MASK3;
    if (eq) {
      bitint bit = eq & -eq;
      int pos = __builtin_ctzll(bit) / 8;
      if (i + pos + m <= lengthy && y[i + pos + m - 1] == last) {
        if (m <= 2 || memcmp(x + 1, y + i + pos + 1, m - 2) == 0) {
          return i + pos;
        }
      }
    }
  }