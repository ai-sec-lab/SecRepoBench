bitint *p1 = (bitint*)ys;
  bitint *p2 = (bitint*)(ys + n - m);
  bitint first = xs[0];
  bitint last = xs[m-1];
  bitint mask1 = first * MASK1;
  bitint mask2 = last * MASK1;

  for (; p1 <= p2; p1++) {
    bitint v = *p1;
    bitint t1 = v ^ mask1;
    bitint t2 = v ^ mask2;
    bitint t3 = ((t1 & MASK2) + MASK1) | t1 | MASK3;
    bitint t4 = ((t2 & MASK2) + MASK1) | t2 | MASK3;
    bitint t = t3 & t4;

    if (t != MASK3) {
      const unsigned char *p = (const unsigned char *)p1;
      if (p[0] == first && p[m-1] == last) {
        for (int i = 1; i < m-1; i++) {
          if (p[i] != xs[i]) goto next;
        }
        return p - ys;
      }
    next:;
    }
  }