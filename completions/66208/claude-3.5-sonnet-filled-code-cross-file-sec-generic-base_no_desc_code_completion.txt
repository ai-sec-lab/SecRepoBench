const unsigned char *x = xs, *xe = xs + m;
  const unsigned char *y = ys, *ye = ys + n;
  bitint mask;
  int i;

  if (m > n || m <= 0 || n <= 0)
    return -1;

  mask = 0;
  for (i = 0; i < m; i++)
    mask |= (bitint)x[i] << (i * 8);

  for (; y + m <= ye; y++) {
    bitint val = *(bitint*)y;
    if (((val - MASK1) & ~val & MASK3) == 0) {
      if (((val ^ mask) & MASK2) == 0) {
        for (i = 0; i < m; i++)
          if (x[i] != y[i]) break;
        if (i == m) return (mrb_int)(y - ys);
      }
    }
  }