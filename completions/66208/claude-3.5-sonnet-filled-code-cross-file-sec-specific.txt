const unsigned char *x = xs, *xe = xs + m;
  const unsigned char *y = ys;
  const unsigned char *ye = ys + n;
  bitint mask;

  if (m > n || m == 0) return -1;
  if (m == 1) {
    unsigned char c = *xs;
    for (; y < ye; ++y) {
      if (*y == c) return y - ys;
    }
    return -1;
  }

  mask = (bitint)0;
  for (int i = 0; i < sizeof(bitint); ++i) {
    mask = (mask << 8) | *x;
  }
  mask = (mask << 8) | *(xe - 1);

  while (y + m <= ye) {
    bitint word = *(bitint*)y;
    bitint xor = word ^ mask;
    bitint eq = ((xor & MASK2) + MASK1) | xor | MASK3;
    if ((eq & MASK4) == 0) {
      if (memcmp(x, y, m) == 0) return y - ys;
    }
    y++;
  }