case ETH_P_MPLS_UNI:
  case ETH_P_MPLS_MULTI:
    /* MPLS packet */
    network_flow->stats.mpls_count++;

    /*
     * Iterate through the MPLS labels until we reach
     * the one with the Bottom-Of-Stack (S) bit set.
     * Each MPLS shim header is 4 bytes long.
     */
    do {
      /* Safety check: ensure we still have 4 bytes to read */
      if(((bpf_u_int32)ip_offset + 4) > header->caplen)
        return(nproto); /* Truncated MPLS header */

      /* Read current label and convert endianess */
      mpls.u32 = ntohl(*((u_int32_t*)&packet[ip_offset]));

      /* Advance to next possible label/payload */
      ip_offset += 4;
    } while((mpls.u32 & 0x100) == 0); /* While Bottom-Of-Stack bit is not set */

    /* Assume IP follows MPLS */
    type         = ETH_P_IP;
    recheck_type = 1;
    break;