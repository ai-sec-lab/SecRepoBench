linesize   = s->current_picture.f->linesize[0] << field_based;
uvlinesize = s->current_picture.f->linesize[1] << field_based;

mx = motion_x >> 1;
my = motion_y >> 1;
sx = motion_x & 1;
sy = motion_y & 1;

src_x = s->mb_x * 2 * block_s + (mx >> lowres);
src_y = (mb_y * 2 * block_s >> field_based) + (my >> lowres);
uvsrc_x = s->mb_x * block_s + (mx >> (lowres + 1));
uvsrc_y = (mb_y * block_s >> field_based) + (my >> (lowres + 1));

src_x = av_clip(src_x, -16, s->width + 1);
if (src_x == s->width)
    sx = 0;
src_y = av_clip(src_y, -16, s->height + 1);
if (src_y == s->height)
    sy = 0;

if (sx || sy) {
    ptr_y  = ref_picture[0] + src_y * linesize + src_x;
    ptr_cb = ref_picture[1] + uvsrc_y * uvlinesize + uvsrc_x;
    ptr_cr = ref_picture[2] + uvsrc_y * uvlinesize + uvsrc_x;

    if ((unsigned)src_x > FFMAX(h_edge_pos - (!!sx) - 2 * block_s, 0) ||
        (unsigned)src_y > FFMAX(v_edge_pos - (!!sy) - h, 0)) {
        s->vdsp.emulated_edge_mc(s->sc.edge_emu_buffer, ptr_y,
                                 linesize, linesize,
                                 17, 17 + field_based,
                                 src_x, src_y << field_based,
                                 h_edge_pos, v_edge_pos);
        ptr_y = s->sc.edge_emu_buffer;
        if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
            uint8_t *ubuf = s->sc.edge_emu_buffer + 18 * s->linesize;
            uint8_t *vbuf = ubuf + 9 * s->uvlinesize;
            s->vdsp.emulated_edge_mc(ubuf, ptr_cb,
                                     uvlinesize, uvlinesize,
                                     9, 9 + field_based,
                                     uvsrc_x, uvsrc_y << field_based,
                                     h_edge_pos >> 1, v_edge_pos >> 1);
            s->vdsp.emulated_edge_mc(vbuf, ptr_cr,
                                     uvlinesize, uvlinesize,
                                     9, 9 + field_based,
                                     uvsrc_x, uvsrc_y << field_based,
                                     h_edge_pos >> 1, v_edge_pos >> 1);
            ptr_cb = ubuf;
            ptr_cr = vbuf;
        }
    }

    if (!field_based) {
        s->hdsp.put_pixels_tab[0][0](dest_y, ptr_y, linesize, h);
    } else {
        s->hdsp.put_pixels_tab[0][1](dest_y, ptr_y, linesize, h);
        s->hdsp.put_pixels_tab[0][1](dest_y + s->linesize,
                                     ptr_y + linesize, linesize, h);
    }

    if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
        pix_op[op_index](dest_cb, ptr_cb, uvlinesize, h >> s->chroma_y_shift);
        pix_op[op_index](dest_cr, ptr_cr, uvlinesize, h >> s->chroma_y_shift);
    }
} else {
    if (!field_based) {
        s->hdsp.put_pixels_tab[0][0](dest_y, ref_picture[0] + src_y * linesize + src_x,
                                     linesize, h);
    } else {
        s->hdsp.put_pixels_tab[0][1](dest_y, ref_picture[0] + src_y * linesize + src_x,
                                     linesize, h);
        s->hdsp.put_pixels_tab[0][1](dest_y + s->linesize,
                                     ref_picture[0] + (src_y + 1) * linesize + src_x,
                                     linesize, h);
    }

    if (!CONFIG_GRAY || !(s->avctx->flags & AV_CODEC_FLAG_GRAY)) {
        pix_op[op_index](dest_cb, ref_picture[1] + uvsrc_y * uvlinesize + uvsrc_x,
                         uvlinesize, h >> s->chroma_y_shift);
        pix_op[op_index](dest_cr, ref_picture[2] + uvsrc_y * uvlinesize + uvsrc_x,
                         uvlinesize, h >> s->chroma_y_shift);
    }
}