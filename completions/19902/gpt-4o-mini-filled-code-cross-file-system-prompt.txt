char *buf = (char *)malloc(len + 1);
  if (buf == NULL) {
    mrb_raisef(mrb, E_RUNTIME_ERROR, "memory allocation failed");
  }

  // Step 1: Trim leading whitespace
  while (len > 0 && isspace((unsigned char)*s)) {
    s++;
    len--;
  }

  // Step 2: Check for hexadecimal prefixes
  if (len >= 2 && (s[0] == '0' && (s[1] == 'x' || s[1] == 'X'))) {
    s += 2;
    len -= 2;
    // Handle hexadecimal conversion if needed
  }

  // Step 3: Prepare buffer for cleaned input
  char *p = buf;
  const char *end = s + len;
  while (s < end) {
    if (isdigit((unsigned char)*s) || *s == '.' || *s == '-' || *s == '+') {
      *p++ = *s;
    } else if (*s != '_') {
      // Invalid character found
      if (badcheck) {
        free(buf);
        goto bad;
      }
    }
    s++;
  }
  *p = '\0';

  // Step 6: Convert to double
  double d = strtod(buf, &end);
  free(buf);