char buf[64];
  char *p, *n, *pend;
  double d;
  char *end;
  size_t blen = len;
  if (blen >= sizeof(buf)) blen = sizeof(buf) - 1;
  p = (char *)s;
  pend = p + len;
  n = buf;
  while (p < pend && ISSPACE(*p)) p++;
  if (p + 2 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    p += 2;
  }
  while (p < pend) {
    if (ISDIGIT(*p) || *p == '.') {
      *n++ = *p;
    } else if (*p == '_') {
      if (n == buf || !ISDIGIT(*(n-1))) goto nocopy;
    } else {
      goto nocopy;
    }
    p++;
  }