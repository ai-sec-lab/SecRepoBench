const char *p = s;
char buf[64], *n = buf;
const char *pend = s + len;
char *end;
double d;

while (p < pend && ISSPACE(*p)) p++;
if (p < pend && (*p == '+' || *p == '-')) *n++ = *p++;
if (p + 2 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  *n++ = '0';
  *n++ = p[1];
  p += 2;
  while (p < pend && ISXDIGIT(*p)) *n++ = *p++;
}
else {
  while (p < pend) {
    if (ISDIGIT(*p) || *p == '.') {
      *n++ = *p++;
    }
    else if (*p == '_' && n > buf && ISDIGIT(*(n-1)) &&
             p + 1 < pend && ISDIGIT(*(p+1))) {
      p++;
    }
    else {
      break;
    }
    if (n >= buf + sizeof(buf) - 1) goto nocopy;
  }
}
if (p < pend && (*p == 'e' || *p == 'E')) {
  *n++ = *p++;
  if (p < pend && (*p == '+' || *p == '-')) *n++ = *p++;
  while (p < pend && ISDIGIT(*p)) *n++ = *p++;
}