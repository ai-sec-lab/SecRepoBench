// 3. Prepare a buffer to store cleaned input by removing underscores between digits.
  // 4. Iterate over the string, copying valid characters to the buffer.
  // 5. Handle null byte termination, and check for formatting errors when 'badcheck' is true.
  // 6. Convert the cleaned string in the buffer to a double using a library function.
  // 7. Return the parsed double value.
  for (; s < len; s++) {
    if (*s == '_') continue;
    if (p < pend) *p++ = *s;
  }
  *pend = '\0';
  if (badcheck && *pend) goto bad;
  return mrb_str_to_dbl(state, buf, pend - buf);