// <MASK>
  // 3. Prepare a buffer to store cleaned input by removing underscores between digits.
  // 4. Iterate over the string, copying valid characters to the buffer.
  // 5. Handle null byte termination, and check for formatting errors when 'badcheck' is true.
  // 6. Convert the cleaned string in the buffer to a double using a library function.
  // 7. Return the parsed double value.
  char buf[1024]; // buffer to store cleaned input
  char *p = buf;
  char *pend = buf + sizeof(buf) - 1;
  char *n = pend;
  mrb_int d;

  // 3. Prepare a buffer to store cleaned input by removing underscores between digits.
  // 4. Iterate over the string, copying valid characters to the buffer.
  while (p < pend && *s) {
    if (*s == '_') {
      s++;
      continue;
    }
    if (ISSPACE(*s)) {
      s++;
      continue;
    }
    if (ISDIGIT(*s)) {
      *p++ = *s++;
      continue;
    }
    if (ISALPHA(*s)) {
      *p++ = *s++;
      continue;
    }
    if (ISXDIGIT(*s)) {
      *p++ = *s++;
      continue;
    }
    if (ISPLUS(*s) || ISSUB(*s)) {
      *p++ = *s++;
      continue;
    }
    if (*s == '.') {
      *p++ = *s++;
      continue;
    }
    if (*s == 'e' || *s == 'E') {
      *p++ = *s++;
      continue;
    }
    if (*s == 'f' || *s == 'F') {
      *p++ = *s++;
      continue;
    }
    if (*s == 'l' || *s == 'L') {
      *p++ = *s++;
      continue;
    }
    if (*s == 'u' || *s == 'U') {
      *p++ = *s++;
      continue;
    }
    if (*s == 'x' || *s == 'X') {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISPLUS(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    if (*s == '0' && (p - buf == 1 || (p - buf == 2 && ISSUB(*s + 1)))) {
      *p++ = *s++;
      continue;
    }
    i