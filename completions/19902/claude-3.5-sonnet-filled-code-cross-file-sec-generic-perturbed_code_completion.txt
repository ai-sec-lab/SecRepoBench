const char *p = s;
char *buf, *n;
const char *pend = s + len;
char *end;
double d;

while (p < pend && ISSPACE(*p)) p++;

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    return mrb_float_read(p, NULL);
}

buf = mrb_malloc(state, len + 1);
n = buf;

while (p < pend) {
    if (*p == '_') {
        p++;
        continue;
    }
    if (n >= buf + len) {
        mrb_free(state, buf);
        if (badcheck) goto bad;
        return 0.0;
    }
    *n++ = *p++;
}

if (n == buf) {
    mrb_free(state, buf);
    if (badcheck) goto bad;
    return 0.0;
}