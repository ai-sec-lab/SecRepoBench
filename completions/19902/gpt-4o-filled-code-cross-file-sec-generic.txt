const char *p = s;
  const char *pend = s + len;
  char buf[256];
  char *n = buf;
  double d;
  const char *end;

  // Step 1: Trim leading whitespace
  while (p < pend && ISSPACE(*p)) p++;

  // Step 2: Handle hexadecimal prefixes
  if (p + 2 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
    p += 2;
    while (p < pend && ISXDIGIT(*p)) {
      *n++ = *p++;
    }
    goto nocopy;
  }

  // Step 3 & 4: Remove underscores and copy valid characters
  while (p < pend) {
    if (*p == '_') {
      p++;
      continue;
    }
    if (!ISDIGIT(*p) && *p != '.' && *p != 'e' && *p != 'E' && *p != '+' && *p != '-') {
      break;
    }
    *n++ = *p++;
  }