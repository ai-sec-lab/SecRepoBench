char buf[64], *p, *pend, *end;
double d;

if (len >= sizeof(buf)) {
  p = (char*)mrb_malloc(mrb, len + 1);
  pend = p + len;
  memcpy(p, s, len);
  p[len] = '\0';
}
else {
  p = buf;
  pend = buf + len;
  memcpy(p, s, len);
  buf[len] = '\0';
}

if (p == pend) {
  if (badcheck) goto bad;
  return 0.0;
}

if (p[0] == '+' || p[0] == '-') p++;
if (p == pend) {
  if (badcheck) goto bad;
  return 0.0;
}

if ((p[0] == 'i' || p[0] == 'I') &&
    (p[1] == 'n' || p[1] == 'N') &&
    (p[2] == 'f' || p[2] == 'F')) {
  if (s[0] == '-') return -INFINITY;
  return INFINITY;
}

if ((p[0] == 'n' || p[0] == 'N') &&
    (p[1] == 'a' || p[1] == 'A') &&
    (p[2] == 'n' || p[2] == 'N')) {
  return NAN;
}

if (p == pend) {
  if (badcheck) goto bad;
  return 0.0;
}

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
  if (p == pend) {
    if (badcheck) goto bad;
    return 0.0;
  }
}

while (p < pend && ISSPACE(*p)) p++;
if (p == pend) {
  if (badcheck) goto bad;
  return 0.0;
}

if (p == pend) {
  if (badcheck) goto bad;
  return 0.0;
}

if (p + 1 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
}

char *n = pend - 1;
while (n > p && ISSPACE(*n)) n--;
n++;