const char *p = s;
char buf[64], *n = buf;
const char *pend = s + len;
char *end;
double d;

while (p < pend && ISSPACE(*p)) p++;

if (p + 2 < pend && p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
  while (p < pend && ISXDIGIT(*p)) {
    if (n < buf + sizeof(buf) - 1) *n++ = *p;
    p++;
  }
  *n = '\0';
  return mrb_float_read(buf, NULL);
}

while (p < pend) {
  char c = *p++;
  if (c == '_') continue;
  if (!((c >= '0' && c <= '9') || c == '.' || c == 'e' || c == 'E' || c == '-' || c == '+')) {
    if (badcheck) goto bad;
    break;
  }
  if (n < buf + sizeof(buf) - 1) *n++ = c;
}

if (n == buf) {
  if (badcheck) goto bad;
  return 0.0;
}