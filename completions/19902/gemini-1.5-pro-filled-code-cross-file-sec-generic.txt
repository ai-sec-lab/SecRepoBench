const char *p = s;
  const char *pend = p + len;
  char *n;
  char *end;
  double d;
  char buf[MRB_DOUBLE_SPRINTF_BUFFER_SIZE];

  /* skip leading spaces */
  while (p < pend && ISSPACE(*p)) {
    p++;
  }
  if (p >= pend) {
    if (badcheck) goto bad;
    return 0.0;
  }

  /* check sign */
  if (*p == '-') {
    p++;
  }
  else if (*p == '+') {
    p++;
  }

  /* skip leading zeros */
  while (p < pend && *p == '0') {
    p++;
  }

  /* hexadecimal */
  if (p + 1 < pend && *p == '0' && (p[1] == 'x' || p[1] == 'X')) {
    return mrb_hex_str_len_to_dbl(mrb, p+2, pend-(p+2), badcheck);
  }

  /* copy to buffer with replacing underbar */
  n = buf;
  while (p < pend && (ISALNUM(*p) || *p == '.' || *p == '_')) {
    if (*p != '_') {
      if (n - buf >= MRB_DOUBLE_SPRINTF_BUFFER_SIZE - 1) {
        if (badcheck) goto bad;
        break;
      }
      *n++ = *p;
    }
    p++;
  }