const char *p = s;
  const char *pend = s + len;
  char buf[256]; // Ensure the buffer is large enough for typical use cases
  char *n = buf;

  // Trim leading whitespace
  while (p < pend && ISSPACE(*p)) p++;

  // Check for hexadecimal prefix
  if (p + 1 < pend && *p == '0' && (*(p + 1) == 'x' || *(p + 1) == 'X')) {
    p += 2;
  }

  // Copy valid characters to buffer, removing underscores
  while (p < pend && n < buf + sizeof(buf) - 1) {
    if (*p != '_') {
      *n++ = *p;
    }
    p++;
  }

  // Ensure buffer is null-terminated
  *n = '\0';
  p = buf;
  pend = n;