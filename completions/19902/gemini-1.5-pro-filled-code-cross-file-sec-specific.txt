const char *end;
  char *p, *pend;
  double d;
  size_t i, len_trimmed;
  char *buf;

  /* skip leading spaces */
  for (i=0; i<len && ISSPACE(s[i]); i++)
    ;
  s += i;
  len_trimmed = len - i;
  if (len_trimmed == 0) return 0.0;

  /* check for inf, nan, infinity */
  if (len_trimmed >= 3) {
    if (!ISASCII(s[0])) goto nocopy;
    switch (s[0]) {
    case 'i': case 'I':
      if (cistrncmp(s+1, "nf", 2) == 0) {
        len_trimmed = 3;
        if (len_trimmed < len && (s[len_trimmed] == 'i' || s[len_trimmed] == 'I')) {
          if (cistrncmp(s+len_trimmed+1, "nity", 4) == 0) {
            len_trimmed = 8;
          }
        }
      }
      break;
    case 'n': case 'N':
      if (cistrncmp(s+1, "an", 2) == 0) {
        len_trimmed = 3;
      }
      break;
    }
    if (len_trimmed == 3 || len_trimmed == 8) {
      buf = (char *)mrb_alloca(mrb, len_trimmed + 1);
      memcpy(buf, s, len_trimmed);
      buf[len_trimmed] = 0;
      goto nocopy;
    }
  }

  if (s[0] == '0' && (s[1] == 'x' || s[1] == 'X')) {
    return mrb_hex_to_dbl(mrb, s, len_trimmed, badcheck);
  }

  buf = (char *)mrb_alloca(mrb, len_trimmed + 1);
  char *n = buf;
  for (i=0; i<len_trimmed; i++) {
    if (s[i] == '_') continue;
    *n++ = s[i];
  }