const char *p = s;
char buf[64];  // Use a fixed-size buffer to prevent stack overflow
char *n = buf;
char *const pend = buf + sizeof(buf) - 1;  // Leave space for null terminator

while (p < s + len && ISSPACE(*p)) p++;

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
  while (p < s + len && ISXDIGIT(*p)) {
    if (n < pend) *n++ = *p;
    p++;
  }
  goto nocopy;
}

while (p < s + len) {
  char c = *p++;
  if (c == '_' && p < s + len && ISDIGIT(*p)) continue;
  if (n < pend) *n++ = c;
}

if (n == buf) {
  if (badcheck) goto bad;
  return 0.0;
}