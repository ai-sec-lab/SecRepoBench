const char *p = s;
char buf[64], *n = buf;
const char *pend = s + len;
char *end;
double d;

while (p<pend && ISSPACE(*p)) p++;
if (p[0]=='0' && (p[1]=='x'||p[1]=='X')) {
  return (double)mrb_str_len_to_inum(mrb, p, pend-p, 16, badcheck);
}
for (;;) {
  if (n >= buf + sizeof(buf) - 1) {
    goto nocopy;
  }
  if (p == pend) {
    *n = '\0';
    break;
  }
  if (*p == '_') {
    p++;
    continue;
  }
  if (!ISDIGIT(*p) && *p != '.' && *p != 'e' && *p != 'E' &&
      *p != '+' && *p != '-') {
    *n = '\0';
    break;
  }
  *n++ = *p++;
}