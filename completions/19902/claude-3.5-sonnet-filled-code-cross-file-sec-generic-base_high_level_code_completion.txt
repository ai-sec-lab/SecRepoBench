const char *p = s;
char buf[64];
char *n = buf + sizeof(buf) - 1;
const char *pend = s + len;
char *end;
double d;

while (p < pend && ISSPACE(*p)) p++;

if (p[0] == '0' && (p[1] == 'x' || p[1] == 'X')) {
  p += 2;
  while (p < pend && ISXDIGIT(*p)) {
    if (n < buf + sizeof(buf) - 1) *n-- = *p;
    p++;
  }
} else {
  mrb_bool seen_dot = FALSE;
  mrb_bool seen_exp = FALSE;

  while (p < pend) {
    if (*p == '_') {
      if (p == s || !ISDIGIT(*(p-1)) || (p+1 == pend) || !ISDIGIT(*(p+1))) {
        if (badcheck) goto bad;
        break;
      }
    } else if (*p == '.') {
      if (seen_dot || seen_exp) {
        if (badcheck) goto bad;
        break;
      }
      seen_dot = TRUE;
    } else if (*p == 'e' || *p == 'E') {
      if (seen_exp) {
        if (badcheck) goto bad;
        break;
      }
      seen_exp = TRUE;
      if (n < buf + sizeof(buf) - 1) *n-- = *p;
      p++;
      if (p < pend && (*p == '-' || *p == '+')) {
        if (n < buf + sizeof(buf) - 1) *n-- = *p;
        p++;
      }
      continue;
    } else if (!ISDIGIT(*p)) {
      if (badcheck) goto bad;
      break;
    }
    if (n < buf + sizeof(buf) - 1) *n-- = *p;
    p++;
  }
}

if (n == buf + sizeof(buf) - 1) {
  if (badcheck) goto bad;
  p = s;
  goto nocopy;
}