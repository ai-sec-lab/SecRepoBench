char *buf = (char *)malloc(len + 1); // Allocate buffer for cleaned input
  if (buf == NULL) {
    mrb_raisef(mrb, E_RUNTIME_ERROR, "memory allocation failed");
  }

  // Step 1: Trim leading whitespace
  while (len > 0 && isspace((unsigned char)*s)) {
    s++;
    len--;
  }

  // Step 2: Check for hexadecimal prefixes
  if (len >= 2 && (s[0] == '0' && (s[1] == 'x' || s[1] == 'X'))) {
    s += 2; // Skip the "0x" or "0X"
    len -= 2;
  }

  // Step 3: Prepare buffer for cleaned input
  char *p = buf;
  const char *end = s + len;
  while (s < end) {
    if (isdigit((unsigned char)*s) || *s == '.' || *s == '-' || *s == '+' || *s == '_') {
      if (*s != '_') { // Skip underscores
        *p++ = *s;
      }
    }
    s++;
  }
  *p = '\0'; // Null-terminate the buffer

  // Step 6: Convert the cleaned string to a double
  double d = strtod(buf, &end);
  free(buf); // Free the allocated buffer

  // Step 5: Check for formatting errors
  if (end == buf) {
    if (badcheck) {
      goto bad;
    }
    return d;
  }

  if (badcheck) {
    while (end < pend && isspace((unsigned char)*end)) end++;
    if (end < pend) goto bad;
  }

  return d;