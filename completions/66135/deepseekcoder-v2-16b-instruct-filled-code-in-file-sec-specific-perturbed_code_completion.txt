unsigned char *) (exif_data+dir_offset);
        }
      if (tag == 0)
        {
          char
            buffer[MagickPathExtent];

          if (format == EXIF_FMT_STRING)
            {
              if (components > 1)
                {
                  size_t
                    j;

                  for (j=0; j < components; j++)
                    {
                      if (j != 0)
                        (void) FormatLocaleString(buffer+strlen(buffer),
                          MagickPathExtent-strlen(buffer),", ");
                      (void) FormatLocaleString(buffer+strlen(buffer),
                        MagickPathExtent-strlen(buffer),p,p+number_bytes);
                      p+=number_bytes;
                    }
                }
              else
                (void) FormatLocaleString(buffer,MagickPathExtent,p,p+number_bytes);
              (void) SetImageProperty((Image *) image,q,buffer,exception);
            }
          else
            {
              if (format == EXIF_FMT_BYTE)
                {
                  if (components > 1)
                    {
                      size_t
                        j;

                      for (j=0; j < components; j++)
                        {
                          if (j != 0)
                            (void) FormatLocaleString(buffer+strlen(buffer),
                              MagickPathExtent-strlen(buffer),", ");
                          (void) FormatLocaleString(buffer+strlen(buffer),
                            MagickPathExtent-strlen(buffer),"%d",(int) *p++);
                        }
                    }
                  else
                    (void) FormatLocaleString(buffer,MagickPathExtent,"%d",
                      (int) *p);
                  (void) SetImageProperty((Image *) image,q,buffer,exception);
                }
              else
                {
                  if (format == EXIF_FMT_USHORT)
                    {
                      if (components > 1)
                        {
                          size_t
                            j;

                          for (j=0; j < components; j++)
                            {
                              if (j != 0)
                                (void) FormatLocaleString(buffer+strlen(buffer),
                                  MagickPathExtent-strlen(buffer),", ");
                              (void) FormatLocaleString(buffer+strlen(buffer),
                                MagickPathExtent-strlen(buffer),"%u",
                                ReadPropertyUnsignedShort(endian,p));
                              p+=2;
                            }
                        }
                      else
                        (void) FormatLocaleString(buffer,MagickPathExtent,"%u",
                          ReadPropertyUnsignedShort(endian,p));
                      (void) SetImageProperty((Image *) image,q,buffer,exception);
                    }
                  else
                    {
                      if (format == EXIF_FMT_ULONG)
                        {
                          if (components > 1)
                            {
                              size_t
                                j;

                              for (j=0; j < components; j++)
                                {
                                  if (j != 0)
                                    (void) FormatLocaleString(buffer+strlen(buffer),
                                      MagickPathExtent-strlen(buffer),", ");
                                  (void) FormatLocaleString(buffer+strlen(buffer),
                                    MagickPathExtent-strlen(buffer),"%lu",
                                    ReadPropertyUnsignedLong(endian,p));
                                  p+=4;
                                }
                            }
                          else
                            (void) FormatLocaleString(buffer,MagickPathExtent,"%lu",
                              ReadPropertyUnsignedLong(endian,p));
                          (void) SetImageProperty((Image *) image,q,buffer,exception);
                        }
                      else
                        {
                          if (format == EXIF_FMT_URATIONAL)
                            {
                              if (components > 1)
                                {
                                  size_t
                                    j;

                                  for (j=0; j < components; j++)
                                    {
                                      if (j != 0)
                                        (void) FormatLocaleString(buffer+strlen(buffer),
                                          MagickPathExtent-strlen(buffer),", ");
                                      (void) FormatLocaleString(buffer+strlen(buffer),
                                        MagickPathExtent-strlen(buffer),"%lu/%lu",
                                        ReadPropertyUnsignedLong(endian,p),
                                        ReadPropertyUnsignedLong(endian,p+4));
                                      p+=8;
                                    }
                                }
                              else
                                (void) FormatLocaleString(buffer,MagickPathExtent,"%lu/%lu",
                                  ReadPropertyUnsignedLong(endian,p),
                                  ReadPropertyUnsignedLong(endian,p+4));
                              (void) SetImageProperty((Image *) image,q,buffer,exception);
                            }
                          else
                            {
                              if (format == EXIF_FMT_SSHORT)
                                {
                                  if (components > 1)
                                    {
                                      size_t
                                        j;

                                      for (j=0; j < components; j++)
                                        {
                                          if (j != 0)
                                            (void) FormatLocaleString(buffer+strlen(buffer),
                                              MagickPathExtent-strlen(buffer),", ");
                                          (void) FormatLocaleString(buffer+strlen(buffer),
                                            MagickPathExtent-strlen(buffer),"%d",
                                            ReadPropertySignedShort(endian,p));
                                          p+=2;
                                        }
                                    }
                                  else
                                    (void) FormatLocaleString(buffer,MagickPathExtent,"%d",
                                      ReadPropertySignedShort(endian,p));
                                  (void) SetImageProperty((Image *) image,q,buffer,exception);
                                }
                              else
                                {
                                  if (format == EXIF_FMT_SLONG)
                                    {
                                      if (components > 1)
                                        {
                                          size_t
                                            j;

                                          for (j=0; j < components; j++)
                                            {
                                              if (j != 0)
                                                (void) FormatLocaleString(buffer+strlen(buffer),
                                                  MagickPathExtent-strlen(buffer),", ");
                                              (void) FormatLocaleString(buffer+strlen(buffer),
                                                MagickPathExtent-strlen(buffer),"%ld",
                                                ReadPropertySignedLong(endian,p));
                                              p+=4;
                                            }
                                        }
                                      else
                                        (void) FormatLocaleString(buffer,MagickPathExtent,"%ld",
                                          ReadPropertySignedLong(endian,p));
                                      (void) SetImageProperty((Image *) image,q,buffer,exception);
                                    }
                                  else
                                    {
                                      if (format == EXIF_FMT_SRATIONAL)
                                        {
                                          if (components > 1)
                                            {
                                              size_t
                                                j;

                                              for (j=0; j < components; j++)
                                                {
                                                  if (j != 0)
                                                    (void) FormatLocaleString(buffer+strlen(buffer),
                                                      MagickPathExtent-strlen(buffer),", ");
                                                  (void) FormatLocaleString(buffer+strlen(buffer),
                                                    MagickPathExtent-strlen(buffer),"%ld/%ld",
                                                    ReadPropertySignedLong(endian,p),
                                                    ReadPropertySignedLong(endian,p+4));
                                                  p+=8;
                                                }
                                            }
                                          else
                                            (void) FormatLocaleString(buffer,MagickPathExtent,"%ld/%ld",
                                              ReadPropertySignedLong(endian,p),
                                              ReadPropertySignedLong(endian,p+4));
                                          (void) SetImageProperty((Image *) image,q,buffer,exception);
                                        }
                                      else
                                        {
                                          if (format == EXIF_FMT_SINGLE)
                                            {
                                              if (components > 1)
                                                {
                                                  size_t
                                                    j;

                                                  for (j=0; j < components; j++)
                                                    {
                                                      if (j != 0)
                                                        (void) FormatLocaleString(buffer+strlen(buffer),
                                                          MagickPathExtent-strlen(buffer),", ");
                                                      (void) FormatLocaleString(buffer+strlen(buffer),
                                                        MagickPathExtent-strlen(buffer),"%f",
                                                        ReadPropertyFloat(endian,p));
                                                      p+=4;
                                                    }
                                                }
                                              else
                                                (void) FormatLocaleString(buffer,MagickPathExtent,"%f",
                                                  ReadPropertyFloat(endian,p));
                                              (void) SetImageProperty((Image *) image,q,buffer,exception);
                                            }
                                          else
                                            {
                                              if (format == EXIF_FMT_DOUBLE)
                                                {
                                                  if (components > 1)
                                                    {
                                                      size_t
                                                        j;

                                                      for (j=0; j < components; j++)
                                                        {
                                                          if (j != 0)
                                                            (void) FormatLocaleString(buffer+strlen(buffer),
                                                              MagickPathExtent-strlen(buffer),", ");
                                                          (void) FormatLocaleString(buffer+strlen(buffer),
                                                            MagickPathExtent-strlen(buffer),"%f",
                                                            ReadPropertyDouble(endian,p));
                                                          p+=8;
                                                        }
                                                    }
                                                  else
                                                    (void) FormatLocaleString(buffer,MagickPathExtent,"%f",
                                                      ReadPropertyDouble(endian,p));
                                                  (void) SetImageProperty((Image *) image,q,buffer,exception);
                                                }
                                              else
                                                {
                                                  if (format == EXIF_FMT_UNDEFINED)
                                                    {
                                                      if (components > 1)
                                                        {
                                                          size_t
                                                            j;

                                                          for (j=0; j < components; j++)
                                                            {
                                                              if (j != 0)
                                                                (void) FormatLocaleString(buffer+strlen(buffer),
                                                                  MagickPathExtent-strlen(buffer),", ");
                                                              (void) FormatLocaleString(buffer+strlen(buffer),
                                                                MagickPathExtent-strlen(buffer),"%02X",
                                                                (unsigned int) *p++);
                                                            }
                                                        }
                                                      else
                                                        (void) FormatLocaleString(buffer,MagickPathExtent,"%02X",
                                                          (unsigned int) *p++);
                                                      (void) SetImageProperty((Image *) image,q,buffer,exception);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
      else
        {
          if (tag_value < length)
            {
              if (tag_value+number_bytes <= length)
                {
                  if (tag == 0x9286)
                    {
                      char
                        *value;

                      value=(char *) AcquireQuantumMemory(number_bytes+1,
                        sizeof(*value));
                      if (value != (char *) NULL)
                        {
                          (void) CopyMagickString(value,(char *) (exif_data+tag_value),
                            number_bytes);
                          value[number_bytes]='\0';
                          (void) SetImageProperty((Image *) image,q,value,exception);
                          value=DestroyString(value);
                        }
                    }
                  else
                    {
                      char
                        buffer[MagickPathExtent];

                      (void) FormatLocaleString(buffer,MagickPathExtent,"%lu",
                        ReadPropertyUnsignedLong(endian,exif_data+tag_value));
                      (void) SetImageProperty((Image *) image,q,buffer,exception);
                    }
                }
            }
        }
    }
    if (entry < number_entries)
      {
        /*
          Push the current IFD onto the stack.
        */
        directory_stack[level].directory=directory;
        directory_stack[level].entry=entry;
        directory_stack[level].offset=tag_offset;
        level++;
        if (level >= MaxDirectoryStack)
          break;
        /*
          Set the pointer to the next IFD.
        */
        offset=(ssize_t) ReadPropertySignedLong(endian,directory+(12*entry)+8);
        if ((offset < 0) || (size_t) offset >= length)
          break;
        if (((size_t) offset+(size_t) number_bytes) < (size_t) offset)
          break;  /* prevent overflow */
        if ((size_t) (offset+(ssize_t) number_bytes) > length)
          break;
        directory=exif_data+offset;
        entry=0;
        tag_offset=offset;
      }
  } while (entry < number_entries);
  exif_resources=DestroySplayTree(exif_resources);
}

static void GetGPSProperty(const Image *image,const char *property,
  ExceptionInfo *exception)
{
  char
    *attribute,
    *resource;

  const StringInfo
    *profile;

  EndianType
    endian;

  size_t
    length;

  ssize_t
    count,
    id,
    sub_number;

  profile=GetImageProfile(image,"gps");
  if (profile == (const StringInfo *) NULL)
    return;
  sub_number=1;
  if (*property == '#')
    sub_number=(ssize_t) StringToLong(property+1);