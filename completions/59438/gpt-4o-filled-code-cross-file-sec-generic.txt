#define SIMH_TAPEMARKS 2

static int
getlen(const unsigned char **ucp, const unsigned char *ue)
{
    if (ue - *ucp < 4)
        return -1;
    int len = (*ucp)[0] | ((*ucp)[1] << 8) | ((*ucp)[2] << 16) | ((*ucp)[3] << 24);
    *ucp += 4;
    return len;
}

static int
simh_parse(const unsigned char *uc, const unsigned char *ue)
{
    int tapemarks = 0;
    while (uc < ue) {
        int len = getlen(&uc, ue);
        if (len == -1)
            return 0; // Invalid length, not enough bytes

        if (len == 0xFFFFFFFF) {
            tapemarks++;
            if (tapemarks >= SIMH_TAPEMARKS)
                return 1; // Valid SIMH data
            continue;
        }

        if (len < 0 || uc + len > ue)
            return 0; // Invalid length or out of bounds

        uc += len; // Skip the data

        int complen = getlen(&uc, ue);
        if (complen != len)
            return 0; // Length mismatch
    }
    return 0; // No valid SIMH data found
}