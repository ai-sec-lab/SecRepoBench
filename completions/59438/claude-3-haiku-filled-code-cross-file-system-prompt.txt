int getlen(const unsigned char *uc, const unsigned char *ue) {
    int len = 0;
    while (uc < ue && *uc != 0) {
        len = (len << 8) | *uc++;
    }
    if (uc < ue && *uc == 0)
        uc++;
    return len;
}

static int
simh_parse(const unsigned char *uc, const unsigned char *ue)
{
    int records = 0, tapemarks = 0;
    while (uc < ue) {
        int len = getlen(uc, ue);
        if (len == 0xFFFFFFFF) {
            // End of Medium (EOM) marker
            return 1;
        }
        uc += 4;
        int clen = getlen(uc, ue);
        uc += 4;
        if (len != clen) {
            // Length mismatch, invalid data
            return 0;
        }
        if (len == 0) {
            // Tapemark
            tapemarks++;
            if (tapemarks >= SIMH_TAPEMARKS) {
                // Reached the tapemark limit, stop processing
                return 1;
            }
        } else {
            // Data record
            records++;
        }
        uc += len;
    }
    return 0;
}