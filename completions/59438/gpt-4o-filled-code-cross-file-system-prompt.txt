#define SIMH_TAPEMARKS 2

static int
getlen(const unsigned char **ucp, const unsigned char *ue)
{
    const unsigned char *uc = *ucp;
    unsigned int len;

    if (uc + 4 > ue)
        return -1;

    len = (uc[0] << 24) | (uc[1] << 16) | (uc[2] << 8) | uc[3];
    *ucp = uc + 4;
    return len;
}

static int
simh_parse(const unsigned char *uc, const unsigned char *ue)
{
    int tapemarks = 0;
    unsigned int len, rlen;

    while (uc < ue) {
        len = getlen(&uc, ue);
        if (len == 0xFFFFFFFF) {
            tapemarks++;
            if (tapemarks >= SIMH_TAPEMARKS)
                return 1;
            continue;
        }
        if (len == (unsigned int)-1 || uc + len + 4 > ue)
            return 0;

        uc += len;

        rlen = getlen(&uc, ue);
        if (rlen != len)
            return 0;
    }
    return 0;
}