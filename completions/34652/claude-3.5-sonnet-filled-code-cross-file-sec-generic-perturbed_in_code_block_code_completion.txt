if (originalformat == 'g') {
  int adjusted_prec = prec + (e - 1);
  if (adjusted_prec > buf_remaining - FLT_MIN_BUF_SIZE) {
    adjusted_prec = buf_remaining - FLT_MIN_BUF_SIZE;
  }
  if (adjusted_prec > 0) {
    prec = adjusted_prec;
  } else {
    prec = 0;
  }
} else {
  if (prec > buf_remaining - FLT_MIN_BUF_SIZE) {
    prec = buf_remaining - FLT_MIN_BUF_SIZE;
  }
}