(1) {  /* close the dangling if from the original source */

    /* -------------------------------------------------
     *  Spotify heuristic detection
     * -------------------------------------------------*/

    /* ********** 1.  UDP detection  **********        *
     * Spotify uses (among others) the well-known UDP   *
     * ports 4070/4071 for streaming.                   */
    if(packet->udp != NULL) {
      if((packet->udp->dest == htons(4070)) || (packet->udp->source == htons(4070)) ||
         (packet->udp->dest == htons(4071)) || (packet->udp->source == htons(4071))) {

        /* Make sure there is at least some payload – empty keep-alives
         * should not trigger a detection. */
        if(payload_len > 0) {
          NDPI_LOG_INFO(ndpi_struct, "Spotify detected (UDP port 4070/4071)\n");
          ndpi_int_add_connection(ndpi_struct, stream,
                                  NDPI_PROTOCOL_SPOTIFY, NDPI_REAL_PROTOCOL);
          return;
        }
      }
    }

    /* ********** 2.  TCP detection  **********        *
     * Control traffic very often runs on TCP/4070.     *
     * In addition, look for the word “spotify” in the  *
     * application payload (e.g. HTTP CONNECT or TLS    *
     * SNI before encryption).                          */
    if(packet->tcp != NULL) {
      if((packet->tcp->dest == htons(4070)) || (packet->tcp->source == htons(4070))) {
        NDPI_LOG_INFO(ndpi_struct, "Spotify detected (TCP port 4070)\n");
        ndpi_int_add_connection(ndpi_struct, stream,
                                NDPI_PROTOCOL_SPOTIFY, NDPI_REAL_PROTOCOL);
        return;
      }

      if((payload_len >= 7) &&
         (ndpi_strnstr((const char*)packet->payload, "spotify", payload_len) != NULL)) {
        NDPI_LOG_INFO(ndpi_struct, "Spotify detected (payload pattern)\n");
        ndpi_int_add_connection(ndpi_struct, stream,
                                NDPI_PROTOCOL_SPOTIFY, NDPI_REAL_PROTOCOL);
        return;
      }
    }

    /* ********** 3.  IP-range detection  **********    *
     * Fallback: a small subset of documented Spotify   *
     * address spaces (example: 78.31.8.0/21).          */
    if(packet->iph != NULL) {
      u_int32_t src_ip = ntohl(packet->iph->saddr);
      u_int32_t dst_ip = ntohl(packet->iph->daddr);

      /* 78.31.8.0/21 -> net 0x4E1F0800 mask 0xFFFFF800 */
      if(((src_ip & 0xFFFFF800) == 0x4E1F0800) ||
         ((dst_ip & 0xFFFFF800) == 0x4E1F0800)) {
        NDPI_LOG_INFO(ndpi_struct, "Spotify detected (IP range 78.31.8.0/21)\n");
        ndpi_int_add_connection(ndpi_struct, stream,
                                NDPI_PROTOCOL_SPOTIFY, NDPI_REAL_PROTOCOL);
        return;
      }
    }
  }