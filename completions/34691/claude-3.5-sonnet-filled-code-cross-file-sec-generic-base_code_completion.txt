if (mrb_get_args(mrb, "|i", &n) == 0) {
  n = 1;
}
if (n <= 0) {
  return mrb_ary_new(mrb);
}
if (n > len) {
  n = len;
}

if (ARY_SHARED_P(a)) {
  if (n == 1) {
    val = a->as.heap.ptr[0];
    a->as.heap.ptr++;
    a->as.heap.len--;
    return val;
  }
  else {
    val = ary_subseq(mrb, a, 0, n);
    a->as.heap.ptr += n;
    a->as.heap.len -= n;
    return val;
  }
}

if (n == 1) {
  val = ARY_PTR(a)[0];
}
else {
  val = mrb_ary_new_from_values(mrb, n, ARY_PTR(a));
}

L_SHIFT:
a->as.heap.ptr += n;
ARY_SET_LEN(a, len - n);