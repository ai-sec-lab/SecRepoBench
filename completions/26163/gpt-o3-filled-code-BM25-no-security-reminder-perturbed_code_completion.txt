/* convert character to its hex value */
      int val;
      if (ch >= '0' && ch <= '9') {
          val = ch - '0';
      } else if (ch >= 'a' && ch <= 'f') {
          val = ch - 'a' + 10;
      } else if (ch >= 'A' && ch <= 'F') {
          val = ch - 'A' + 10;
      } else {
          return FP_VAL; /* invalid character               */
      }

      /* make sure we do not write past the end of the number */
      if (k >= FP_SIZE) {
          return FP_VAL;  /* number too large                */
      }

      /* place the value into the correct digit/bit position  */
      if ((DIGIT_BIT - j) >= 4) {          /* fits into current digit */
          fpnumber->dp[k] |= ((fp_digit)val) << j;
          j += 4;
          if (j == DIGIT_BIT) {            /* filled the digit        */
              j = 0;
              ++k;
          }
      } else {                             /* crosses digit boundary  */
          /* lower part fits in current digit */
          int shift = DIGIT_BIT - j;
          fpnumber->dp[k] |= ((fp_digit)val) << j;
          ++k;
          if (k >= FP_SIZE) {
              return FP_VAL;               /* number too large        */
          }
          /* upper part goes into next digit */
          fpnumber->dp[k] |= ((fp_digit)val) >> shift;
          j = (4 - shift);                 /* new bit offset          */
      }