am_seq_t *b = c->bams[r1];
        khint_t k;
        int n;
        uint64_t e;

        e = expected_template_count(b);

        k = kh_get(m_s2u64, names, bam_name(b));
        if (k != kh_end(names)) {
            if (kh_val(names, k) == -1) {
                cr->cram_flags |= CRAM_FLAG_LOSSY_NAME;
            }
        }
    }

    ret = 0;

fail:
    kh_destroy(m_s2u64, names);
    return ret;
}

/*
 * Encodes a single read.
 *
 * Returns 0 on success
 *        -1 on failure
 */
static int process_one_read(cram_fd *fd, cram_container *c,
                            cram_slice *s, cram_record *cr,
                            bam_seq_t *b, int rnum, kstring_t *MD,
                            int embed_ref, int no_ref) {
    int r = 0;
    int i, j;
    int32_t i32;
    int64_t i64;
    uint8_t *aux;
    uint8_t *aux_end;
    uint8_t *seq;
    uint8_t *qual;
    uint8_t *qual_end;
    uint8_t *seq_end;
    uint8_t *md_end;
    uint8_t *md;
    uint8_t *md_start;
    uint8_t *md_seq;
    uint8_t *md_qual;
    uint8_t *md_cigar;
    uint8_t *md_cigar_end;
    uint8_t *md_seq_start;
    uint8_t *md_seq_end;
    uint8_t *md_qual_start;
    uint8_t *md_qual_end;
    uint8_t *md_cigar_start;
    uint8_t *md_cigar_seq;
    uint8_t *md_cigar_qual;
    uint8_t *md_cigar_seq_start;
    uint8_t *md_cigar_seq_end;
    uint8_t *md_cigar_qual_start;
    uint8_t *md_cigar_qual_end;
    uint8_t *md_cigar_seq_qual;
    uint8_t *md_cigar_seq_qual_start;
    uint8_t *md_cigar_seq_qual_end;
    uint8_t *md_cigar_seq_qual_start_end;
    uint8_t *md_cigar_seq_qual_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end_end;
    uint8_t *md_cigar_seq_qual_start_end_end_end_end_end_