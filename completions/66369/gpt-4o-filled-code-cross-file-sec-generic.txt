// Process each auxiliary tag
        while (aux < aux_end) {
            uint8_t type = aux[2];
            int tag_len = 0;

            // Check for RG:Z (Read Group) tag
            if (aux[0] == 'R' && aux[1] == 'G' && type == 'Z') {
                // Find or create RG tag in header
                brg = sam_hrecs_find_rg(fd->header->hrecs, aux + 3);
                if (!brg) {
                    hts_log_warning("RG tag refers to unknown read group '%s'", aux + 3);
                }
                cr->rg = brg ? brg->id : -1;
            }

            // Determine the length of the tag data
            switch (type) {
                case 'A': case 'c': case 'C':
                    tag_len = 4; // 2 bytes for tag, 1 for type, 1 for data
                    break;
                case 's': case 'S':
                    tag_len = 5; // 2 bytes for tag, 1 for type, 2 for data
                    break;
                case 'i': case 'I': case 'f':
                    tag_len = 7; // 2 bytes for tag, 1 for type, 4 for data
                    break;
                case 'Z': case 'H':
                    tag_len = 3 + strlen(aux + 3) + 1; // 2 bytes for tag, 1 for type, string length + null terminator
                    break;
                case 'B': {
                    int32_t n;
                    memcpy(&n, aux + 3, 4);
                    tag_len = 8 + n * aux_type_size(aux[3]); // 2 bytes for tag, 1 for type, 4 for count, data
                    break;
                }
                default:
                    hts_log_error("Unknown aux type '%c'", type);
                    goto err;
            }

            // Append tag to the slice auxiliary block
            if (BLOCK_APPEND(s->aux_blk, aux, tag_len) < 0)
                goto err;

            aux += tag_len;
        }