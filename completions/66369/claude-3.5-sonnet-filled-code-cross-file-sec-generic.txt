if (aux[0] == 'R' && aux[1] == 'G' && aux[2] == 'Z') {
    brg = sam_hdr_find_rg(fd->header, aux + 3);
    if (!brg) {
        hts_log_warning("Read group '%s' not found in file header", aux + 3);
    }
}

if (aux[0] == 'M' && aux[1] == 'D' && verbatim_MD) {
    if (CRAM_MAJOR_VERS(fd->version) == 1)
        BLOCK_APPEND(s->aux_blk, aux, 3 + strlen(aux+3) + 1);
    else
        BLOCK_APPEND(s->aux_blk, aux, 3);
} else if (aux[0] == 'N' && aux[1] == 'M' && verbatim_NM) {
    if (CRAM_MAJOR_VERS(fd->version) == 1)
        BLOCK_APPEND(s->aux_blk, aux, 3 + strlen(aux+3) + 1);
    else
        BLOCK_APPEND(s->aux_blk, aux, 3);
} else {
    char *key = string_ndup(c->comp_hdr->tag_encoding_map[0], aux, 2);
    if (!key) goto block_err;

    tm = map_find(c->comp_hdr->tag_encoding_map, key, cmap_key);
    if (!tm) {
        tm = map_find(c->comp_hdr->tag_encoding_map, key, cmap_key);
        if (!tm) {
            hts_log_warning("Unknown tag key '%.2s'", key);
            free(key);
            aux += 3;
            continue;
        }
    }
    free(key);

    if (tm->codec) {
        BLOCK_GROW(tm->blk, tm->blk->byte + 1024);
        if (tm->codec->encode(s, tm->codec, tm->blk, aux + 2, NULL) < 0)
            goto block_err;
    } else {
        BLOCK_APPEND(tm->blk, aux + 2, 1);
    }
}

aux += 3 + aux_size;