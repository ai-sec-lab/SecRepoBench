// Copy aux keys to td_b and aux values to slice aux blocks
while (aux_end - aux >= 1 && aux[0] != 0) {
    int r;

    // Room for code + type + at least 1 byte of data
    if (aux - orig >= aux_size - 3)
        goto err;

    // RG:Z
    if (aux[0] == 'R' && aux[1] == 'G' && aux[2] == 'Z') {
        // Find the read group header record
        brg = sam_hdr_find_rg(fd->header, (char *)aux + 3);
        if (brg) {
            // Add the RG tag to the TD block
            BLOCK_APPEND_CHAR(td_b, 'R');
            BLOCK_APPEND_CHAR(td_b, 'G');
            BLOCK_APPEND_CHAR(td_b, 'Z');
            BLOCK_APPEND(td_b, brg->name, strlen(brg->name) + 1);
            cr->rg = brg->id;
        } else {
            hts_log_warning("Missing RG header record for tag '%s'", (char *)aux + 3);
        }
    } else if (aux[0] == 'M' && aux[1] == 'D' && aux[2] != '*') {
        // MD:Z
        if (verbatim_MD) {
            BLOCK_APPEND_CHAR(td_b, 'M');
            BLOCK_APPEND_CHAR(td_b, 'D');
            BLOCK_APPEND_CHAR(td_b, 'Z');
            BLOCK_APPEND(td_b, (char *)aux + 3, strlen((char *)aux + 3) + 1);
            kstring_append_str(MD, (char *)aux + 3);
        } else {
            // Placeholder for later auto-generation
            BLOCK_APPEND_CHAR(td_b, 'M');
            BLOCK_APPEND_CHAR(td_b, 'D');
            BLOCK_APPEND_CHAR(td_b, '*');
            *has_MD = 1;
        }
    } else if (aux[0] == 'N' && aux[1] == 'M' && aux[2] != '*') {
        // NM:i
        if (verbatim_NM) {
            BLOCK_APPEND_CHAR(td_b, 'N');
            BLOCK_APPEND_CHAR(td_b, 'M');
            BLOCK_APPEND_CHAR(td_b, 'i');
            BLOCK_APPEND(td_b, (char *)aux + 3, strlen((char *)aux + 3) + 1);
            *NM = atoi((char *)aux + 3);
        } else {
            // Placeholder for later auto-generation
            BLOCK_APPEND_CHAR(td_b, 'N');
            BLOCK_APPEND_CHAR(td_b, 'M');
            BLOCK_APPEND_CHAR(td_b, '*');
            *has_NM = 1;
        }
    } else {
        // Other aux tags
        BLOCK_APPEND(td_b, (char *)aux, aux_end - aux + 1);
    }

    aux = memchr(aux, 0, aux_end - aux) + 1;
}