if (aux[0] == 'R' && aux[1] == 'G' && aux[2] == 'Z') {
    // Handle Read Group tag
    char *rg = (char *)aux + 3;
    int rg_len = strlen(rg);
    k = kh_put(m_s2i, c->comp_hdr->RG_hash, rg, &new);
    if (new < 0) goto err;
    if (new) {
        kh_val(c->comp_hdr->RG_hash, k) = c->comp_hdr->nRG++;
        if (c->comp_hdr->nRG >= c->comp_hdr->RG_size) {
            c->comp_hdr->RG_size = c->comp_hdr->RG_size ? c->comp_hdr->RG_size*2 : 1024;
            c->comp_hdr->RG = realloc(c->comp_hdr->RG, c->comp_hdr->RG_size * sizeof(char *));
            if (!c->comp_hdr->RG) goto err;
        }
        c->comp_hdr->RG[kh_val(c->comp_hdr->RG_hash, k)] = strdup(rg);
    }
    cr->rg = kh_val(c->comp_hdr->RG_hash, k);
    brg = sam_hrecs_find_rg(fd->header->hrecs, rg);
} else {
    // Handle other tags
    char *key = string_ndup(c->comp_hdr->TD_keys, (char *)aux, 2);
    if (!key) goto err;
    k = kh_put(m_s2i, c->comp_hdr->TD_hash, key, &new);
    if (new < 0) goto err;
    if (new) {
        kh_val(c->comp_hdr->TD_hash, k) = c->comp_hdr->nTL++;
        if (c->comp_hdr->nTL >= c->comp_hdr->TL_size) {
            c->comp_hdr->TL_size = c->comp_hdr->TL_size ? c->comp_hdr->TL_size*2 : 1024;
            c->comp_hdr->TL = realloc(c->comp_hdr->TL, c->comp_hdr->TL_size * sizeof(unsigned char *));
            if (!c->comp_hdr->TL) goto err;
        }
        c->comp_hdr->TL[kh_val(c->comp_hdr->TD_hash, k)] = (unsigned char *)strdup((char *)aux);
    }
    tm = &s->aux_block[kh_val(c->comp_hdr->TD_hash, k)];
    if (!tm->codec) {
        tm->codec = cram_encoder_init(aux[2], E_BYTE_ARRAY_STOP, NULL);
        if (!tm->codec) goto err;
    }
    BLOCK_APPEND(tm->blk, aux+3, aux_size-3);
}

aux += aux_size;