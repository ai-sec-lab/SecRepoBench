key = (char *)aux;
        if (aux_end - aux < 3)
            goto err;

        aux += 2;

        switch (aux[0]) {
        case 'Z':
        case 'H':
        case 'B':
            break;

        case 'c':
            if (aux[1] != 'F')
                goto unknown_tag;
            break;

        case 'C':
            if (aux[1] != 'i')
                goto unknown_tag;
            break;

        case 'A':
            if (aux[1] != 'i' && aux[1] != 'c')
                goto unknown_tag;
            break;

        case 'I':
            if (aux[1] != 'i')
                goto unknown_tag;
            break;

        case 'f':
            if (aux[1] != 'f')
                goto unknown_tag;
            break;

        case 'i':
            if (aux[1] != 'i')
                goto unknown_tag;
            break;

        default:
        unknown_tag:
            if (CRAM_MAJOR_VERS(fd->version) >= 4)
                goto err; // Unknown tag
            break;
        }

        if (CRAM_MAJOR_VERS(fd->version) < 4 &&
            key[0] == 'R' && key[1] == 'G') {
            if (!brg) {
                brg = bam_hrec_find_rg(fd->header->hrecs, (char *)aux + 1);
            }

            if (!brg) {
                hts_log_warning("Read group \"%s\" not found in header, adding it",
                               (char *)aux + 1);
                if (!(brg = bam_hrec_add_rg(fd->header->hrecs, (char *)aux + 1)))
                    goto err;
            }

            cr->rg = brg->id;
        }


        kstring_t *tm_blk = &c->tm.blk[c->tm.curr_blk];
        cram_map *tm = &c->tm.data[c->tm.curr_rec];

        BLOCK_APPEND(td_b, key, 3);
        TD_blk_size += 3;

        tm->k = (key[0]<<16)|(key[1]<<8)|key[2];
        tm->codec = NULL;

        // Special case: RG:Z is container wide, not per slice.
        if (key[0] == 'R' && key[1] == 'G') {
            tm->blk = c->comp_hdr->global_rg;
            if (!tm->blk) {
                c->comp_hdr->global_rg = cram_new_block(AUX_BLOCK, 0);
                if (!c->comp_hdr->global_rg)
                    goto block_err;
                tm->blk = c->comp_hdr->global_rg;
            }
        } else {
            tm->blk = s->aux_blk;
        }

        if (tm->blk == s->aux_blk) {
            BLOCK_APPEND(s->aux_blk, aux+1, aux_end - (aux+1));
            s->aux_bytes += aux_end - (aux+1);
        } else {
            BLOCK_APPEND(tm->blk, aux+1, aux_end - (aux+1));
        }

        aux = (char *)aux_end;

        tm->m = kh_put(m_tag, c->comp_hdr->tag_encoding_map, tm->k, &new);
        if (new < 0)
            goto err;

        if (new) {
            kh_val(c->comp_hdr->tag_encoding_map, tm->m) = *tm;
        }

        c->tm.curr_rec++;
        if (c->tm.curr_rec == c->tm.max_rec) {
            c->tm.curr_blk++;
            if (c->tm.curr_blk == c->tm.max_blk) {
                c->tm.max_blk *= 2;
                c->tm.blk = realloc(c->tm.blk, c->tm.max_blk * sizeof(kstring_t));
                if (!c->tm.blk)
                    goto block_err;
                memset(&c->tm.blk[c->tm.curr_blk], 0,
                       (c->tm.max_blk - c->tm.curr_blk) * sizeof(kstring_t));
            }
            c->tm.curr_rec = 0;
            c->tm.blk[c->tm.curr_blk].l = c->tm.blk[c->tm.curr_blk].m = 0;
        }