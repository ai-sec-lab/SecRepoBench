// Retrieve and set image properties from TIFF tags.
TIFFDirEntry *dir;
uint32 count, length, type;
char *text;

// Iterate through the TIFF directory entries
for (dir = TIFFDirEntryChain(tiff); dir != NULL; dir = TIFFDirEntryNext(dir)) {
    // Get the tag, count, and type of the current directory entry
    uint16 tag = dir->tdir_tag;
    count = dir->tdir_count;
    type = dir->tdir_type;

    // Allocate memory for the tag value
    text = (char *) AcquireQuantumMemory(count, sizeof(char));
    if (text == NULL) {
        ThrowException(exception, ResourceLimitError, "MemoryAllocationFailed", NULL);
        return;
    }

    // Retrieve the tag value from the TIFF directory
    if (TIFFGetField(tiff, tag, text) != 0) {
        // Set the image property using the retrieved tag value
        SetImageProperty(image, GetTIFFTagName(tag), text, exception);

        // Handle special cases for certain tags
        if (tag == TIFFTAG_OPIIMAGEID) {
            if (count > 0 && text[count-1] == '\0') {
                count--;
            }
            SetImageProperty(image, "opiimageId", text, exception);
        } else if (tag == TIFFTAG_SUBFILETYPE) {
            if (text[0] == FILETYPE_REDUCEDIMAGE) {
                SetImageProperty(image, "tiff:subfiletype", "REDUCEDIMAGE", exception);
            } else if (text[0] == FILETYPE_PAGE) {
                SetImageProperty(image, "tiff:subfiletype", "PAGE", exception);
            } else if (text[0] == FILETYPE_MASK) {
                SetImageProperty(image, "tiff:subfiletype", "MASK", exception);
            }
        }
    }

    // Release the memory for the tag value
    text = (char *) RelinquishMagickMemory(text);
}