for (i = KC; i < (rounds + 1) * 4; i++) {
    memcpy(tk[0], tk[KC - 1], 4);
    if (KC == 8 || (KC == 4 && i % KC == 0)) {
        AV_ROTATE(tk[0], 1, 4);
        for (t = 0; t < 4; t++)
            tk[0][t] = sbox[tk[0][t]];
    }
    if (KC == 8 && i % 8 == 4)
        for (t = 0; t < 4; t++)
            tk[0][t] = sbox[tk[0][t]];
    if (i % KC == 0)
        tk[0][0] ^= rcon[rconpointer++];
    for (t = 1; t < KC && i % KC; t++)
        memcpy(tk[t], tk[t - 1], 4);
    for (t = 0; t < 4; t++)
        a->round_key[i / 4].u8[t] = tk[0][t] ^= tk[KC - 1][t];
}