for (i = KC; i < (rounds + 1) * 4; i++) {
    memcpy(tk[0], tk[KC - 1], 4);
    if (KC == 8 || (KC == 4 && i % KC == 0)) {
        AV_ROTATE(tk[0], -1);
        for (j = 0; j < 4; j++)
            tk[0][j] = sbox[tk[0][j]] ^ rcon[rconpointer++];
    } else if (KC == 8 && i % KC == 4) {
        for (j = 0; j < 4; j++)
            tk[0][j] = sbox[tk[0][j]];
    }
    for (j = 0; j < 4; j++)
        tk[0][j] ^= tk[KC - 8][j];
    memcpy(tk[1], tk[0], 4);

    for (j = 1; j < KC - 1; j++) {
        memcpy(tk[j + 1], tk[j], 4);
        for (t = 0; t < 4; t++)
            tk[j][t] ^= tk[j + 1][t];
    }
    memcpy(a->round_key[i / 4].u8 + 4 * (i % 4), tk[0], 4);
}