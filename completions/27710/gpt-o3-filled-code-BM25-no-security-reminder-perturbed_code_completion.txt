flb_sds_t out;                 /* working SDS that will hold the path   */
    char *p;                       /* pointer used while rebuilding the uri */
    struct mk_list *split;         /* list with the path components         */
    struct mk_list *head;          /* generic list iterator                 */
    struct mk_list *tmp;           /* temporary list iterator (safe)        */
    struct mk_list *prev;          /* previous list element                 */
    struct flb_split_entry *entry; /* current split entry                   */
    flb_bool_t end_slash = FLB_FALSE;

    /* Basic validations */
    if (!pathuri) {
        return NULL;
    }

    if (len == 0) {
        return flb_sds_create("/");
    }

    /* Check if the original URI finished with a slash */
    if (pathuri[len - 1] == '/') {
        end_slash = FLB_TRUE;
    }

    /*
     * Create a mutable SDS string from the incoming URI.  We reserve two
     * extra bytes so we can safely prepend or append a ‘/’ while normalising
     * the path without reallocating.
     */
    out = flb_sds_create_size(len + 2);
    if (!out) {
        return NULL;
    }

    memcpy(out, pathuri, len);
    out[len] = '\0';
    flb_sds_len_set(out, len);