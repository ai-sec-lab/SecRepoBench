/* Build the offsets table for the INDEX.  Offsets in a CFF INDEX are
     * 1-based and are expressed relative to the byte that follows the
     * last offset of the table (i.e. the first data byte). */
    unsigned int offsets_len = (fdCount + 1) * offsetSize;
    HBUINT8 *offset_buf = c->allocate_size<HBUINT8> (offsets_len);
    if (unlikely (!offset_buf))
      return_trace (false);

    /* Helper to write a big-endian offset value of variable size. */
    auto write_offset = [offset_buf, offsetSize] (unsigned int idx,
						  unsigned int value)
    {
      uint8_t *p = reinterpret_cast<uint8_t *> (offset_buf + idx * offsetSize);
      for (int k = offsetSize - 1; k >= 0; k--)
      {
	p[k] = uint8_t (value & 0xFF);
	value >>= 8;
      }
    };

    unsigned int dataOffset = 1; /* first offset is always 1 */
    unsigned int outIdx     = 0;

    for (unsigned int i = 0; i < fontDicts.length; ++i)
      if (fdmap.includes (i))
      {
	/* Record offset for this dictionary. */
	write_offset (outIdx++, dataOffset);

	/* Advance offset by the size of the serialized dictionary. */
	dataOffset += FontDict::calculate_serialized_size (fontDicts[i], opszr);
      }

    /* Final offset marks the end of the data area. */
    write_offset (outIdx, dataOffset);