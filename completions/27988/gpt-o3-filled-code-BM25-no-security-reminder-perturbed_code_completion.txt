/*
     * The ndpi_flow_struct might contain dynamically-allocated helpers that
     * are only present when specific compile-time features are enabled
     * (HTTP parsing, TLS/QUIC, etc.).  In order to avoid compilation issues
     * caused by dereferencing members that might not exist in every build,
     * we release those additional resources only when the corresponding
     * feature-flags are defined.
     *
     * NOTE:
     *   – The TCP TLS message reassembly buffer is released just after this
     *     block (see below).
     *   – Please keep this list in sync with the structure definition; add
     *     new members here whenever a dynamically-allocated field is added
     *     to ndpi_flow_struct.
     */

/* ---------------------------- HTTP helpers ----------------------------- */
#ifdef NDPI_FLOW_FREE_HTTP_FIELDS
    /* An implementation may expose a list/array of pointers or individual
       members.  Below we show a generic pattern for both cases. */

/* Case 1: a dedicated array that packs all the HTTP dynamic strings. */
#if defined(NDPI_FLOW_HTTP_POINTERS) && defined(http_dynamic_fields)
    {
      unsigned int _i;
      char **_ptr = (char **)networkflow->http_dynamic_fields;
      for(_i = 0; _i < NDPI_FLOW_HTTP_POINTERS; _i++)
        if(_ptr[_i] != NULL) {
          ndpi_free(_ptr[_i]);
          _ptr[_i] = NULL;
        }
    }
#endif /* NDPI_FLOW_HTTP_POINTERS */

/* Case 2: individually-named members. */
#ifdef NDPI_FLOW_HTTP_HOST_PTR
    if(networkflow->http.host != NULL) {
      ndpi_free(networkflow->http.host);
      networkflow->http.host = NULL;
    }
#endif

#ifdef NDPI_FLOW_HTTP_URL_PTR
    if(networkflow->http.url != NULL) {
      ndpi_free(networkflow->http.url);
      networkflow->http.url = NULL;
    }
#endif

#ifdef NDPI_FLOW_HTTP_USERAGENT_PTR
    if(networkflow->http.user_agent != NULL) {
      ndpi_free(networkflow->http.user_agent);
      networkflow->http.user_agent = NULL;
    }
#endif

#ifdef NDPI_FLOW_HTTP_METHOD_PTR
    if(networkflow->http.method != NULL) {
      ndpi_free(networkflow->http.method);
      networkflow->http.method = NULL;
    }
#endif
#endif /* NDPI_FLOW_FREE_HTTP_FIELDS */

/* ---------------------------- TLS / QUIC ------------------------------ */
#ifdef NDPI_FLOW_FREE_SSL_FIELDS
    /* Similar handling for the SSL/TLS/QUIC sub-structure. */

#ifdef NDPI_FLOW_SSL_SNI_PTR
    if(networkflow->protos.stun_ssl.ssl.server_name != NULL) {
      ndpi_free(networkflow->protos.stun_ssl.ssl.server_name);
      networkflow->protos.stun_ssl.ssl.server_name = NULL;
    }
#endif

#ifdef NDPI_FLOW_SSL_ALPN_PTR
    if(networkflow->protos.stun_ssl.ssl.alpn != NULL) {
      ndpi_free(networkflow->protos.stun_ssl.ssl.alpn);
      networkflow->protos.stun_ssl.ssl.alpn = NULL;
    }
#endif

#ifdef NDPI_FLOW_SSL_CERT_PTR
    if(networkflow->protos.stun_ssl.ssl.certificate != NULL) {
      ndpi_free(networkflow->protos.stun_ssl.ssl.certificate);
      networkflow->protos.stun_ssl.ssl.certificate = NULL;
    }
#endif
#endif /* NDPI_FLOW_FREE_SSL_FIELDS */