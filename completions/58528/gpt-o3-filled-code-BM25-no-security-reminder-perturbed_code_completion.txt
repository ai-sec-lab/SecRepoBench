/* try to gather as many refs as requested (plus possibly the
             * current picture when enabled by the PPS) */
            int added = 0;
            for (i = 0; i < 3 && rpl_tmp.nb_refs < FF_ARRAY_ELEMS(rpl_tmp.list); i++) {
                int cand = cand_lists[i];

                for (refindex = 0; refindex < s->rps[cand].nb_refs &&
                                    rpl_tmp.nb_refs < FF_ARRAY_ELEMS(rpl_tmp.list); refindex++) {
                    rpl_tmp.list[rpl_tmp.nb_refs]       = s->rps[cand].list[refindex];
                    rpl_tmp.ref[rpl_tmp.nb_refs]        = s->rps[cand].ref[refindex];
                    rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = s->rps[cand].isLongTerm[refindex];
                    rpl_tmp.nb_refs++;
                    added = 1;

                    if (rpl_tmp.nb_refs >= sh->nb_refs[list_idx])
                        break;
                }
                if (rpl_tmp.nb_refs >= sh->nb_refs[list_idx])
                    break;
            }

            /* add the current picture as reference if the PPS allows it */
            if (s->ps.pps->pps_curr_pic_ref_enabled_flag &&
                rpl_tmp.nb_refs < FF_ARRAY_ELEMS(rpl_tmp.list)) {
                rpl_tmp.list[rpl_tmp.nb_refs]       = s->ref->poc;
                rpl_tmp.ref[rpl_tmp.nb_refs]        = s->ref;
                rpl_tmp.isLongTerm[rpl_tmp.nb_refs] = 0;
                rpl_tmp.nb_refs++;
            }

            /* if nothing was added in this iteration, avoid an infinite loop */
            if (!added)
                break;