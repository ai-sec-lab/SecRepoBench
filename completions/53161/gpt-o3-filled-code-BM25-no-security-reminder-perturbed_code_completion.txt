{
        /* read an integer value that may follow the directive */
        mrb_int num = 0;
        const char *p = tptr + tmpl->idx;
        while (tmpl->idx < tlen && ISDIGIT(*p)) {
          /* check overflow while accumulating */
          if (num > (MRB_INT_MAX / 10)) {
            mrb_raise(mrb, E_RUNTIME_ERROR, "template length too large");
          }
          num = num * 10 + (*p - '0');
          tmpl->idx++;
          p++;
        }
        if (num > INT_MAX) {
          mrb_raise(mrb, E_RUNTIME_ERROR, "template length too large");
        }
        repeatcount = (int)num;
        /* step back one position because the loop will increment tmpl->idx */
        tmpl->idx--;
      }