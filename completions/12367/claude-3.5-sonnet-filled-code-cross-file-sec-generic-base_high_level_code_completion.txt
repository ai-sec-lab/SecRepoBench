slices_info_offset = buf_size - 16;
nb_slices = AV_RL32(avpkt->data + slices_info_offset);
slice_height = AV_RL32(avpkt->data + slices_info_offset + 4);

if (nb_slices == 0 || nb_slices > height || slice_height == 0 || slice_height > height) {
    return AVERROR_INVALIDDATA;
}

if (slices_info_offset < (unsigned)nb_slices * 8) {
    return AVERROR_INVALIDDATA;
}

if (slice_height * nb_slices < height) {
    return AVERROR_INVALIDDATA;
}

slices_info_offset -= nb_slices * 8;

for (int i = 0; i < nb_slices; i++) {
    uint32_t slice_offset = AV_RL32(avpkt->data + slices_info_offset + i * 8);
    uint32_t slice_size = AV_RL32(avpkt->data + slices_info_offset + i * 8 + 4);
    
    if (slice_offset > buf_size || slice_size > buf_size - slice_offset) {
        return AVERROR_INVALIDDATA;
    }
}