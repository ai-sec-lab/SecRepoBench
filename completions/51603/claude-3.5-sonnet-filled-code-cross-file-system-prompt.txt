if (m->factor_op != FILE_FACTOR_OP_NONE && m->factor != 0) {
        file_magwarn(ms, "Strength settings are not supported for NAME type");
        m->factor_op = FILE_FACTOR_OP_NONE;
        m->factor = 0;
        return 0;
    }

    const char *l = line;
    char op;
    int factor;

    while (isspace((unsigned char)*l))
        l++;

    if (*l == '\0') {
        file_magwarn(ms, "Empty strength line");
        return -1;
    }

    op = *l++;
    switch (op) {
    case '+':
        m->factor_op = FILE_FACTOR_OP_PLUS;
        break;
    case '-':
        m->factor_op = FILE_FACTOR_OP_MINUS;
        break;
    case '*':
        m->factor_op = FILE_FACTOR_OP_TIMES;
        break;
    case '/':
        m->factor_op = FILE_FACTOR_OP_DIV;
        break;
    default:
        file_magwarn(ms, "Unknown strength operator '%c'", op);
        return -1;
    }

    while (isspace((unsigned char)*l))
        l++;

    factor = (int)strtol(l, NULL, 0);
    if (factor == 0 && m->factor_op == FILE_FACTOR_OP_DIV) {
        file_magwarn(ms, "Cannot divide by zero in strength");
        m->factor_op = FILE_FACTOR_OP_NONE;
        return -1;
    }

    if (factor < 0 || factor > 65535) {
        file_magwarn(ms, "Strength factor out of range (0-65535)");
        m->factor_op = FILE_FACTOR_OP_NONE;
        return -1;
    }

    m->factor = (uint16_t)factor;
    return 0;