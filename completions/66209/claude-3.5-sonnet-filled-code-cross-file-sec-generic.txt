const unsigned char *x = xs, *xe = xs + m;
  const unsigned char *y = ys;
  const unsigned char *ye = ys + n;
  const unsigned char *z;
  bitint mask;

  if (m <= 0 || n < m) return -1;
  if (m == 1) {
    unsigned char c = *xs;
    for (; y < ye; ++y) {
      if (*y == c) return y - ys;
    }
    return -1;
  }

  mask = (bitint)0;
  for (z = xe - 1; z >= x; --z) {
    mask = (mask << 8) | *z;
  }
  mask <<= (sizeof(bitint) - m) * 8;

  for (; y + m <= ye; y += sizeof(bitint)) {
    bitint word = *(bitint*)y;
    bitint xor = word ^ mask;
    bitint eq = ((xor - MASK1) & ~xor & MASK3);
    if (eq) {
      if (memcmp(x, y, m) == 0) return y - ys;
      if (sizeof(bitint) > m &&
          ((eq & (MASK4 >> ((sizeof(bitint) - m - 1) * 8))) != 0) &&
          memcmp(x, y + sizeof(bitint) - m, m) == 0)
        return y - ys + sizeof(bitint) - m;
    }
  }

  for (; y + m <= ye; ++y) {
    if (*y == *x && memcmp(x, y, m) == 0)
      return y - ys;
  }