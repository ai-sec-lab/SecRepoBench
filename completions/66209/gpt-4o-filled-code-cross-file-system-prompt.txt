if (m == 0) return 0;
  if (n < m) return -1;

  const unsigned char *xe = xs + m - 1;
  const unsigned char *ye = ys + n - m;
  bitint mask = 0;
  bitint diff = 0;
  bitint lastc = (bitint)(*xe) & MASK2;

  for (const unsigned char *y = ys; y <= ye; y++) {
    bitint c = (bitint)(*y) & MASK2;
    mask = (mask << 8) | c;
    diff = (mask ^ lastc) & MASK3;
    if (diff == 0) {
      if (memcmp(xs, y - m + 1, m) == 0) {
        return y - ys - m + 1;
      }
    }
  }