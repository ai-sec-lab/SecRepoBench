bitint xm1 = xs[0] * MASK1;
  bitint xm2 = xs[m - 1] * MASK1;
  bitint mask = (bitint)~0;
  long i;

  if (m > n) return -1;

  for (i = 0; i <= n - m; ++i) {
    bitint ymi = ys[i] * MASK1;
    bitint diff1 = ymi ^ xm1;
    if ((diff1 & MASK2) == 0) {
      bitint ymi_m = ys[i + m - 1] * MASK1;
      bitint diff2 = ymi_m ^ xm2;
      if ((diff2 & MASK2) == 0) {
        if (memcmp(xs + 1, ys + i + 1, m - 2) == 0) {
          return i;
        }
      }
    }
#ifdef MRB_64BIT
    bitint diff = diff1 | diff1 << 8 | diff1 << 16 | diff1 << 24 | diff1 << 32 | diff1 << 40 | diff1 << 48 | diff1 << 56;
#else
    bitint diff = diff1 | diff1 << 8 | diff1 << 16 | diff1 << 24;
#endif
    if (diff == 0) {
      if (memcmp(xs + 1, ys + i + 1, m - 2) == 0) {
        return i;
      }
      i += sizeof(bitint) -1;
      continue;
    }
    bitint x = diff & MASK3;
#if defined(MRB_ENDIAN_BIG)
    bitint shift = x >> ((sizeof(bitint)-1)*8);
#else
    bitint shift = x >> 7;
#endif
    if (shift == 0) {
      continue;
    }
    mask &= shift - 1;
    int shift_cnt = sizeof(bitint) - nlz_count(mask);
    if (shift_cnt == 0) continue;
    i += shift_cnt - 1;
    mask = (bitint)~0;
  }