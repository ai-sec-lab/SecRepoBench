/*
     * If we are streaming, the attribute node coming from the parser is
     * temporary and may be destroyed soon.  We therefore cannot store a
     * direct pointer to it.  Instead keep a copy of its name so that we
     * can still reference the attribute later.  Otherwise simply keep the
     * attribute pointer.
     */
    if (streaming) {
        if (doc->dict)
            ret->name = xmlDictLookup(doc->dict, attr->name, -1);
        else
            ret->name = xmlStrdup(attr->name);
        if (ret->name == NULL) {
            xmlFreeID(ret);
            return(-1);
        }
        ret->attr = NULL;
    } else {
        ret->attr = attr;
    }

    /* Record the line number of the element carrying the attribute */
    if (attr->parent != NULL)
        ret->lineno = xmlGetLineNo(attr->parent);
    else
        ret->lineno = 0;

    /*
     * Add the new ID to the document's hash table.
     */
    if (xmlHashAddEntry(table, ret->value, ret)) {
        xmlFreeID(ret);
        return(-1);
    }

    /* Only touch the attribute itself if we keep a pointer to it */
    if (!streaming) {
        attr->atype = XML_ATTRIBUTE_ID;
        attr->id = ret;
    }

    if (id != NULL)
        *id = ret;

    return(0);