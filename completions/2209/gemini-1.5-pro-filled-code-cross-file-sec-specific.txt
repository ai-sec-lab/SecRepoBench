HEVCFrame *ref;

    if (list->nb_refs >= MAX_REFS) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference overflow (nb_refs=%d)\n",
               list->nb_refs);
        return AVERROR_INVALIDDATA;
    }

    ref = find_ref_idx(s, poc);

    if (!ref) {
        ref = generate_missing_ref(s, poc);
        if (!ref)
            return AVERROR(ENOMEM);
    } else if (ref->poc == poc && list->nb_refs > 0) {
        // We already have a reference with the same POC in our list.
        return AVERROR_INVALIDDATA;
    }