HEVCFrame *ref = find_ref_idx(s, poc);
    if (!ref) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference frame not found for POC %d\n", poc);
        return AVERROR_INVALIDDATA; // Return an error if no reference is found
    }

    // Check for duplicate reference
    for (int i = 0; i < list->nb_refs; i++) {
        if (list->list[i] == ref->poc) {
            av_log(s->avctx, AV_LOG_ERROR, "Duplicate reference frame for POC %d\n", poc);
            return AVERROR_INVALIDDATA; // Prevent adding a duplicate
        }
    }

    // Check for overflow
    if (list->nb_refs >= MAX_REF_FRAMES) {
        av_log(s->avctx, AV_LOG_ERROR, "Reference count overflow\n");
        return AVERROR_INVALIDDATA; // Prevent overflow
    }

    // Add the reference frame to the list
    list->list[list->nb_refs] = ref->poc;
    list->ref[list->nb_refs]  = ref;
    list->nb_refs++;

    mark_ref(ref, ref_flag);
    return 0;