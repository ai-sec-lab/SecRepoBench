HEVCFrame *ref = find_ref_idx(s, poc);
if (ref && ref->poc == s->poc) {
    av_log(s->avctx, AV_LOG_ERROR, "Duplicate reference frame with POC %d\n", poc);
    return AVERROR_INVALIDDATA;
}

if (!ref) {
    int ret = generate_missing_ref(s, poc);
    if (ret < 0) {
        av_log(s->avctx, AV_LOG_ERROR, "Failed to generate missing reference frame with POC %d\n", poc);
        return ret;
    }
    ref = find_ref_idx(s, poc);
    if (!ref) {
        av_log(s->avctx, AV_LOG_ERROR, "Could not find generated reference frame with POC %d\n", poc);
        return AVERROR_INVALIDDATA;
    }
}