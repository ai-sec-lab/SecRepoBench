HEVCFrame *ref = find_ref_idx(s, poc);
if (!ref) {
    if (s->nal_unit_type != HEVC_NAL_CRA_NUT && !IS_BLA(s)) {
        av_log(s->avctx, AV_LOG_ERROR, "Missing reference picture with POC %d\n", poc);
        return AVERROR_INVALIDDATA;
    }
    ref = generate_missing_ref(s, poc);
    if (!ref)
        return AVERROR(ENOMEM);
}

if (!ref->frame->buf[0]) {
    av_log(s->avctx, AV_LOG_ERROR, "Reference frame with POC %d has no buffer\n", poc);
    return AVERROR_INVALIDDATA;
}

if (list->nb_refs >= MAX_REFS) {
    av_log(s->avctx, AV_LOG_ERROR, "Too many references in the list\n");
    return AVERROR_INVALIDDATA;
}