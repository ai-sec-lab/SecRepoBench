// <MASK>
int ref_idx = -1;
HEVCFrame *ref = find_ref_idx(s, poc);
if (ref) {
    // Check if the reference frame is already in the list
    for (int i = 0; i < list->nb_refs; i++) {
        if (list->list[i] == ref->poc) {
            return -1; // Reference frame already in the list, return error
        }
    }

    ref_idx = list->nb_refs;
} else {
    // Generate a missing reference frame for the given POC
    ref = generate_missing_reference(s, poc);
    if (!ref) {
        return -1; // Failed to generate missing reference, return error
    }
    ref_idx = list->nb_refs;
}

list->list[list->nb_refs] = ref->poc;
list->ref[list->nb_refs]  = ref;
list->nb_refs++;

mark_ref(ref, ref_flag);
return 0;