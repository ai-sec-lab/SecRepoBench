HEVCFrame *ref = find_ref_idx(s, poc);
if (!ref) {
    ref = generate_missing_ref(s, poc);
    if (!ref)
        return AVERROR(ENOMEM);
}

if (list->nb_refs >= FF_ARRAY_ELEMS(list->list) || list->nb_refs >= FF_ARRAY_ELEMS(list->ref)) {
    av_log(s->avctx, AV_LOG_ERROR, "Reference list overflow\n");
    return AVERROR_INVALIDDATA;
}

if (ref == list->ref[list->nb_refs]) {
    av_log(s->avctx, AV_LOG_ERROR, "Invalid reference frame\n");
    return AVERROR_INVALIDDATA;
}