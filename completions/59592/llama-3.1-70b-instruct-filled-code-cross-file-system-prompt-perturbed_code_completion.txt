hb_subset_glyphs_t *glyphs = hb_subset_glyphs_create ();
if (unlikely (!glyphs))
  return_trace (false);

if (!hb_subset_plan_collect_glyphs (context->plan, glyphs))
  return_trace (false);

if (font)
  hb_font_destroy (font);

unsigned int max_offset = 0;
bool use_short_loca = true;
for (unsigned int i = 0; i < glyphs->len; i++) {
  hb_subset_glyph_t *glyph = &glyphs->glyphs[i];
  glyph->offset = max_offset;
  max_offset += glyph->len;
  if (max_offset > 0xFFFF)
    use_short_loca = false;
}

hb_glyf_t *glyf = hb_glyf_create (use_short_loca);
if (unlikely (!glyf))
  return_trace (false);

bool result = true;
for (unsigned int i = 0; i < glyphs->len; i++) {
  hb_subset_glyph_t *glyph = &glyphs->glyphs[i];
  if (!hb_glyf_serialize_glyph (glyf, glyph->offset, glyph->len, glyph->data))
    result = false;
}

hb_subset_glyphs_destroy (glyphs);
hb_glyf_destroy (glyf);