hb_subset_glyphs_t *glyphs = hb_subset_glyphs_create ();
if (unlikely (!glyphs))
  return_trace (false);

if (!hb_subset_plan_collect_glyphs (context->plan, glyphs))
  return_trace (false);

if (font)
  hb_font_destroy (font);

bool use_short_loca = true;
for (unsigned int i = 0; i < glyphs->len; i++) {
  hb_subset_glyph_t *glyph = &glyphs->glyphs[i];
  glyph->offset = hb_subset_plan_get_glyph_offset (context->plan, glyph->codepoint);
  if (glyph->offset + glyph->len > 0xFFFF) {
    use_short_loca = false;
    break;
  }
}

hb_glyph_t *compiled_glyphs = hb_subset_glyphs_compile (glyphs);
if (unlikely (!compiled_glyphs))
  return_trace (false);

hb_blob_t *glyf_blob = hb_glyf_create (compiled_glyphs, glyphs->len, use_short_loca);
if (unlikely (!glyf_blob))
  return_trace (false);

bool result = hb_glyf_serialize (glyf_blob, context->serializer);
hb_blob_destroy (glyf_blob);
hb_subset_glyphs_destroy (glyphs);
hb_free (compiled_glyphs);

return_trace (result);