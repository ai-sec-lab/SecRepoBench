std::vector<hb_codepoint_t> subset_glyphs;
    for (auto glyph : context->plan->glyphs) {
      if (!subset_glyph(context, font, glyph, subset_glyphs)) {
        return_trace(false);
      }
    }

    if (context->plan->normalized_coords) {
      hb_font_destroy(font);
    }

    bool use_short_loca = true;
    std::vector<hb_blob_t*> padded_offsets;
    for (auto glyph : subset_glyphs) {
      hb_blob_t* offset = hb_blob_create(nullptr, 0);
      if (!calculate_padded_offset(font, glyph, offset)) {
        use_short_loca = false;
        hb_blob_destroy(offset);
      } else {
        padded_offsets.push_back(offset);
      }
    }

    hb_glyf_t* glyf = hb_glyf_create();
    if (!serialize_subset_glyphs(glyf, subset_glyphs, use_short_loca, padded_offsets)) {
      return_trace(false);
    }

    for (auto offset : padded_offsets) {
      hb_blob_destroy(offset);
    }

    return true;