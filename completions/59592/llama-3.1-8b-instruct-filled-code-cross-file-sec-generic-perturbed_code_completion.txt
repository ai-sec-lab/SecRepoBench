// Generate a subset of glyphs based on the provided plan and font.
// Populate a list of subset glyphs, checking for failure in the process.
// Destroy the font if it was created for instancing, after using it.
// Calculate padded offsets for each subset glyph and determine if a short loca table can be used.
// Initialize a new glyf object for serialization.
// Serialize the subset of glyphs into the glyf object, using the determined loca format.
// Handle any necessary cleanup of resources, particularly the compiled subset glyphs, if required.
// Return the result of the serialization process as the function's output.
hb_glyf_t *glyf = hb_glyf_create (context->plan->source->num_glyphs);
if (unlikely (!glyf))
  return_trace (false);

hb_glyf_init (glyf, context->plan->source->num_glyphs);

hb_subset_glyph_list_t *glyph_list = hb_subset_glyph_list_create ();
if (unlikely (!glyph_list))
  return_trace (false);

hb_subset_glyph_list_add_all (glyph_list, context->plan->glyphs);

hb_font_t *font = nullptr;
if (context->plan->normalized_coords)
  font = _create_font_for_instancing (context->plan);
if (unlikely (!font))
  return_trace (false);

hb_glyf_serialize_t *serialize = hb_glyf_serialize_create (glyf, font);
if (unlikely (!serialize))
  return_trace (false);

hb_glyf_serialize_set_loca_format (serialize, context->plan->loca_format);
hb_glyf_serialize_set_padded_offsets (serialize, context->plan->padded_offsets);

if (hb_glyf_serialize (serialize, glyf) < 0)
  return_trace (false);

if (font == _create_font_for_instancing (context->plan))
  hb_font_destroy (font);

hb_glyf_serialize_destroy (serialize);
hb_subset_glyph_list_destroy (glyph_list);

return true;