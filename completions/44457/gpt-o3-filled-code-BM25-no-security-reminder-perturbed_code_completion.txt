/*
    Deal with the two separators that build a C-style ternary operator:
      condition  ?  true_part  :  false_part
    They are pushed on the operator stack as oQuest ('?') and oColon (':').
    When we encounter either of them at the top of the operator stack we
    transform it into the appropriate run-time jump instruction and remember
    the element index so that the real destination can be patched later by
    ResolveTernaryAddresses().
  */
  if (fxinfo->usedOprStack == 0)
    return MagickTrue;          /* nothing to do */

  {
    OperatorE top_op = fxinfo->OperatorStack[fxinfo->usedOprStack-1];

    if ((top_op != oQuest) && (top_op != oColon))
      return MagickTrue;        /* top operator is not part of a ternary */

    if (top_op == oQuest)       /* first separator, the '?' */
    {
      /* make sure we are not already inside another "?:"
         without having seen the matching ':' yet            */
      if ((ptern->addrQuery != NULL_ADDRESS) ||
          (ptern->addrColon != NULL_ADDRESS))
      {
        (void) ThrowMagickException(
          fxinfo->exception, GetMagickModule(), OptionError,
          "Misplaced '?' in ternary expression", "at '%s'",
          SetShortExp(fxinfo));
        return MagickFalse;
      }

      /* remove the '?' from the operator stack */
      fxinfo->usedOprStack--;

      /* remember where the conditional jump will be stored */
      ptern->addrQuery = fxinfo->usedElements;

      /* add a jump-if-zero placeholder – patched later           */
      if (!AddAddressingElement(fxinfo, rJumpZ, NULL_ADDRESS))
        return MagickFalse;
    }
    else                        /* top_op == oColon  -> second separator ':' */
    {
      /* there must have been a preceding '?' and only one ':' allowed */
      if ((ptern->addrQuery == NULL_ADDRESS) ||
          (ptern->addrColon != NULL_ADDRESS))
      {
        (void) ThrowMagickException(
          fxinfo->exception, GetMagickModule(), OptionError,
          "Misplaced ':' in ternary expression", "at '%s'",
          SetShortExp(fxinfo));
        return MagickFalse;
      }

      /* remove the ':' from the operator stack */
      fxinfo->usedOprStack--;

      /* ensure the value calculated for the true branch is left on stack */
      if (fxinfo->usedElements)
      {
        ElementT *pel = &fxinfo->Elements[fxinfo->usedElements-1];
        pel->DoPush = MagickTrue;
      }

      /* remember where the unconditional jump will be stored */
      ptern->addrColon = fxinfo->usedElements;

      /* add an unconditional jump placeholder – destination fixed later   */
      if (!AddAddressingElement(fxinfo, rJump, NULL_ADDRESS))
        return MagickFalse;
    }
  }