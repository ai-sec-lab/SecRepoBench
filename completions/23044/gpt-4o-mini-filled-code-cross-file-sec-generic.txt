const unsigned char *a = (const unsigned char *)s1;
	const unsigned char *b = (const unsigned char *)s2;
	const unsigned char *eb = b + maxlen;

	// Handle whitespace flags and calculate endpoint `eb`
	if (flags & (STRING_COMPACT_WHITESPACE | STRING_COMPACT_OPTIONAL_WHITESPACE)) {
		// Adjust endpoint based on whitespace flags
		while (len > 0 && isspace(*a)) {
			a++;
			len--;
		}
		eb = b + maxlen;
	}

	// Ensure we do not exceed the maximum length
	if (len > maxlen) {
		len = maxlen;
	}

	// Perform the string comparison
	while (len-- > 0) {
		if (b >= eb) {
			v = 1; // Reached the end of the second string
			break;
		}
		if ((flags & STRING_IGNORE_LOWERCASE) && islower(*a)) {
			if ((v = tolower(*b++) - *a++) != '\0')
				break;
		} else if ((flags & STRING_IGNORE_UPPERCASE) && isupper(*a)) {
			if ((v = toupper(*b++) - *a++) != '\0')
				break;
		} else {
			if ((v = *b++ - *a++) != '\0')
				break;
		}
	}