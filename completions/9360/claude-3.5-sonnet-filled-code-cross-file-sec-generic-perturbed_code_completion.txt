for (n=1; n > 0; )
{
  end=q;
  while ((*end != '\0') && (*end != '}'))
    end++;
  if (*end == '\0')
    break;
  if ((*q == '{') && (*(q+1) == '}'))
    {
      n++;
      q+=2;
      continue;
    }
  if (*q == '}')
    {
      n--;
      q++;
      continue;
    }
  GetNextToken(q,&q,extent,token);
  if (*token == '}')
    {
      n--;
      continue;
    }
  if (n == 1)
    {
      (void) CopyMagickString(name,token,MagickPathExtent);
      GetNextToken(q,&q,extent,token);
      (void) CopyMagickString(token,q,(size_t) (end-q+1));
      (void) ConcatenateMagickString(token,"",MagickPathExtent);
      (void) AddValueToSplayTree(macros,ConstantString(name),
        ConstantString(token));
    }
}