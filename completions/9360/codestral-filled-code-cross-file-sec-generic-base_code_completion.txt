// Extract macros from the MVG string.
ssize_t n = 0;
char name[MagickPathExtent];
const char *start, *end;

while (*q != '\0')
{
  if (LocaleCompare("push", token) == 0)
  {
    GetNextToken(q, &q, extent, token);
    if (*q == '"')
    {
      n++;
      GetNextToken(q, &q, extent, token);
      start = q;
      continue;
    }
  }
  else if (LocaleCompare("pop", token) == 0)
  {
    n--;
    if (n < 0)
    {
      (void) ThrowMagickException(exception, GetMagickModule(), DrawError, "UnbalancedPushPop", "`%s'", primitive);
      break;
    }
    if (n == 0)
    {
      end = q;
      while (isspace((int) *end))
        end++;
      size_t len = end - start;
      char *macro = (char *) AcquireQuantumMemory(len + 1, sizeof(char));
      if (macro == NULL)
      {
        (void) ThrowMagickException(exception, GetMagickModule(), ResourceLimitError, "MemoryAllocationFailed", "`%s'", primitive);
        break;
      }
      memcpy(macro, start, len);
      macro[len] = '\0';
      (void) AddValueToSplayTree(macros, ConstantString(name), macro);
      break;
    }
  }
  GetNextToken(q, &q, extent, token);
}