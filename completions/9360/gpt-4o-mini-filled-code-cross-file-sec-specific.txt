n=0;
            while ((*q != '\n') && (*q != '\0'))
            {
              GetNextToken(q,&q,extent,token);
              if (*token == '\0')
                break;
              if (LocaleCompare("pop",token) == 0)
              {
                n--;
                if (n < 0)
                  ThrowMagickException(exception,GetMagickModule(),
                    DrawError,"UnbalancedGraphicContextPushPop","`%s'",token);
                break;
              }
              // Handle nested push commands
              if (LocaleCompare("push",token) == 0)
                n++;
            }
            if (n == 0)
            {
              // Add the macro to the splay tree
              char *macro = AcquireString(start);
              size_t length = q - start;
              if (length > 0)
              {
                // Ensure we do not exceed the allocated buffer
                if (length < extent)
                {
                  (void) CopyMagickString(token, macro, length + 1);
                  AddValueToSplayTree(macros, ConstantString(token), macro);
                }
                else
                {
                  RelinquishMagickMemory(macro);
                  ThrowMagickException(exception, GetMagickModule(),
                    ResourceLimitError, "MemoryAllocationFailed", "`%s'", token);
                }
              }
              RelinquishMagickMemory(macro);
            }