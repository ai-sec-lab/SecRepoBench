// Extract macros from the MVG string. The code iterates through the string 
// to find 'push' and 'pop' commands, handling nested structures accordingly.
// It skips comments starting with '#'. When a complete macro is identified 
// (when the nesting level `n` drops below zero), it extracts the macro 
// definition between `start` and `end` pointers, and adds it to a splay tree 
// for later retrieval using the macro name as the key.
ssize_t n = 0;
while (*q != '\0') {
    GetNextToken(q, &q, extent, token);
    if (*token == '\0')
        break;
    if (*token == '#') {
        // Skip comment
        while ((*q != '\n') && (*q != '\0'))
            q++;
        continue;
    }
    if (LocaleCompare("push", token) == 0) {
        n++;
    } else if (LocaleCompare("pop", token) == 0) {
        n--;
        if (n < 0) {
            // Macro definition found
            char name[MagickPathExtent];
            GetNextToken(start, &end, extent, name);
            AddValueToSplayTree(macros, ConstantString(name), AcquireString(start));
            n = 0;
        }
    }
    if (n > 0) {
        // Inside a macro definition
        start = q;
    }
}