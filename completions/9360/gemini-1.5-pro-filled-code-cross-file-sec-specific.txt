end=q;
            n=0;
            while ((*q != '\0') && (n >= 0))
            {
              GetNextToken(q,&q,extent,token);
              if (*token == '#')
                {
                  /*
                    Skip comment.
                  */
                  while ((*q != '\n') && (*q != '\0'))
                    q++;
                  continue;
                }
              if (LocaleCompare("push",token) == 0)
                n++;
              if (LocaleCompare("pop",token) == 0)
                n--;
              if (n < 0)
                end=q-strlen(token)-1; // Securely calculate 'end' to prevent overflow
            }
            if (n < 0) // Check if a complete macro is found
            {
              char
                *macro;

              /*
                Add macro to splay tree. Note that `AddValueToSplayTree` copies the macro definition, so we can safely destroy `macro` later.
              */
              macro=AcquireString(start);
              macro[end-start]='\0'; // Ensure the macro string is null-terminated
              (void) AddValueToSplayTree(macros,token,CloneString(macro));
              macro=DestroyString(macro);
            }