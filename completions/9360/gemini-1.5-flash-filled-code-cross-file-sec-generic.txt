n++;
            end=q;
            while (n > 0)
            {
              GetNextToken(q,&q,extent,token);
              if (*token == '\0')
                break;
              if (*token == '#')
                {
                  while ((*q != '\n') && (*q != '\0'))
                    q++;
                  continue;
                }
              if (LocaleCompare("push",token) == 0)
                n++;
              else if (LocaleCompare("pop",token) == 0)
                n--;
              if (n <= 0)
                end=q;
            }
            if (n < 0)
              ThrowMagickException(exception,GetMagickModule(),DrawError,
                "UnbalancedPushPop","`%s'",token);
            {
              size_t
                length;

              char
                *macro;

              length=end-start;
              macro=AcquireQuantumMemory(length+MagickPathExtent,sizeof(*macro));
              if (macro == (char *) NULL)
                ThrowMagickException(exception,GetMagickModule(),
                  ResourceLimitError,"MemoryAllocationFailed","`%s'",token);
              (void) CopyMagickString(macro,start,length+MagickPathExtent);
              AddValueToSplayTree(macros,name,macro);
            }
          }
        else
          {
            /*
              Unnamed macro (e.g. push graphic-context { ... }).
            */
            char
              *macro;

            size_t
              length;

            GetNextToken(q,&q,extent,token);
            while (LocaleCompare("pop",token) != 0)
            {
              GetNextToken(q,&q,extent,token);
              if (*token == '\0')
                break;
            }
            length=q-token;
            macro=AcquireQuantumMemory(length+MagickPathExtent,sizeof(*macro));
            if (macro == (char *) NULL)
              ThrowMagickException(exception,GetMagickModule(),
                ResourceLimitError,"MemoryAllocationFailed","`%s'",token);
            (void) CopyMagickString(macro,token,length+MagickPathExtent);
            AddValueToSplayTree(macros,"unnamed",macro);
          }
      }