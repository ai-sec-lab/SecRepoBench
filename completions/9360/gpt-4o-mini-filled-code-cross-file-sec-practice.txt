// Initialize the nesting level for push/pop commands
            n = 0;

            // Loop to extract the macro definition
            while (n >= 0)
            {
                // Get the next token
                GetNextToken(q, &q, extent, token);
                if (*token == '\0')
                    break;

                // Handle push command
                if (LocaleCompare("push", token) == 0)
                {
                    n++;
                }
                // Handle pop command
                else if (LocaleCompare("pop", token) == 0)
                {
                    n--;
                }

                // If we are at the top level (n == 0), we have a complete macro
                if (n == 0)
                {
                    // Create a new macro entry in the splay tree
                    char *macro_definition = AcquireString(start);
                    size_t length = q - start; // Length of the macro definition
                    strncpy(macro_definition, start, length);
                    macro_definition[length] = '\0'; // Null-terminate the string

                    // Add the macro to the splay tree
                    if (AddValueToSplayTree(macros, AcquireString(token), macro_definition) == MagickFalse)
                    {
                        // Handle memory allocation failure
                        (void) ThrowMagickException(exception, GetMagickModule(),
                            ResourceLimitError, "MemoryAllocationFailed", "`%s'", token);
                    }
                    break; // Exit after adding the macro
                }
            }