n = 0; // Initialize nesting level
            while (n >= 0) // Continue until all nested structures are closed
            {
                GetNextToken(q, &q, extent, token);
                if (LocaleCompare("pop", token) == 0)
                {
                    n--; // Decrease nesting level on pop
                    if (n < 0)
                    {
                        // If n drops below zero, we have a complete macro
                        // Extract the macro definition
                        size_t length = q - start; // Calculate length of the macro
                        char *macro_definition = (char *) AcquireMemory(length + 1);
                        if (macro_definition == NULL)
                        {
                            ThrowMagickException(exception, GetMagickModule(),
                                ResourceLimitError, "MemoryAllocationFailed", "`%s'", "macro_definition");
                        }
                        strncpy(macro_definition, start, length);
                        macro_definition[length] = '\0'; // Null-terminate the string

                        // Add the macro to the splay tree
                        if (AddValueToSplayTree(macros, AcquireString(token), macro_definition) == MagickFalse)
                        {
                            ThrowMagickException(exception, GetMagickModule(),
                                ResourceLimitError, "MemoryAllocationFailed", "`%s'", token);
                        }
                        RelinquishMagickMemory(macro_definition); // Free the allocated memory
                    }
                }
                else if (LocaleCompare("push", token) == 0)
                {
                    n++; // Increase nesting level on push
                }
                else
                {
                    // Handle other tokens as needed
                }
            }