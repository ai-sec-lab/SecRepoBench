// Check if the current token matches the graphic context ID, break if true.
if (LocaleCompare(graphic_context[n]->id, token) == 0)
  break;

// Retrieve the MVG class definition from the macros using the token.
const char *mvg_class = (const char *) GetValueFromSplayTree(macros, token);

// If the class definition is found,
if (mvg_class!= (const char *) NULL)
{
  // inject the class elements into the stream at the current offset.
  size_t offset = (size_t) (q - primitive);
  size_t length = strlen(mvg_class);
  char *new_primitive = (char *) AcquireQuantumMemory(offset + length + strlen(primitive) + 1, sizeof(*new_primitive));
  if (new_primitive == (char *) NULL)
  {
    primitive = DestroyString(primitive);
    ThrowBinaryException(ResourceLimitError, "MemoryAllocationFailed", image->filename);
  }
  (void) CopyMagickString(new_primitive, primitive, offset + 1);
  (void) CopyMagickString(new_primitive + offset, mvg_class, length + 1);
  (void) CopyMagickString(new_primitive + offset + length, primitive + offset, strlen(primitive) - offset + 1);
  primitive = DestroyString(primitive);
  primitive = new_primitive;

  // Concatenate the MVG class to the elements string, followed by the remaining content.
  // Free the previous primitive string and update it with the new elements.
  // Adjust the stream pointer to the new position in the modified primitive.
  q = primitive + offset + length;
}