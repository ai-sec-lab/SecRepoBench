u32 hdr, size;
u32 pos = (u32) gf_bs_get_position(bs);
if (pos >= size) break;
hdr = gf_bs_read_u8(bs);
if (hdr & 0x80) {
    if (gf_bs_available(bs) < 2) break;
    size = gf_bs_read_u16(bs);
} else {
    if (gf_bs_available(bs) < 1) break;
    size = gf_bs_read_u8(bs);
}
if (!size || (pos + size > size)) break;

gf_bs_skip_bytes(bs, 1);
if (!gf_m4a_parse_config(bs, &acfg, 0)) {
    nb_frames++;
    if (acfg.base_sr_index > 12) break;
} else {
    nb_skip += size;
}
gf_bs_seek(bs, pos + size);