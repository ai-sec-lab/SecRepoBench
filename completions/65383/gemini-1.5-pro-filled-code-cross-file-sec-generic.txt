case 'H':
    if (aux_end - aux < 4)
        goto err;

    if (!tm->blk) {
        if (!(tm->blk = cram_new_block(EXTERNAL, key)))
            goto err;
        codec->u.e_byte_array_len.val_codec->out = tm->blk;
    }

    aux+=3;
    if (aux_end - aux < 1) // Check for sufficient data remaining
        goto err;

    size_t hex_len = strlen(aux);
    if (aux[hex_len-1] == '\0')  // Exclude null terminator from length
        hex_len--;

    if (hex_len % 2 != 0) {
        hts_log_error("Hex string must have even length");
        goto err;
    }

    size_t decoded_len = hex_len / 2;
    char *decoded_bytes = (char *)malloc(decoded_len);
    if (!decoded_bytes)
        goto err;

    for (size_t i = 0; i < decoded_len; i++) {
        char hex_byte[3];
        hex_byte[0] = aux[2 * i];
        hex_byte[1] = aux[2 * i + 1];
        hex_byte[2] = '\0';

        char *endptr;
        decoded_bytes[i] = (char)strtol(hex_byte, &endptr, 16);
        if (*endptr != '\0') {
            hts_log_error("Invalid hex character");
            free(decoded_bytes);
            goto err;
        }
    }

    BLOCK_APPEND(tm->blk, decoded_bytes, decoded_len);
    free(decoded_bytes);

    while (aux < aux_end && *aux++);
    break;

case 'B': {
    if (aux_end - aux < 5)
        goto err;

    if (!tm->blk) {
        if (!(tm->blk = cram_new_block(EXTERNAL, key)))
            goto err;
        codec->u.e_byte_array_len.val_codec->out = tm->blk;
    }

    aux+=3;
    char sub_type = *aux++;
    int count = bam_aux2i((uint8_t *)aux);
    int b_size = aux_end - aux;
    int expected_size = 0;

    switch (sub_type) {
    case 'c': case 'C': expected_size = count * 1; break;
    case 's': case 'S': expected_size = count * 2; break;
    case 'i': case 'I': case 'f': expected_size = count * 4; break;
    default:
        hts_log_error("Unhandled sub-type '%c' for 'B' tag", sub_type);
        goto err;
    }

    if (b_size < expected_size)
        goto err;

    //codec->encode(s, codec, aux, expected_size);
    BLOCK_APPEND(tm->blk, aux, expected_size);
    aux += expected_size;
    break;
}