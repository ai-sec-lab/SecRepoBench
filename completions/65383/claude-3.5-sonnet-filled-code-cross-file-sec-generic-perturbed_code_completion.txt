case 'H': case 'Z':
    {
        if (!tm->blk) {
            if (!(tm->blk = cram_new_block(EXTERNAL, key)))
                goto err;
            codec->u.e_byte_array_len.val_codec->out = tm->blk;
        }

        aux += 3;
        while (aux < aux_end && *aux) {
            BLOCK_APPEND_CHAR(tm->blk, *aux);
            aux++;
        }
        if (aux >= aux_end)
            goto err;
        BLOCK_APPEND_CHAR(tm->blk, *aux);
        aux++;
    }
    break;

case 'B':
    {
        int type = aux[3], blen;
        uint32_t count = 0;

        if (aux_end - aux < 8)
            goto err;

        if (!tm->blk) {
            if (!(tm->blk = cram_new_block(EXTERNAL, key)))
                goto err;
            codec->u.e_byte_array_len.val_codec->out = tm->blk;
        }

        // Ensure we have enough data remaining
        switch (type) {
        case 'c': case 'C':
            blen = 1;
            break;
        case 's': case 'S':
            blen = 2;
            break;
        case 'i': case 'I': case 'f':
            blen = 4;
            break;
        default:
            goto err;
        }

        count = le_to_u32(&aux[4]);
        if (aux_end - aux - 8 < blen * count)
            goto err;

        // Encode the entire array
        BLOCK_APPEND(tm->blk, &aux[3], blen * count + 5);
        aux += 8 + blen * count;
    }
    break;