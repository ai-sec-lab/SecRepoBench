for (i = xd - 1; i >= ydigits; i--) {
  mp_limb_t qd = (x.p[i] == z) ? MP_LIMB_MAX : (mp_dbl_limb)x.p[i] * BASE / z;
  mp_dbl_limb b = 0;
  for (size_t j = 0; j < ydigits; j++) {
    mp_dbl_limb p = (mp_dbl_limb)qd * y.p[j] + b;
    b = p >> DIG_SIZE;
    if (x.p[i-ydigits+j] < (p & MP_LIMB_MAX)) b++;
    x.p[i-ydigits+j] -= p & MP_LIMB_MAX;
  }
  while (b > 0) {
    qd--;
    mp_dbl_limb c = 0;
    for (size_t j = 0; j < ydigits; j++) {
      c += x.p[i-ydigits+j] + y.p[j];
      x.p[i-ydigits+j] = c & MP_LIMB_MAX;
      c >>= DIG_SIZE;
    }
    b -= 1 - c;
  }
  q.p[i-ydigits] = qd;
}