for (i = xd - yd; i >= 0; i--) {
    mp_dbl_limb qhat;
    size_t j = yd + i - 1;

    if (xd == yd)
      qhat = x.p[j] / z;
    else {
      mp_dbl_limb x1 = ((mp_dbl_limb)x.p[j+1] << DIG_SIZE) | x.p[j];
      qhat = x1 / z;
    }
    while (1) {
      mp_dbl_limb t1, t2;
      size_t k = i;
      mp_dbl_limb x0 = x.p[j];
      t1 = qhat * y.p[yd-2];
      t2 = ((mp_dbl_limb)x.p[j-1] << DIG_SIZE) | x.p[j-2];
      if (t1 > t2) {
        qhat--;
        continue;
      }
      usubmul(mrb, &x, &y, qhat, k);
      if (x.p[j] != x0)
        break;
      qhat++;
      uaddmul(mrb, &x, &y, 1, k);
    }
    q.p[i] = (mp_limb)qhat;
  }