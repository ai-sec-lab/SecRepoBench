for (i = xd - yd; i-- > 0;) {
    mp_dbl_limb qhat = (x.p[i + yd] * MP_LIMB_MAX + x.p[i + yd - 1]) / z;
    if (qhat >= MP_LIMB_MAX) qhat = MP_LIMB_MAX - 1;
    mp_dbl_limb t[yd + 1];
    mp_dbl_limb cy = 0;
    for (size_t j = 0; j < yd; j++) {
      t[j] = qhat * y.p[j] + cy;
      cy = t[j] / MP_LIMB_MAX;
      t[j] %= MP_LIMB_MAX;
    }
    t[yd] = cy;
    while (ucmp_mag(&x, i, t, yd + 1) < 0) {
      qhat--;
      for (size_t j = 0; j < yd; j++) {
        t[j] -= y.p[j];
        if (t[j] > MP_LIMB_MAX) {
          t[j] += MP_LIMB_MAX;
          t[j + 1]--;
        }
      }
    }
    q.p[i] = qhat;
    for (size_t j = 0; j < yd; j++) {
      x.p[i + j] -= t[j];
      if (x.p[i + j] > MP_LIMB_MAX) {
        x.p[i + j] += MP_LIMB_MAX;
        x.p[i + j + 1]--;
      }
    }
  }