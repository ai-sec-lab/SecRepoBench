for (i = xd - yd; i >= 0; i--) {
  mp_limb qhat, rhat;
  mp_dbl_limb n = ((mp_dbl_limb)x.p[i+yd] << DIG_SIZE) | x.p[i+yd-1];
  qhat = n / z;
  rhat = n % z;
  if (qhat > DIG_MAX) qhat = DIG_MAX;
  while (qhat * y.p[yd-2] > ((rhat << DIG_SIZE) | x.p[i+yd-2])) {
    qhat--;
    rhat += z;
    if (rhat > DIG_MAX) break;
  }
  mp_dbl_limb borrow = 0;
  for (size_t j = 0; j < yd; j++) {
    mp_dbl_limb p = qhat * y.p[j];
    mp_dbl_limb t = x.p[i+j] - borrow - (p & DIG_MAX);
    x.p[i+j] = t & DIG_MAX;
    borrow = (p >> DIG_SIZE) - (t >> DIG_SIZE);
  }
  if (x.p[i+yd] < borrow) {
    mp_limb carry = 0;
    for (size_t j = 0; j < yd; j++) {
      mp_dbl_limb t = (mp_dbl_limb)x.p[i+j] + y.p[j] + carry;
      x.p[i+j] = t & DIG_MAX;
      carry = t >> DIG_SIZE;
    }
    x.p[i+yd] += carry;
    qhat--;
  }
  q.p[i] = qhat;
}