for (i = xd - yd; i >= 0; i--) {
    mp_dbl_limb qhat = (((mp_dbl_limb)x.p[i+yd-1]<<DIG_SIZE) + x.p[i+yd-2]) / z;
    if (qhat > MAX_LIMB) {
      qhat = MAX_LIMB;
    }
    mp_dbl_limb borrow = 0;
    for (size_t j = 0; j < yd; j++) {
      mp_dbl_limb p = (mp_dbl_limb)y.p[j] * qhat;
      p += borrow;
      borrow = 0;
      mp_limb xx = x.p[i+j];
      if (xx < p) {
        borrow = 1;
        xx += BASE;
      }
      x.p[i+j] = xx - p;
    }

    if (x.p[i+yd] < borrow) {
      borrow = 0;
      for (size_t j = 0; j < yd; j++) {
        mp_limb t = x.p[i+j] + y.p[j] + borrow;
        borrow = t>=BASE;
        x.p[i+j] = t - borrow*BASE;
      }
      qhat--;
    }
    q.p[i] = qhat;
    x.sz = i+yd;
  }