for (i = xd - yd; i >= 0; i--) {
  mp_limb qhat = (x.p[i+yd] == z) ? MP_LIMB_MAX : ((mp_dbl_limb)x.p[i+yd] << DIG_SIZE | x.p[i+yd-1]) / z;
  mp_dbl_limb borrow = 0;
  mp_dbl_limb carry = 0;

  for (size_t j = 0; j < yd; j++) {
    mp_dbl_limb prod = (mp_dbl_limb)qhat * y.p[j];
    mp_dbl_limb diff = (mp_dbl_limb)x.p[i+j] - (prod & MP_LIMB_MASK) - borrow;
    x.p[i+j] = diff & MP_LIMB_MASK;
    borrow = (prod >> DIG_SIZE) - (diff >> DIG_SIZE);
  }

  mp_dbl_limb diff = (mp_dbl_limb)x.p[i+yd] - borrow;
  x.p[i+yd] = diff & MP_LIMB_MASK;

  q.p[i] = qhat;

  if (diff >> DIG_SIZE) {
    q.p[i]--;
    for (size_t j = 0; j < yd; j++) {
      carry += (mp_dbl_limb)x.p[i+j] + y.p[j];
      x.p[i+j] = carry & MP_LIMB_MASK;
      carry >>= DIG_SIZE;
    }
    x.p[i+yd] += carry;
  }
}