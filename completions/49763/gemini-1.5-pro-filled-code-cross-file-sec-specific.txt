for (i = xd - yd; i >= 0; i--) {
    mp_dbl_limb qhat = (((mp_dbl_limb)x.p[i+yd] << DIG_SIZE) | x.p[i+yd-1]) / z;
    if (qhat > MAX_LIMB)
      qhat = MAX_LIMB;
    mp_dbl_limb borrow = 0;
    for (size_t j = 0; j < yd; j++) {
      mp_dbl_limb p = (mp_dbl_limb)y.p[j] * qhat;
      p += borrow;
      borrow = p >> DIG_SIZE;
      if (x.p[i+j] < (mp_limb)p)
        borrow++;
      x.p[i+j] -= (mp_limb)p;
    }
    if (x.p[i+yd] < borrow) {
      borrow = 0;
      for (size_t j = 0; j < yd; j++) {
        mp_dbl_limb p = x.p[i+j] + y.p[j] + borrow;
        borrow = p >> DIG_SIZE;
        x.p[i+j] = (mp_limb)p;
      }
      qhat--;
    }
    x.p[i+yd] -= borrow;
    q.p[i] = (mp_limb)qhat;
  }