for (i = xd; i-- > yd;) {
    mp_dbl_limb x2 = (mp_dbl_limb)x.p[i] << DIG_SIZE | x.p[i-1];
    mp_limb qhat = x2 / z;
    mp_limb rhat = x2 % z;
    if (qhat >= (1 << DIG_SIZE)) {
      qhat = (1 << DIG_SIZE) - 1;
      rhat += z;
    }
    while (rhat < (1 << DIG_SIZE) && qhat * y.p[yd-2] > ((rhat << DIG_SIZE) | x.p[i-2])) {
      qhat--;
      rhat += z;
    }
    mpz_t t;
    mpz_init(mrb, &t);
    mpz_mul_int(mrb, &t, &y, qhat);
    if (ucmp(&x, &t) < 0) {
      qhat--;
      mpz_sub(mrb, &t, &t, &y);
    }
    mpz_sub(mrb, &x, &x, &t);
    q.p[i-yd] = qhat;
    mpz_clear(mrb, &t);
  }