/* compute the amount of data available from the current cursor */
    if (in->buf == NULL)
        len = in->length;
    else
        len = (int)xmlBufUse(in->buf->buffer);
    /* remaining length starting from current position */
    len -= base;
    if (len <= 0)
        return (-1);

    /* length of the sequence we are looking for */
    int seqlen = 1 + ((next != 0) ? 1 : 0) + ((third != 0) ? 1 : 0);

    /* pointer to the current position in the buffer */
    buf = in->cur;

    /* start searching from the last stored check index */
    int i = ctxt->checkIndex;
    if (i < 0)
        i = 0;

    incomment = iscomment;  /* if iscomment == 1 we start inside a comment */

    for ( ; i + seqlen <= len; i++) {
        xmlChar c = buf[i];

        /* Handle attribute values if requested */
        if (ignoreAttrValue) {
            if (invalue) {
                if (c == valdellim)
                    invalue = 0;
                continue;
            } else if ((c == '"') || (c == '\'')) {
                invalue = 1;
                valdellim = (char)c;
                continue;
            }
        }

        /* Manage comment sections when we are *not* searching inside one */
        if (!iscomment) {
            if (incomment) {
                /* exiting a comment */
                if ((c == '-') && (i + 2 < len) &&
                    (buf[i + 1] == '-') && (buf[i + 2] == '>')) {
                    incomment = 0;
                    i += 2;          /* Skip past "-->" */
                }
                continue;
            } else {
                /* entering a comment */
                if ((c == '<') && (i + 3 < len) &&
                    (buf[i + 1] == '!') && (buf[i + 2] == '-') &&
                    (buf[i + 3] == '-')) {
                    incomment = 1;
                    i += 3;          /* Skip past "<!--" */
                    continue;
                }
            }
        }

        /* Check for the requested sequence, respecting comment context */
        if (((iscomment && incomment) || (!iscomment && !incomment)) &&
            (c == first)) {
            if (next == 0) {
                ctxt->checkIndex = i;
                return (i);
            }
            if ((i + 1 < len) && (buf[i + 1] == next)) {
                if (third == 0) {
                    ctxt->checkIndex = i;
                    return (i);
                }
                if ((i + 2 < len) && (buf[i + 2] == third)) {
                    ctxt->checkIndex = i;
                    return (i);
                }
            }
        }
    }

    /* not found, remember how far we checked */
    ctxt->checkIndex = i;