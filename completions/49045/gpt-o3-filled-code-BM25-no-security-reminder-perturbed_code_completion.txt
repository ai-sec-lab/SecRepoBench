mrb_int base = 10;
  static const char digits[] = "0123456789abcdefghijklmnopqrstuvwxyz";
  /* sign + 64bit binary digits + '\0' */
  char buf[66];
  char *p = &buf[sizeof(buf) - 1];
  mrb_int val;
  mrb_uint uval;
  mrb_bool neg = FALSE;

  /* fetch optional base argument */
  mrb_get_args(mrb, "|i", &base);

  /* validate base */
  if (base < 2 || base > 36) {
    mrb_raisef(mrb, E_ARGUMENT_ERROR, "base must be between 2 and 36 (given %i)", base);
  }

  val = mrb_integer(obj);

  /* null-terminate buffer */
  *p = '\0';

  /* special case for zero */
  if (val == 0) {
    *--p = '0';
    return mrb_str_new_cstr(mrb, p);
  }

  /* handle sign */
  if (val < 0) {
    neg = TRUE;
    /* convert to unsigned to avoid overflow on MIN value */
    uval = (mrb_uint)0 - (mrb_uint)val;
  }
  else {
    uval = (mrb_uint)val;
  }

  /* convert number to string */
  while (uval > 0) {
    *--p = digits[uval % (mrb_uint)base];
    uval /= (mrb_uint)base;
  }

  if (neg) {
    *--p = '-';
  }

  /* create Ruby string from buffer */
  return mrb_str_new_cstr(mrb, p);