const char *xmp_end = "<?xpacket end=\"w\"?>";
size_t xmp_end_len = strlen(xmp_end);

if (strncmp(name, "xmp", 3) == 0)
{
  char *end = strstr((char *)profile->datum, xmp_end);
  if (end != NULL)
  {
    size_t new_length = (end - (char *)profile->datum) + xmp_end_len;
    if (new_length < profile->length)
    {
      profile->length = new_length;
    }
  }
}
else if (strncmp(name, "exif", 4) == 0)
{
  if (profile->length > 4 && memcmp(profile->datum, "Exif", 4) != 0)
  {
    unsigned char *new_data = (unsigned char *)AcquireQuantumMemory(profile->length + 6, sizeof(unsigned char));
    if (new_data != NULL)
    {
      memcpy(new_data, "Exif\0\0", 6);
      memcpy(new_data + 6, profile->datum, profile->length);
      RelinquishMagickMemory(profile->datum);
      profile->datum = new_data;
      profile->length += 6;
    }
  }
}