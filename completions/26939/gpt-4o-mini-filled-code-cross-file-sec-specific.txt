size_t length = GetStringInfoLength(profile);
  unsigned char *data = GetStringInfoDatum(profile);
  
  if (strcmp(name, "XMP") == 0) {
    const char *end_marker = "<?xpacket end=\"w\"?>";
    size_t end_marker_length = strlen(end_marker);
    for (size_t i = 0; i <= length - end_marker_length; i++) {
      if (memcmp(data + i, end_marker, end_marker_length) == 0) {
        SetStringInfoLength(profile, i + end_marker_length);
        break;
      }
    }
  } else if (strcmp(name, "EXIF") == 0) {
    if (length > 4 && memcmp(data, "Exif", 4) != 0) {
      StringInfo *new_profile = AcquireStringInfo(length + 4);
      unsigned char *new_data = GetStringInfoDatum(new_profile);
      memcpy(new_data, "Exif", 4);
      memcpy(new_data + 4, data, length);
      SetStringInfoLength(new_profile, length + 4);
      profile = new_profile;
    }
  }