const char *xmp_end = "<?xpacket end=\"w\"?>";
size_t xmp_end_len = strlen(xmp_end);

if (LocaleNCompare(name, "xmp", 3) == 0)
{
  char *p = (char *)memchr(profile->datum, '>', profile->length);
  if (p != (char *) NULL)
  {
    p = strstr(p, xmp_end);
    if (p != (char *) NULL)
    {
      size_t offset = (size_t) (p - (char *) profile->datum);
      if ((offset + xmp_end_len) < profile->length)
        profile->length = offset + xmp_end_len;
    }
  }
}
else if (LocaleNCompare(name, "exif", 4) == 0)
{
  if ((profile->length > 4) &&
      (LocaleNCompare((char *) profile->datum, "Exif", 4) != 0) &&
      (profile->datum[0] == 0x49 || profile->datum[0] == 0x4D))
  {
    StringInfo *new_profile;
    new_profile = AcquireStringInfo(profile->length + 6);
    if (new_profile != (StringInfo *) NULL)
    {
      unsigned char *datum = GetStringInfoDatum(new_profile);
      (void) memcpy(datum, "Exif\0\0", 6);
      (void) memcpy(datum + 6, profile->datum, profile->length);
      profile->datum = datum;
      profile->length += 6;
    }
  }
}