// Validate the input name to ensure it is not NULL and does not exceed a certain length
  if (name == NULL || strlen(name) > MAX_PROFILE_NAME_LENGTH) {
    // Log the error and return early
    LogMagickEvent(ErrorEvent, GetMagickModule(), "Invalid profile name");
    return;
  }

  // Check if the profile is NULL
  if (profile == NULL || profile->length == 0) {
    LogMagickEvent(ErrorEvent, GetMagickModule(), "Profile is NULL or empty");
    return;
  }

  // Handle XMP profiles
  if (strcmp(name, "XMP") == 0) {
    const char *xpacket_end = "<?xpacket end=\"w\"?>";
    size_t end_marker_length = strlen(xpacket_end);
    
    // Find the end marker in the profile data
    unsigned char *data = (unsigned char *) profile->datum;
    size_t data_length = profile->length;
    unsigned char *end_marker_position = (unsigned char *) memmem(data, data_length, xpacket_end, end_marker_length);
    
    if (end_marker_position != NULL) {
      // Truncate the profile data to the end marker
      profile->length = end_marker_position - data + end_marker_length;
      profile->datum[profile->length] = '\0'; // Null-terminate the string
    }
  }
  // Handle EXIF profiles
  else if (strcmp(name, "EXIF") == 0) {
    const char *exif_prefix = "Exif";
    size_t exif_prefix_length = strlen(exif_prefix);
    
    // Check if the profile starts with the expected "Exif" prefix
    if (profile->length >= exif_prefix_length) {
      if (memcmp(profile->datum, exif_prefix, exif_prefix_length) != 0) {
        // Prepend the correct "Exif" header
        size_t new_length = profile->length + exif_prefix_length;
        profile->datum = (unsigned char *) ResizeQuantumMemory(profile->datum, new_length, sizeof(unsigned char));
        if (profile->datum == NULL) {
          LogMagickEvent(ErrorEvent, GetMagickModule(), "Memory allocation failed");
          return;
        }
        memmove(profile->datum + exif_prefix_length, profile->datum, profile->length);
        memcpy(profile->datum, exif_prefix, exif_prefix_length);
        profile->length = new_length;
      }
    }
  }
  // Log successful profile repair
  LogMagickEvent(InfoEvent, GetMagickModule(), "Successfully repaired profile: %s", name);