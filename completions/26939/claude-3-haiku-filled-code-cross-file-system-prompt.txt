size_t xmp_end = 0;
size_t exif_start = 0;

// Check for XMP profile
if (strstr((const char*)profile->data, "<?xpacket end=\"w\"?>") != NULL) {
    xmp_end = strstr((const char*)profile->data, "<?xpacket end=\"w\"?>") - (const char*)profile->data + strlen("<?xpacket end=\"w\"?>");
    profile->length = xmp_end;
}

// Check for EXIF profile
if (strncmp((const char*)profile->data, "Exif", 4) != 0) {
    exif_start = 0;
    while (exif_start < profile->length && profile->data[exif_start] != 'E') {
        exif_start++;
    }
    if (exif_start < profile->length && strncmp((const char*)profile->data + exif_start, "Exif", 4) == 0) {
        memmove(profile->data, profile->data + exif_start, profile->length - exif_start);
        profile->length -= exif_start;
    }
}