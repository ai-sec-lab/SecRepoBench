{
	int rc;
#ifdef USE_C_LOCALE
	locale_t old_lc;

	assert(regex->c_lc_ctype != NULL);

	/* Switch to the C locale for execution */
	old_lc = uselocale(regex->c_lc_ctype);

	/* Execute the regex */
	rc = regexec(&regex->rx, str, nmatch, pmatch, eflags);

	/* Restore previous locale */
	uselocale(old_lc);
#else
	/*
	 * setlocale(LC_CTYPE, "C") returns a pointer to the previous
	 * locale; use that to restore when we're done.
	 */
	char *old_lc = setlocale(LC_CTYPE, "C");

	rc = regexec(&regex->rx, str, nmatch, pmatch, eflags);

	(void)setlocale(LC_CTYPE, old_lc);
#endif
	return regex->rc = rc;
}