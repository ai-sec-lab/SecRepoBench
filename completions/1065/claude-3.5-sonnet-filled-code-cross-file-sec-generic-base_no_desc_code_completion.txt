#ifdef USE_C_LOCALE
    rx->c_lc_ctype = newlocale(LC_CTYPE_MASK, "C", 0);
    if (rx->c_lc_ctype == NULL) {
        return -1;
    }
    rx->old_lc_ctype = uselocale(rx->c_lc_ctype);
    if (rx->old_lc_ctype == NULL) {
        freelocale(rx->c_lc_ctype);
        return -1;
    }
#else
    rx->old_lc_ctype = setlocale(LC_CTYPE, "C");
    if (rx->old_lc_ctype == NULL) {
        return -1;
    }
#endif

    int result = regexec(&rx->rx, str, nmatch, pmatch, eflags);

#ifdef USE_C_LOCALE
    (void)uselocale(rx->old_lc_ctype);
    freelocale(rx->c_lc_ctype);
#else
    (void)setlocale(LC_CTYPE, rx->old_lc_ctype);
#endif

    return result;