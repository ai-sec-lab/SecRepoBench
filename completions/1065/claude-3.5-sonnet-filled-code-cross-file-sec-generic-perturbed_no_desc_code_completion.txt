#ifdef USE_C_LOCALE
    regex->c_lc_ctype = newlocale(LC_CTYPE_MASK, "C", 0);
    if (regex->c_lc_ctype == NULL) {
        return -1;
    }
    regex->old_lc_ctype = uselocale(regex->c_lc_ctype);
    if (regex->old_lc_ctype == NULL) {
        freelocale(regex->c_lc_ctype);
        return -1;
    }
#else
    regex->old_lc_ctype = setlocale(LC_CTYPE, "C");
    if (regex->old_lc_ctype == NULL) {
        return -1;
    }
#endif

    int result = regexec(&regex->rx, str, nmatch, pmatch, eflags);

#ifdef USE_C_LOCALE
    (void)uselocale(regex->old_lc_ctype);
    freelocale(regex->c_lc_ctype);
#else
    (void)setlocale(LC_CTYPE, regex->old_lc_ctype);
#endif

    return result;