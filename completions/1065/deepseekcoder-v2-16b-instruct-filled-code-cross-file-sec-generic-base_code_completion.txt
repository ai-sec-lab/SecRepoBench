#include <regex.h>
#include <stdlib.h>
#include <string.h>
#include <locale.h>
#include <assert.h>

// Define the structure for file_regex_t
typedef struct {
    regex_t rx;
    int rc;
    locale_t c_lc_ctype;
    locale_t old_lc_ctype;
    const char *pat;
} file_regex_t;

// Define the structure for file_pushbuf_t
typedef struct {
    char *buf;
    size_t offset;
} file_pushbuf_t;

// Define the structure for magic_set
struct magic_set {
    int flags;
    struct {
        char *buf;
    } o;
    size_t offset;
    int event_flags;
};

// Define the structure for magic
struct magic {
    char apple[9];
    char ext[256];
    char mimetype[256];
};

// Function to compile the regular expression
protected int
file_regcomp(file_regex_t *rx, const char *pat, int flags)
{
#ifdef USE_C_LOCALE
    rx->c_lc_ctype = newlocale(LC_CTYPE_MASK, "C", 0);
    assert(rx->c_lc_ctype != NULL);
    rx->old_lc_ctype = uselocale(rx->c_lc_ctype);
    assert(rx->old_lc_ctype != NULL);
#else
    rx->old_lc_ctype = setlocale(LC_CTYPE, "C");
#endif
    rx->pat = pat;

    return rx->rc = regcomp(&rx->rx, pat, flags);
}

// Function to execute the compiled regular expression
protected int
file_regexec(file_regex_t *rx, const char *str, size_t nmatch,
    regmatch_t* pmatch, int eflags)
{
    // Execute the compiled regular expression against the given string.
    // Ensure that the regex compilation was successful with an assertion.
    // The result is stored in pmatch, up to nmatch entries, with execution flags
    // specified by eflags. Return the result of regexec function call.
    return regexec(&rx->rx, str, nmatch, pmatch, eflags);
}

// Function to free the compiled regular expression
protected void
file_regfree(file_regex_t *rx)
{
    if (rx->rc == 0)
        regfree(&rx->rx);
#ifdef USE_C_LOCALE
    (void)uselocale(rx->old_lc_ctype);
    freelocale(rx->c_lc_ctype);
#else
    (void)setlocale(LC_CTYPE, rx->old_lc_ctype);
#endif
}

// Function to push a buffer
protected file_pushbuf_t *
file_push_buffer(struct magic_set *ms)
{
    file_pushbuf_t *pb;

    if (ms->event_flags & EVENT_HAD_ERR)
        return NULL;

    if ((pb = (CAST(file_pushbuf_t *, malloc(sizeof(*pb))))) == NULL)
        return NULL;

    pb->buf = ms->o.buf;
    pb->offset = ms->offset;

    ms->o.buf = NULL;
    ms->offset = 0;

    return pb;
}

// Function to handle annotations
private int
handle_annotation(struct magic_set *ms, struct magic *m, int firstline)
{
    if ((ms->flags & MAGIC_APPLE) && m->apple[0]) {
        if (!firstline && file_printf(ms, "\n- ") == -1)
            return -1;
        if (file_printf(ms, "%.8s", m->apple) == -1)
            return -1;
        return 1;
    }
    if ((ms->flags & MAGIC_EXTENSION) && m->ext[0]) {
        if (!firstline && file_printf(ms, "\n- ") == -1)
            return -1;
        if (file_printf(ms, "%s", m->ext) == -1)
            return -1;
        return 1;
    }
    if ((ms->flags & MAGIC_MIME_TYPE) && m->mimetype[0]) {
        if (!firstline && file_printf(ms, "\n- ") == -1)
            return -1;
        if (file_printf(ms, "%s", m->mimetype) == -1)
            return -1;
        return 1;
    }
    return 0;
}