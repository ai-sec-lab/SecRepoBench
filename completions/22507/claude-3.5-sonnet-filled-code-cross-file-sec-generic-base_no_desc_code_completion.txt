mrb_value val = GETARG();
double fval;
char fbuf[32];
int need;

if (mrb_float_p(val)) {
  fval = mrb_float(val);
}
else {
  fval = (double)mrb_fixnum(mrb_Float(mrb, val));
}

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }
  need = (int)strlen(expr);
  if (need > width) width = need;
  if (width > 0) {
    CHECK(width);
    sprintf(&buf[blen], "%*s", width, expr);
    blen += width;
  }
  break;
}