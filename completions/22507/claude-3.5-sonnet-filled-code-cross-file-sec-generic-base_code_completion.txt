mrb_value val = GETARG();
mrb_float fval;
char fbuf[32];
mrb_int need;

fval = mrb_to_flo(mrb, val);

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int sign = 1;
  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    if (fval < 0) {
      sign = -1;
      fval = -fval;
    }
    expr = "Inf";
  }
  need = (int)strlen(expr) + (sign < 0 ? 1 : 0);
  if (flags & (FPLUS|FSPACE))
    need++;
  if ((flags & FWIDTH) && need < width)
    need = width;

  CHECK(need);
  if (flags & FMINUS) {
    if (sign < 0)
      buf[blen++] = '-';
    else if (flags & FPLUS)
      buf[blen++] = '+';
    else if (flags & FSPACE)
      buf[blen++] = ' ';
    strcpy(&buf[blen], expr);
    blen += (int)strlen(expr);
    if (need > blen)
      FILL(' ', need - blen);
  }
  else {
    if (need > blen)
      FILL(' ', need - blen);
    if (sign < 0)
      buf[blen++] = '-';
    else if (flags & FPLUS)
      buf[blen++] = '+';
    else if (flags & FSPACE)
      buf[blen++] = ' ';
    strcpy(&buf[blen], expr);
    blen += (int)strlen(expr);
  }
}
else {