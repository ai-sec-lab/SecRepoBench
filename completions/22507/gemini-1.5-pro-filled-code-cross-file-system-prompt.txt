mrb_value val = GETARG();
        mrb_float fval;
        char fbuf[32];
        int need;
        char *buf = RSTRING_PTR(result);

        if (!mrb_float_p(val)) {
          val = mrb_Float(mrb, val);
        }
        fval = mrb_float(val);
        if (!isfinite(fval)) {
          const char *expr = (fval > 0.0) ? "Inf" : "NaN";
          int len = strlen(expr);
          char sign = 0;
          if (fval > 0.0 && flags & (FPLUS | FSPACE)) {
            sign = (flags & FPLUS) ? '+' : ' ';
            len++;
          }
          if ((flags & FWIDTH) && width > len) {
            len = width;
          }
          CHECK(len);
          if (sign) {
            if (flags & FMINUS) {
              buf[blen++] = sign;
              memcpy(buf + blen, expr, strlen(expr));
              blen += strlen(expr);
              FILL(' ', len - strlen(expr) - 1);
            }
            else {
              FILL(' ', len - strlen(expr) - 1);
              buf[blen++] = sign;
              memcpy(buf + blen, expr, strlen(expr));
              blen += strlen(expr);
            }
          }
          else {
            if (flags & FMINUS) {
              memcpy(buf + blen, expr, strlen(expr));
              blen += strlen(expr);
              FILL(' ', len - strlen(expr));
            }
            else {
              FILL(' ', len - strlen(expr));
              memcpy(buf + blen, expr, strlen(expr));
              blen += strlen(expr);
            }
          }
          break;
        }