mrb_value val = GETARG();
mrb_float floatvalue;
char fbuf[32];
mrb_int need;

floatvalue = mrb_to_flo(mrb, val);

if (isnan(floatvalue) || isinf(floatvalue)) {
  const char *expr;
  int sign = 1;
  if (isnan(floatvalue)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
    if (floatvalue < 0) sign = -1;
  }
  need = (int)strlen(expr);
  if ((flags & FPLUS) && sign > 0) need++;
  if ((flags & FSPACE) && sign > 0) need++;
  if (width > need) need = width;

  CHECK(need);
  if (flags & FMINUS) {
    if (sign < 0) PUSH("-", 1);
    else if (flags & FPLUS) PUSH("+", 1);
    else if (flags & FSPACE) PUSH(" ", 1);
    PUSH(expr, (int)strlen(expr));
    if (need > blen) FILL(' ', need - blen);
  }
  else {
    if (need > blen) FILL(' ', need - blen);
    if (sign < 0) PUSH("-", 1);
    else if (flags & FPLUS) PUSH("+", 1);
    else if (flags & FSPACE) PUSH(" ", 1);
    PUSH(expr, (int)strlen(expr));
  }
}
else {