mrb_value val = GETARG();
mrb_float fval;

if (!mrb_float_p(val)) {
  val = mrb_to_flo(mrb, val);
  if (!mrb_float_p(val))
    mrb_raise(mrb, E_TYPE_ERROR, "non float value");
}
fval = mrb_float(val);

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need = 3;

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }
  if (flags & FPLUS) {
    need++;
  }
  else if (flags & FSPACE) {
    need++;
  }
  if ((flags & FWIDTH) && need < width) need = width;

  CHECK(need);
  if (flags & FMINUS) {
    if (flags & FPLUS) {
      buf[blen++] = '+';
    }
    else if (flags & FSPACE) {
      buf[blen++] = ' ';
    }
    memcpy(&buf[blen], expr, 3);
    blen += 3;
    if (flags & FWIDTH) {
      FILL(' ', width - need + 3);
    }
  }
  else {
    if (flags & FWIDTH) {
      FILL(' ', width - need + 3);
    }
    if (flags & FPLUS) {
      buf[blen++] = '+';
    }
    else if (flags & FSPACE) {
      buf[blen++] = ' ';
    }
    memcpy(&buf[blen], expr, 3);
    blen += 3;
  }
}
else {
  char fbuf[32];