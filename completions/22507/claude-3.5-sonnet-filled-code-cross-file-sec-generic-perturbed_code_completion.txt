mrb_value val = GETARG();
mrb_float fval;
char fbuf[32];
int need;

fval = mrb_to_flo(mrb, val);

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need;
  int width = 0;

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }
  need = (int)strlen(expr);
  if (fval > 0 && (flags & (FPLUS|FSPACE))) need++;
  if ((flags & FWIDTH) && need < width) {
    need = width;
  }

  CHECK(need + 1);
  n = 0;
  if (flags & FMINUS) {
    if (fval > 0 && (flags & FPLUS)) PUSH("+", 1);
    else if (fval > 0 && (flags & FSPACE)) PUSH(" ", 1);
    if (fval < 0) PUSH("-", 1);
    PUSH(expr, (int)strlen(expr));
    if (need > width) FILL(' ', need - width);
  }
  else {
    if (need > width) FILL(' ', need - width);
    if (fval > 0 && (flags & FPLUS)) PUSH("+", 1);
    else if (fval > 0 && (flags & FSPACE)) PUSH(" ", 1);
    if (fval < 0) PUSH("-", 1);
    PUSH(expr, (int)strlen(expr));
  }
}
else {