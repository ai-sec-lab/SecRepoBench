mrb_value val = GETARG();
mrb_float fval;

if (mrb_float_p(val)) {
  fval = mrb_float(val);
} else {
  fval = mrb_to_flo(mrb, val);
}

if (!isfinite(fval)) {
  const char *expr;
  int need = 3;

  if (isnan(fval)) {
    expr = "NaN";
  } else {
    expr = "Inf";
  }

  if (flags & FPLUS) {
    sc = '+';
    need++;
  } else if (flags & FSPACE) {
    sc = ' ';
    need++;
  } else {
    sc = 0;
  }

  if (signbit(fval)) {
    sc = '-';
    need++;
  }

  if (width > need) {
    need = width;
  }

  CHECK(need);

  if (width > need) {
    FILL(' ', width - need);
  }

  if (sc) {
    PUSH(&sc, 1);
  }

  PUSH(expr, strlen(expr));
  break;
}

char fbuf[32];