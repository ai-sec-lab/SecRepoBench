mrb_float fval;
        char fbuf[24];
        int need;
        char *buf = RSTRING_PTR(result);

        fval = mrb_float(GETARG());
        if (!isfinite(fval)) {
          const char *expr;
          if (isnan(fval)) {
            expr = "NaN";
          }
          else {
            expr = "Inf";
          }
          /* Infinity or NaN */
          if ((flags & FPLUS) || (flags & FSPACE)) {
            CHECK(1);
            buf[blen++] = (flags & FPLUS) ? '+' : ' ';
          }
          CHECK(strlen(expr));
          memcpy(&buf[blen], expr, strlen(expr));
          blen += strlen(expr);
          break;
        }