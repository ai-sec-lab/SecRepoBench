mrb_value val = GETARG();
mrb_float fval;
char fbuf[32];
int need;

fval = mrb_to_flo(mrb, val);

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need;
  int width;

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }
  need = (int)strlen(expr);
  width = need;
  if (fval > 0 && (flags & (FPLUS|FSPACE))) {
    width++;
  }
  if ((flags & FWIDTH) && width < prec) {
    width = prec;
  }
  if ((flags & FWIDTH) && width < this->width) {
    width = this->width;
  }

  CHECK(width);
  if ((!isnan(fval) && fval > 0) && (flags & (FPLUS|FSPACE))) {
    PUSH((flags & FPLUS) ? "+" : " ", 1);
  }
  if ((flags & FMINUS) && (flags & FWIDTH)) {
    PUSH(expr, need);
    FILL(' ', width - need);
  }
  else {
    FILL(' ', width - need);
    PUSH(expr, need);
  }
  break;
}