mrb_value val = GETARG();
mrb_float fval;

fval = mrb_to_flo(mrb, val);
if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need;
  char sign = '\0';

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }
  need = (int)strlen(expr);
  if (!isnan(fval) && fval < 0.0)
    sign = '-';
  else if (flags & (FPLUS|FSPACE))
    sign = (flags & FPLUS) ? '+' : ' ';
  if (sign)
    need++;
  if ((flags & FWIDTH) && need < width)
    need = width;

  CHECK(need + 1);
  snprintf(&buf[blen], need + 1, "%*s%s%s",
           (flags & FMINUS) ? 0 : (int)(need - strlen(expr) - (sign ? 1 : 0)),
           "",
           sign ? &sign : "",
           expr);
  blen += strlen(&buf[blen]);
  break;
}

char fbuf[32];
int need;