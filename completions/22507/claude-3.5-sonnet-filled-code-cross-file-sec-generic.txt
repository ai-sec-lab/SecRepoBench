mrb_value val = GETARG();
mrb_float fval;
char fbuf[32];
int need;

fval = mrb_to_flo(mrb, val);

if (isnan(fval) || isinf(fval)) {
  const char *expr;
  int need;
  int width = 0;

  if (isnan(fval)) {
    expr = "NaN";
  }
  else {
    expr = "Inf";
  }
  need = (int)strlen(expr);
  if (fval > 0 && (flags & (FPLUS|FSPACE))) need++;
  if ((flags & FWIDTH) && need < width) {
    need = width;
  }

  CHECK(need + 1);
  n = snprintf(&buf[blen], need + 1, "%*s", need, "");
  if (flags & (FPLUS|FSPACE)) {
    buf[blen++] = (flags & FPLUS) ? '+' : ' ';
  }
  memcpy(&buf[blen], expr, strlen(expr));
  blen += strlen(expr);
}
else {