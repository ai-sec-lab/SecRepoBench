if (s->codec_id == AV_CODEC_ID_H264 || s->codec_id == AV_CODEC_ID_MPEG2VIDEO ||
    s->codec_id == AV_CODEC_ID_MPEG4) {
    // Ensure width and height are multiples of 2 for these codecs
    *width = FFALIGN(*width, 2);
    *height = FFALIGN(*height, 2);
}

// Align width and height to the calculated alignment values
*width = FFALIGN(*width, w_align);
*height = FFALIGN(*height, h_align);

// Ensure width and height don't exceed maximum allowed values
if (s->codec_id == AV_CODEC_ID_JPEG2000) {
    *width = FFMIN(*width, 65535);
    *height = FFMIN(*height, 65535);
} else {
    *width = FFMIN(*width, INT_MAX & ~(w_align - 1));
    *height = FFMIN(*height, INT_MAX & ~(h_align - 1));
}

// Handle special cases for certain codecs
if (s->codec_id == AV_CODEC_ID_WMV2 || s->codec_id == AV_CODEC_ID_WMV3 ||
    s->codec_id == AV_CODEC_ID_VC1) {
    *width = FFALIGN(*width, 4);
    *height = FFALIGN(*height, 4);
}