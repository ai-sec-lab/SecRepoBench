*width  = FFALIGN(*width, w_align);
*height = FFALIGN(*height, h_align);

if (s->codec_id == AV_CODEC_ID_H264 || s->lowres ||
    s->codec_id == AV_CODEC_ID_MPEG1VIDEO ||
    s->codec_id == AV_CODEC_ID_MPEG2VIDEO ||
    s->codec_id == AV_CODEC_ID_VC1 ||
    s->codec_id == AV_CODEC_ID_RV30 ||
    s->codec_id == AV_CODEC_ID_RV40) {
    *height += 2; // some of these codecs need additional space for decoding
}

if (s->codec_id == AV_CODEC_ID_H264 || s->lowres) {
    // H.264 has special out-of-bound reads, ensure a minimum size to avoid crashes
    *width = FFMAX(*width, 32);
}