MagickBooleanType
    status;

  register ssize_t
    i;

  size_t
    columns,
    rows;

  ssize_t
    count,
    page;

  unsigned char
    hex_map[256];

  /*
    Open image file.
  */
  assert(image_info != (ImageInfo *) NULL);
  assert(image_info->signature == MagickCoreSignature);
  if (image_info->debug != MagickFalse)
    (void) LogMagickEvent(TraceEvent,GetMagickModule(),"%s",
      image_info->filename);
  assert(exception != (ExceptionInfo *) NULL);
  status=OpenBlob(image_info,image,ReadBinaryBlobMode,exception);
  if (status == MagickFalse)
    return((Image *) NULL);
  /*
    Create Ghostscript control file.
  */
  file=AcquireUniqueFileResource(postscript_filename);
  if (file == -1)
    ThrowReaderException(FileOpenError,"UnableToCreateTemporaryFile");
  image=DestroyImageList(image);
  page=1;
  columns=0;
  rows=0;
  (void) memset(hex_map,0,sizeof(hex_map));
  hex_map['0']=0;
  hex_map['1']=1;
  hex_map['2']=2;
  hex_map['3']=3;
  hex_map['4']=4;
  hex_map['5']=5;
  hex_map['6']=6;
  hex_map['7']=7;
  hex_map['8']=8;
  hex_map['9']=9;
  hex_map['a']=10;
  hex_map['b']=11;
  hex_map['c']=12;
  hex_map['d']=13;
  hex_map['e']=14;
  hex_map['f']=15;
  hex_map['A']=10;
  hex_map['B']=11;
  hex_map['C']=12;
  hex_map['D']=13;
  hex_map['E']=14;
  hex_map['F']=15;
  options=AcquireString("");

  density=AcquireString(image_info->density);
  if (density != (char *) NULL)
    {
      if (IsGeometry(density) == MagickFalse)
        {
          density=DestroyString(density);
          density=(char *) NULL;
        }
    }
  if (density == (char *) NULL)
    density=AcquireString("72");

  (void) FormatLocaleString(geometry,MagickPathExtent,"%gx%g",
    image_info->resolution.x,image_info->resolution.y);
  SetGeometry(image,&geometry_info);
  SetGeometryInfo(&geometry_info);

  /*
    Set the page density.
  */
  (void) WriteBlobString(file,"%!PS-Adobe-3.0\n");
  if (image_info->page != (char *) NULL)
    {
      char
        *token;

      token=AcquireString(image_info->page);
      if (token != (char *) NULL)
        {
          (void) WriteBlobString(file,"<< /PageSize [");
          (void) WriteBlobString(file,token);
          (void) WriteBlobString(file,"] >> setpagedevice\n");
          token=DestroyString(token);
        }
    }
  else
    {
      if ((geometry_info.width != 0) && (geometry_info.height != 0))
        (void) FormatLocaleString(command,MagickPathExtent,
          "<< /PageSize [%g %g] >> setpagedevice\n",geometry_info.width,
          geometry_info.height);
      (void) WriteBlobString(file,command);
    }
  (void) FormatLocaleString(command,MagickPathExtent,"/Resolution %s def\n",
    density);
  (void) WriteBlobString(file,command);
  density=DestroyString(density);

  /*
    Set image resolution.
  */
  (void) FormatLocaleString(command,MagickPathExtent,
    "%g %g scale\n",image_info->resolution.x,image_info->resolution.y);
  (void) WriteBlobString(file,command);
  /*
    Copy Postscript to temporary file.
  */
  read_info=CloneImageInfo(image_info);
  (void) CopyMagickString(read_info->magick,"PS",MagickPathExtent);
  SetImageInfoFile(read_info,stdin);
  postscript_image=AllocateImage(read_info);
  read_info=DestroyImageInfo(read_info);
  if (postscript_image == (Image *) NULL)
    {
      (void) RelinquishUniqueFileResource(postscript_filename);
      ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
    }
  for (count=ReadBlob(image,MagickPathExtent,message); count != 0;
       count=ReadBlob(image,MagickPathExtent,message))
  {
    for (i=0; i < (ssize_t) count; i++)
    {
      if (EOFBlob(image) != MagickFalse)
        break;
      (void) WriteBlobByte(file,message[i]);
    }
    if (i < (ssize_t) count)
      break;
  }
  (void) CloseBlob(image);
  (void) WriteBlobString(file,"showpage\n");
  (void) RelinquishUniqueFileResource(postscript_filename);
  /*
    Delegate temporary control file to Ghostscript.
  */
  delegate_info=GetDelegateInfo("ps:decode",(char *) NULL,exception);
  if (delegate_info == (const DelegateInfo *) NULL)
    {
      (void) RelinquishUniqueFileResource(postscript_filename);
      ThrowReaderException(DelegateError,"PostscriptDelegateNotFound");
    }
  (void) CopyMagickString(filename,image_info->filename,MagickPathExtent);
  (void) FormatLocaleString(input_filename,MagickPathExtent,"ps:%s",
    postscript_filename);
  status=InvokeDelegate(image_info,postscript_image,delegate_info->decode,
    input_filename,exception);
  (void) RelinquishUniqueFileResource(postscript_filename);
  if (status == MagickFalse)
    return((Image *) NULL);
  image=postscript_image;