while (unlikely (iterator->has_next ()))
  {
    hb_codepoint_t current_gid = (*iterator).first;
    unsigned current_klass = (*iterator).second;

    if (unlikely (current_gid!= prev_gid || current_klass!= prev_klass))
      {
        // Finalize the current range record by setting its last glyph ID.
        range_rec.last = prev_gid;
        auto *range_rec_copy = c->copy (range_rec);
        if (unlikely (!range_rec_copy)) return_trace (false);
        c->add (range_rec_copy);

        // Create a new range record for the new pair.
        range_rec.first = current_gid;
        range_rec.last = current_gid;
        range_rec.value = current_klass;

        // Update previous glyph ID and class values for the next iteration.
        prev_gid = current_gid;
        prev_klass = current_klass;
      }
    else
      {
        // If the current pair is a continuation of the current range, update the last glyph ID of the range record.
        range_rec.last = current_gid;
      }

    // Increment the range record length to reflect the number of ranges processed.
    num_ranges++;
  }

  // Finalize the last range record by setting its last glyph ID.
  range_rec.last = prev_gid;
  auto *range_rec_copy = c->copy (range_rec);
  if (unlikely (!range_rec_copy)) return_trace (false);
  c->add (range_rec_copy);

  // Update the range record length to reflect the number of ranges processed.
  range_record.len = num_ranges;

  // Sort the range records to handle any unsorted glyph order.
  c->sort_range_records ();

  return_trace (true);