for (; iterator.hasNext(); ++iterator) {
      hb_codepoint_t gid = (*iterator).first;
      unsigned klass = (*iterator).second;

      if (gid != prev_gid + 1 || klass != prev_klass) {
        range_rec.last = prev_gid;
        record->last = prev_gid;
        c->append (record);

        range_rec.first = gid;
        range_rec.last = gid;
        range_rec.value = klass;
        record = c->copy (range_rec);
        if (unlikely (!record)) return_trace (false);

        prev_gid = gid;
        prev_klass = klass;
        num_ranges++;
      } else {
        range_rec.last = gid;
        record->last = gid;
        prev_gid = gid;
      }
    }

    range_rec.last = prev_gid;
    record->last = prev_gid;
    c->append (record);

    rangeRecord.len = num_ranges;
    std::sort (c->begin (), c->end ());