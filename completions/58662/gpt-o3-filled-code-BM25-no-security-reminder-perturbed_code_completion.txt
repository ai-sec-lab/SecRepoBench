/* ClassDefFormat2 */
    classFormat = 2;

    RangeRecord<Types> *cur_range = record;

    ++iterator;
    for (; iterator; ++iterator)
    {
      hb_codepoint_t gid   = (*iterator).first;
      unsigned       klass = (*iterator).second;

      /* If this glyph continues the current range, just extend it. */
      if (gid == prev_gid + 1 && klass == prev_klass)
      {
        prev_gid = gid;
        cur_range->last = gid;
        continue;
      }

      /* Otherwise, finish current range and start a new one. */
      cur_range->last = prev_gid;

      RangeRecord<Types> new_range;
      new_range.first = gid;
      new_range.last  = gid;
      new_range.value = klass;

      cur_range = c->copy (new_range);
      if (unlikely (!cur_range)) return_trace (false);

      prev_gid   = gid;
      prev_klass = klass;
      num_ranges++;
    }

    /* Finalize the last range record. */
    cur_range->last = prev_gid;

    /* Record the number of ranges emitted. */
    rangeRecord.len = num_ranges;

    return_trace (true);